<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Cockpit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        /*
         * COMMAND COCKPIT v2.2
         * Design: Zero Principles + Feng Shui
         *
         * Five Elements Layout:
         *   Fire   (top)    — Operations Hub
         *   Earth  (center) — Tasks + Calendar + Widgets
         *   Water  (middle) — Communications
         *   Metal  (lower)  — Bookmarks
         *   Wood   (base)   — Footer
         */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --fire: #FF6A00;
            --fire-bright: #FF8C00;
            --fire-deep: #E55A00;
            --ember: rgba(255, 106, 0, 0.12);
            --ember-glow: rgba(255, 106, 0, 0.2);
            --ember-border: rgba(255, 106, 0, 0.35);
            --void: transparent;
            --void-soft: rgba(255, 255, 255, 0.6);
            --void-lift: rgba(255, 255, 255, 0.65);
            --void-card: rgba(255, 255, 255, 0.7);
            --clarity: #000000;
            --clarity-soft: #111111;
            --clarity-muted: #222222;
            --clarity-dim: #444444;
            --green: #32CD32;
            --green-dim: rgba(50, 205, 50, 0.12);
            --red: #FF4444;
            --red-dim: rgba(255, 68, 68, 0.12);
            --yellow: #FFD700;
            --section-gap: 2.5rem;
            --card-radius: 16px;
            --card-padding: 1.75rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--clarity);
            line-height: 1.6;
            min-height: 100vh;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            padding-bottom: 56px;
        }

        .cockpit {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1.5rem 4rem;
            display: flex;
            flex-direction: column;
            gap: var(--section-gap);
        }

        /* === HEADER === */
        .header { text-align: center; padding: 3rem 2rem 2.5rem; }
        .header::after {
            content: ''; display: block; width: 120px; height: 3px;
            background: linear-gradient(90deg, transparent, var(--fire), transparent);
            margin: 2rem auto 0; border-radius: 2px;
        }
        .header h1 { font-size: 2.4rem; font-weight: 700; letter-spacing: 0.08em; color: var(--fire); }
        .header-sub { font-size: 0.95rem; color: var(--clarity-muted); margin-top: 0.5rem; font-weight: 300; letter-spacing: 0.04em; }
        .clock { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #000000; margin-top: 1rem; font-weight: 600; text-shadow: 0 0 8px rgba(255,140,0,0.4); }

        .section-label {
            font-size: 0.7rem; font-weight: 600; letter-spacing: 0.2em;
            text-transform: uppercase; color: var(--fire); margin-bottom: 1rem; padding-left: 0.25rem;
        }

        /* === RACE TRACK (Page Border) === */
        .racetrack-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        .racetrack-overlay svg {
            width: 100%;
            height: 100%;
        }

        /* === CARD === */
        .card {
            background: var(--void-soft); border: 1px solid var(--ember-border);
            border-radius: var(--card-radius); padding: var(--card-padding);
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .card:hover { border-color: var(--fire); box-shadow: 0 8px 32px rgba(255,106,0,0.2); transform: translateY(-2px); }
        .card-title { font-size: 1.15rem; font-weight: 600; color: var(--clarity); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.6rem; }
        .card-title .icon { font-size: 1.3rem; }
        .card-desc { font-size: 0.85rem; color: var(--clarity-muted); line-height: 1.7; }

        /* === OPS HUB === */
        .ops-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .ops-card { position: relative; overflow: hidden; }
        .ops-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--fire-deep), var(--fire-bright)); border-radius: var(--card-radius) var(--card-radius) 0 0; }
        .ops-status { display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.05em; padding: 0.3rem 0.7rem; border-radius: 20px; margin-top: 1rem; }
        .ops-status.connected { background: var(--green-dim); color: var(--green); border: 1px solid rgba(50,205,50,0.3); }
        .ops-status.setup { background: var(--ember); color: var(--fire); border: 1px solid var(--ember-border); }
        .ops-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        .ops-actions { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 1.25rem; }
        .ops-btn { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.55rem 1rem; border: 1px solid var(--ember-border); border-radius: 8px; background: var(--void-lift); color: var(--clarity-soft); font-family: 'Inter', sans-serif; font-size: 0.8rem; font-weight: 500; cursor: pointer; text-decoration: none; transition: all 0.2s; }
        .ops-btn:hover { border-color: var(--fire); background: var(--ember); color: var(--fire); }
        .ops-btn.primary { background: var(--fire); color: #fff; border-color: var(--fire); font-weight: 600; }
        .ops-btn.primary:hover { background: var(--fire-bright); box-shadow: 0 4px 16px rgba(255,140,0,0.3); }

        /* === WIDGET BASE === */
        .widgets-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem; }
        .widget { background: var(--void-soft); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 1.25rem; display: flex; flex-direction: column; transition: border-color 0.3s, box-shadow 0.3s; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .widget:hover { border-color: var(--ember-border); box-shadow: 0 4px 20px rgba(255,106,0,0.1); }
        .widget-head { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.9rem; font-size: 0.72rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--fire); }
        .widget-head .w-icon { font-size: 1rem; }
        .widget-head-right { margin-left: auto; display: flex; align-items: center; gap: 0.5rem; }
        .widget-span-2 { grid-column: span 2; }
        .widget-span-4 { grid-column: span 4; }

        /* =============================================
           TASKS WIDGET — Priority Point System
           ============================================= */
        .todo-input-row { display: flex; gap: 0.4rem; margin-bottom: 0.75rem; }

        .todo-input {
            flex: 1; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; padding: 0.5rem 0.75rem; color: var(--clarity);
            font-family: 'Inter', sans-serif; font-size: 0.82rem; outline: none;
        }
        .todo-input:focus { border-color: var(--fire); }
        .todo-input::placeholder { color: var(--clarity-dim); }

        .todo-priority-select {
            background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; padding: 0.5rem 0.5rem; color: var(--clarity);
            font-family: 'Inter', sans-serif; font-size: 0.78rem; outline: none;
            cursor: pointer; min-width: 110px;
        }
        .todo-priority-select:focus { border-color: var(--fire); }

        .todo-add-btn {
            background: var(--fire); border: none; border-radius: 6px;
            color: #fff; font-weight: 700; font-size: 1.1rem;
            width: 38px; cursor: pointer; transition: background 0.2s;
        }
        .todo-add-btn:hover { background: var(--fire-bright); }

        .todo-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; }

        .todo-column-label {
            font-size: 0.65rem; font-weight: 600; letter-spacing: 0.12em;
            text-transform: uppercase; color: var(--clarity-dim);
            margin-bottom: 0.5rem; padding-left: 0.2rem;
        }

        .todo-list { list-style: none; overflow-y: auto; max-height: 320px; }

        .todo-item {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 0.4rem; border-bottom: 1px solid rgba(255,255,255,0.04);
            font-size: 0.82rem; color: var(--clarity-muted); transition: background 0.1s;
        }
        .todo-item:hover { background: rgba(255,255,255,0.02); }
        .todo-item:last-child { border-bottom: none; }

        .todo-check {
            width: 16px; height: 16px; border: 1.5px solid var(--clarity-dim);
            border-radius: 3px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; flex-shrink: 0; font-size: 0.6rem;
            color: transparent; transition: all 0.15s;
        }
        .todo-item.done .todo-check { border-color: var(--green); background: var(--green-dim); color: var(--green); }
        .todo-item.done .todo-text { text-decoration: line-through; color: var(--clarity-dim); }

        .todo-text { flex: 1; line-height: 1.4; }

        .todo-pts {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem; font-weight: 600;
            padding: 0.15rem 0.45rem; border-radius: 4px;
            flex-shrink: 0; white-space: nowrap;
        }
        .todo-pts.p5 { background: rgba(255,68,68,0.15); color: var(--red); border: 1px solid rgba(255,68,68,0.3); }
        .todo-pts.p3 { background: rgba(255,140,0,0.15); color: var(--fire); border: 1px solid rgba(255,140,0,0.3); }
        .todo-pts.p2 { background: rgba(255,215,0,0.12); color: var(--yellow); border: 1px solid rgba(255,215,0,0.25); }
        .todo-pts.p1 { background: rgba(255,255,255,0.06); color: var(--clarity-dim); border: 1px solid rgba(255,255,255,0.1); }

        .todo-delete {
            background: none; border: none; color: var(--clarity-dim);
            cursor: pointer; font-size: 0.95rem; padding: 0 0.2rem;
            opacity: 0; transition: opacity 0.15s, color 0.15s;
        }
        .todo-item:hover .todo-delete { opacity: 1; }
        .todo-delete:hover { color: var(--red); }

        .todo-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 0.75rem; padding-top: 0.75rem;
            border-top: 1px solid rgba(255,255,255,0.06);
            font-size: 0.72rem; color: var(--clarity-dim);
        }

        .todo-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem; font-weight: 600; color: var(--fire);
        }

        .todo-clear {
            background: none; border: none; color: var(--clarity-dim);
            font-size: 0.7rem; cursor: pointer; text-decoration: underline;
        }
        .todo-clear:hover { color: var(--fire); }

        /* =============================================
           CALENDAR — Full Month View
           ============================================= */
        .cal-container { display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; }

        .cal-month-nav {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1rem;
        }

        .cal-nav-btn {
            background: none; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; color: var(--clarity-muted);
            font-size: 0.85rem; padding: 0.3rem 0.6rem; cursor: pointer;
            transition: all 0.2s;
        }
        .cal-nav-btn:hover { border-color: var(--fire); color: var(--fire); }

        .cal-month-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem; font-weight: 600; color: var(--clarity);
        }

        .cal-today-btn {
            background: none; border: 1px solid var(--ember-border);
            border-radius: 6px; color: var(--fire); font-size: 0.7rem;
            font-weight: 600; padding: 0.25rem 0.6rem; cursor: pointer;
            transition: all 0.2s;
        }
        .cal-today-btn:hover { background: var(--ember); }

        .cal-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .cal-dow {
            text-align: center; font-size: 0.65rem; font-weight: 600;
            letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--clarity-dim); padding: 0.5rem 0;
        }

        .cal-day {
            aspect-ratio: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding: 0.3rem; border-radius: 8px; cursor: pointer;
            transition: all 0.15s; position: relative;
            min-height: 48px;
        }
        .cal-day:hover { background: rgba(255,255,255,0.04); }

        .cal-day-num {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem; font-weight: 500; color: var(--clarity-muted);
            line-height: 1;
        }

        .cal-day.other-month .cal-day-num { color: rgba(255,255,255,0.15); }
        .cal-day.today { background: var(--ember); border: 1px solid var(--ember-border); }
        .cal-day.today .cal-day-num { color: var(--fire); font-weight: 700; }
        .cal-day.selected { background: rgba(255,140,0,0.2); border: 1px solid var(--fire); }
        .cal-day.selected .cal-day-num { color: var(--fire); font-weight: 700; }

        .cal-day-dots {
            display: flex; gap: 2px; margin-top: 3px; flex-wrap: wrap;
            justify-content: center;
        }

        .cal-dot {
            width: 5px; height: 5px; border-radius: 50%;
            background: var(--fire); flex-shrink: 0;
        }

        /* Calendar sidebar */
        .cal-sidebar {
            border-left: 1px solid rgba(255,255,255,0.06);
            padding-left: 1.5rem;
            display: flex; flex-direction: column;
        }

        .cal-sidebar-date {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem; font-weight: 600; color: var(--fire);
            margin-bottom: 0.75rem;
        }

        .cal-sidebar-events { list-style: none; flex: 1; overflow-y: auto; }

        .cal-sidebar-event {
            display: flex; align-items: flex-start; gap: 0.6rem;
            padding: 0.65rem 0.4rem;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            font-size: 0.8rem; color: var(--clarity-muted);
        }
        .cal-sidebar-event:last-child { border-bottom: none; }

        .cal-sidebar-time-col {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.68rem; color: var(--clarity-dim);
            min-width: 55px; flex-shrink: 0; padding-top: 2px;
        }

        .cal-sidebar-info { flex: 1; min-width: 0; }

        .cal-sidebar-title {
            font-size: 0.82rem; font-weight: 500; color: var(--clarity);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .cal-sidebar-crew {
            display: inline-flex; align-items: center; gap: 0.3rem;
            font-size: 0.68rem; color: var(--fire); margin-top: 0.2rem;
        }

        .cal-sidebar-crew-dot {
            width: 5px; height: 5px; border-radius: 50%;
            background: var(--fire); flex-shrink: 0;
        }

        .cal-sidebar-del {
            background: none; border: none; color: var(--clarity-dim);
            cursor: pointer; font-size: 0.85rem; opacity: 0; transition: opacity 0.15s;
            flex-shrink: 0; padding-top: 2px;
        }
        .cal-sidebar-event:hover .cal-sidebar-del { opacity: 1; }
        .cal-sidebar-del:hover { color: var(--red); }

        .cal-sidebar-empty {
            font-size: 0.78rem; color: var(--clarity-dim);
            font-style: italic; padding: 0.5rem 0;
        }

        .cal-add-form { margin-top: auto; padding-top: 0.75rem; display: flex; flex-direction: column; gap: 0.4rem; }
        .cal-add-row { display: flex; gap: 0.4rem; }

        .cal-input {
            flex: 1; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; padding: 0.4rem 0.6rem; color: var(--clarity);
            font-family: 'Inter', sans-serif; font-size: 0.75rem; outline: none;
        }
        .cal-input:focus { border-color: var(--fire); }
        .cal-input::placeholder { color: var(--clarity-dim); }

        .cal-add-btn {
            background: var(--fire); border: none; border-radius: 6px;
            color: #fff; font-weight: 600; font-size: 0.75rem;
            padding: 0.4rem 0.8rem; cursor: pointer;
        }
        .cal-add-btn:hover { background: var(--fire-bright); }

        /* === SMALL WIDGETS === */
        /* Weather */
        .weather-display { display: flex; align-items: center; gap: 1rem; }
        .weather-temp { font-family: 'JetBrains Mono', monospace; font-size: 2.2rem; font-weight: 600; color: var(--clarity); line-height: 1; }
        .weather-condition { font-size: 0.85rem; color: var(--clarity-soft); font-weight: 500; }
        .weather-details { font-size: 0.78rem; color: var(--clarity-muted); line-height: 1.6; }
        .weather-loading { font-size: 0.8rem; color: var(--clarity-dim); font-style: italic; }

        /* Service Status */
        .status-list { list-style: none; }
        .status-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 0.8rem; }
        .status-item:last-child { border-bottom: none; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .status-dot.up { background: var(--green); box-shadow: 0 0 6px rgba(50,205,50,0.5); }
        .status-dot.down { background: var(--red); box-shadow: 0 0 6px rgba(255,68,68,0.5); }
        .status-dot.checking { background: var(--clarity-dim); animation: pulse-dot 1.5s ease-in-out infinite; }
        .status-name { color: var(--clarity-muted); flex: 1; }
        .status-ms { font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; color: var(--clarity-dim); }
        .status-refresh { background: none; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--clarity-dim); font-size: 0.7rem; padding: 0.3rem 0.6rem; cursor: pointer; margin-top: 0.6rem; transition: all 0.2s; }
        .status-refresh:hover { border-color: var(--fire); color: var(--fire); }

        /* Insight Bar — compact, top of page */
        .insight-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 0.6rem; flex-wrap: wrap;
            padding: 0.6rem 1.25rem;
            background: var(--void-soft);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            text-align: center;
            margin-top: -1rem;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .insight-text {
            font-size: 0.78rem; color: var(--clarity-muted);
            font-style: italic; line-height: 1.5;
        }
        .insight-source {
            font-size: 0.65rem; color: var(--fire);
            font-weight: 500; white-space: nowrap;
        }
        .insight-refresh {
            background: none; border: none;
            color: var(--clarity-dim); font-size: 0.9rem;
            cursor: pointer; transition: color 0.2s;
            line-height: 1; padding: 0;
        }
        .insight-refresh:hover { color: var(--fire); }

        /* Calculator */
        .calc-display { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; color: var(--clarity); text-align: right; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 0.6rem 0.8rem; margin-bottom: 0.6rem; min-height: 2.5rem; overflow: hidden; word-break: break-all; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.35rem; }
        .calc-btn { background: var(--void-lift); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; color: var(--clarity); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; padding: 0.5rem; cursor: pointer; transition: all 0.15s; }
        .calc-btn:hover { border-color: var(--ember-border); background: var(--ember); }
        .calc-btn.op { color: var(--fire); font-weight: 600; }
        .calc-btn.eq { background: var(--fire); color: #fff; font-weight: 700; border-color: var(--fire); }
        .calc-btn.eq:hover { background: var(--fire-bright); }
        .calc-btn.clear { color: var(--red); }

        /* Notes */
        .notes-area { width: 100%; flex: 1; min-height: 140px; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 0.75rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.8rem; line-height: 1.6; resize: vertical; outline: none; transition: border-color 0.2s; }
        .notes-area:focus { border-color: var(--fire); }
        .notes-area::placeholder { color: var(--clarity-dim); }
        .notes-saved { font-size: 0.65rem; color: var(--clarity-dim); margin-top: 0.5rem; text-align: right; font-style: italic; min-height: 1em; }

        /* === MEMORY VAULT === */
        .mem-toolbar { display: flex; gap: 0.4rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .mem-search { flex: 1; min-width: 140px; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.5rem 0.75rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.82rem; outline: none; }
        .mem-search:focus { border-color: var(--fire); }
        .mem-search::placeholder { color: var(--clarity-dim); }
        .mem-cat-filter { background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.5rem 0.5rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.78rem; outline: none; cursor: pointer; min-width: 110px; }
        .mem-cat-filter:focus { border-color: var(--fire); }
        .mem-add-btn { background: var(--fire); border: none; border-radius: 6px; color: #fff; font-weight: 700; font-size: 1.1rem; width: 38px; cursor: pointer; transition: background 0.2s; }
        .mem-add-btn:hover { background: var(--fire-bright); }
        .mem-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 0.75rem; max-height: 400px; overflow-y: auto; }
        .mem-card { background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 0.9rem; position: relative; transition: border-color 0.2s, box-shadow 0.2s; cursor: pointer; }
        .mem-card:hover { border-color: var(--ember-border); box-shadow: 0 2px 12px rgba(255,106,0,0.1); }
        .mem-card.pinned { border-color: var(--fire); }
        .mem-card.pinned::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--fire); border-radius: 10px 10px 0 0; }
        .mem-card-cat { font-size: 0.58rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--fire); margin-bottom: 0.3rem; }
        .mem-card-title { font-size: 0.88rem; font-weight: 600; color: var(--clarity); margin-bottom: 0.3rem; line-height: 1.3; }
        .mem-card-content { font-size: 0.75rem; color: var(--clarity-muted); line-height: 1.5; white-space: pre-wrap; word-break: break-word; max-height: 80px; overflow: hidden; }
        .mem-card-time { font-size: 0.6rem; color: var(--clarity-dim); margin-top: 0.4rem; font-family: 'JetBrains Mono', monospace; }
        .mem-card-actions { position: absolute; top: 0.5rem; right: 0.5rem; display: flex; gap: 0.3rem; opacity: 0; transition: opacity 0.15s; }
        .mem-card:hover .mem-card-actions { opacity: 1; }
        .mem-card-btn { background: none; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--clarity-dim); font-size: 0.65rem; padding: 0.15rem 0.35rem; cursor: pointer; transition: all 0.15s; }
        .mem-card-btn:hover { border-color: var(--fire); color: var(--fire); }
        .mem-card-btn.del:hover { border-color: var(--red); color: var(--red); }
        .mem-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .mem-modal-overlay.active { display: flex; }
        .mem-modal { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border: 1px solid var(--ember-border); border-radius: 16px; padding: 1.5rem; width: 90%; max-width: 480px; }
        .mem-modal-title { font-size: 1rem; font-weight: 600; color: var(--clarity); margin-bottom: 1rem; }
        .mem-modal input, .mem-modal textarea, .mem-modal select { width: 100%; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.5rem 0.75rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.82rem; outline: none; margin-bottom: 0.6rem; }
        .mem-modal textarea { min-height: 100px; resize: vertical; line-height: 1.5; }
        .mem-modal input:focus, .mem-modal textarea:focus, .mem-modal select:focus { border-color: var(--fire); }
        .mem-modal-btns { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 0.5rem; }
        .mem-modal-btn { padding: 0.5rem 1.2rem; border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .mem-modal-btn.save { background: var(--fire); color: #fff; }
        .mem-modal-btn.save:hover { background: var(--fire-bright); }
        .mem-modal-btn.cancel { background: rgba(255,255,255,0.1); color: var(--clarity-muted); border: 1px solid rgba(255,255,255,0.1); }
        .mem-modal-btn.cancel:hover { border-color: var(--clarity-dim); }

        /* === COMMUNICATIONS HUB === */
        .comms-hub { display: grid; grid-template-columns: 220px 1fr; min-height: 420px; }
        .comms-channels { background: rgba(255,255,255,0.5); border-right: 1px solid rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        .comms-channels-head { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; color: var(--fire); padding: 1.25rem 1rem 0.75rem; }
        .comms-channel-list { flex: 1; overflow-y: auto; padding: 0 0.5rem; }
        .comms-ch-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.55rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.82rem; color: var(--clarity-muted); transition: all 0.15s; margin-bottom: 2px; }
        .comms-ch-item:hover { background: rgba(255,255,255,0.04); color: var(--clarity); }
        .comms-ch-item.active { background: var(--ember); color: var(--fire); font-weight: 600; }
        .comms-ch-icon { font-size: 0.9rem; flex-shrink: 0; }
        .comms-ch-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .comms-ch-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; font-weight: 700; background: var(--fire); color: #000; padding: 0.1rem 0.4rem; border-radius: 10px; min-width: 18px; text-align: center; }
        .comms-add-channel { padding: 0.75rem; border-top: 1px solid rgba(255,255,255,0.06); }
        .comms-add-input { width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; padding: 0.45rem 0.65rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.78rem; outline: none; }
        .comms-add-input:focus { border-color: var(--fire); }
        .comms-add-input::placeholder { color: var(--clarity-dim); }
        .comms-main { display: flex; flex-direction: column; }
        .comms-main-head { display: flex; align-items: center; gap: 0.75rem; padding: 0.9rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .comms-main-title { font-size: 0.95rem; font-weight: 600; color: var(--clarity); }
        .comms-main-count { font-size: 0.68rem; color: var(--clarity-dim); font-family: 'JetBrains Mono', monospace; }
        .comms-pin-btn, .comms-del-channel-btn { margin-left: auto; background: none; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--clarity-dim); font-size: 0.68rem; font-weight: 600; padding: 0.25rem 0.55rem; cursor: pointer; transition: all 0.2s; display: none; }
        .comms-del-channel-btn { margin-left: 0.4rem; }
        .comms-pin-btn:hover { border-color: var(--fire); color: var(--fire); }
        .comms-del-channel-btn:hover { border-color: var(--red); color: var(--red); }
        .comms-pinned { padding: 0; }
        .comms-pinned-msg { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1.25rem; background: rgba(255,106,0,0.08); border-bottom: 1px solid rgba(255,106,0,0.15); font-size: 0.78rem; color: var(--fire-bright); }
        .comms-pinned-label { font-size: 0.6rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; flex-shrink: 0; }
        .comms-pinned-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .comms-messages { flex: 1; overflow-y: auto; padding: 1rem 1.25rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .comms-empty { color: var(--clarity-dim); font-size: 0.82rem; font-style: italic; margin: auto; }
        .comms-msg { padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .comms-msg:last-child { border-bottom: none; }
        .comms-msg-head { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.2rem; }
        .comms-msg-sender { font-size: 0.78rem; font-weight: 600; color: var(--fire); }
        .comms-msg-time { font-family: 'JetBrains Mono', monospace; font-size: 0.62rem; color: var(--clarity-dim); }
        .comms-msg-text { font-size: 0.82rem; color: var(--clarity-muted); line-height: 1.5; }
        .comms-msg-actions { display: none; margin-left: auto; gap: 0.3rem; }
        .comms-msg:hover .comms-msg-actions { display: flex; }
        .comms-msg-act { background: none; border: none; color: var(--clarity-dim); font-size: 0.7rem; cursor: pointer; padding: 0.1rem 0.3rem; border-radius: 3px; }
        .comms-msg-act:hover { color: var(--fire); background: rgba(255,255,255,0.04); }
        .comms-msg-act.del:hover { color: var(--red); }
        .comms-compose { display: flex; gap: 0.5rem; padding: 0.75rem 1.25rem; border-top: 1px solid rgba(255,255,255,0.06); }
        .comms-compose-input { flex: 1; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.6rem 0.9rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.82rem; outline: none; }
        .comms-compose-input:focus { border-color: var(--fire); }
        .comms-compose-input::placeholder { color: var(--clarity-dim); }
        .comms-compose-send { padding: 0.6rem 1.1rem; background: var(--fire); border: none; border-radius: 8px; color: #fff; font-weight: 700; font-size: 0.82rem; cursor: pointer; transition: background 0.2s; }
        .comms-compose-send:hover { background: var(--fire-bright); }
        /* === CUSTOMER COMMS === */
        .comms-customer-section { border-top: 1px solid rgba(255,255,255,0.06); }
        .comms-customer-head { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; color: #2196F3; padding: 0.75rem 1rem 0.5rem; }
        .comms-ch-item.customer { border-left: 2px solid #2196F3; }
        .comms-ch-item.customer.active { background: rgba(33,150,243,0.12); color: #2196F3; border-left-color: #2196F3; }
        .comms-customer-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; font-weight: 700; background: rgba(33,150,243,0.15); color: #2196F3; padding: 0.05rem 0.35rem; border-radius: 8px; margin-left: auto; }
        /* === VOICE CHANNEL === */
        .voice-section { border-top: 1px solid rgba(255,255,255,0.06); }
        .voice-section-head { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; color: var(--green); padding: 0.75rem 1rem 0.5rem; }
        .voice-panel { padding: 0 0.75rem 0.75rem; }
        .voice-code-gen { text-align: center; margin-bottom: 0.5rem; }
        .voice-code-display { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--green); background: rgba(50,205,50,0.08); border: 1px dashed rgba(50,205,50,0.3); border-radius: 8px; padding: 0.6rem; letter-spacing: 0.15em; margin-bottom: 0.4rem; }
        .voice-gen-btn { width: 100%; padding: 0.4rem; background: rgba(50,205,50,0.12); border: 1px solid rgba(50,205,50,0.25); border-radius: 6px; color: var(--green); font-family: 'Inter', sans-serif; font-size: 0.72rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .voice-gen-btn:hover { background: rgba(50,205,50,0.2); border-color: rgba(50,205,50,0.4); }
        .voice-copy-code-btn { width: 100%; padding: 0.35rem; background: none; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--clarity-muted); font-family: 'Inter', sans-serif; font-size: 0.68rem; font-weight: 600; cursor: pointer; margin-top: 0.3rem; transition: all 0.2s; }
        .voice-copy-code-btn:hover { border-color: var(--green); color: var(--green); }
        .voice-btn { flex: 1; padding: 0.45rem 0; border: none; border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .voice-join { background: var(--green); color: #000; }
        .voice-join:hover { box-shadow: 0 0 12px rgba(50,205,50,0.3); }
        .voice-create { background: rgba(50,205,50,0.15); color: var(--green); border: 1px solid rgba(50,205,50,0.3); }
        .voice-create:hover { background: rgba(50,205,50,0.25); }
        .voice-room-info { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.5rem; }
        .voice-room-label { font-size: 0.65rem; color: var(--clarity-dim); font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; }
        .voice-room-code { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--green); background: rgba(50,205,50,0.1); padding: 0.15rem 0.5rem; border-radius: 4px; border: 1px solid rgba(50,205,50,0.2); }
        .voice-copy-btn { background: none; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--clarity-dim); font-size: 0.6rem; font-weight: 600; padding: 0.15rem 0.4rem; cursor: pointer; margin-left: auto; }
        .voice-copy-btn:hover { border-color: var(--green); color: var(--green); }
        .voice-status { font-size: 0.72rem; color: var(--clarity-dim); margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.4rem; }
        .voice-status::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px rgba(50,205,50,0.5); animation: pulse-dot 1.5s ease-in-out infinite; }
        .voice-status.connected::before { animation: none; }
        .voice-users { display: flex; flex-direction: column; gap: 0.25rem; margin-bottom: 0.5rem; }
        .voice-user { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: var(--clarity-muted); padding: 0.25rem 0.4rem; border-radius: 4px; }
        .voice-user-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
        .voice-user-dot.speaking { box-shadow: 0 0 8px rgba(50,205,50,0.6); animation: pulse-dot 0.6s ease-in-out infinite; }
        .voice-user-dot.muted { background: var(--clarity-dim); box-shadow: none; }
        .voice-user-name { flex: 1; font-size: 0.75rem; }
        .voice-user-tag { font-size: 0.58rem; color: var(--clarity-dim); font-family: 'JetBrains Mono', monospace; }
        .voice-controls { display: flex; gap: 0.4rem; margin-bottom: 0.5rem; }
        .voice-ctrl { flex: 1; padding: 0.4rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; background: rgba(255,255,255,0.04); color: var(--clarity-muted); font-family: 'Inter', sans-serif; font-size: 0.72rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .voice-ctrl:hover { border-color: var(--clarity-muted); color: var(--clarity); }
        .voice-ctrl.active { background: rgba(255,68,68,0.15); border-color: rgba(255,68,68,0.3); color: var(--red); }
        .voice-leave { background: rgba(255,68,68,0.1); border-color: rgba(255,68,68,0.25); color: var(--red); }
        .voice-leave:hover { background: rgba(255,68,68,0.2); }
        .voice-videos { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.5rem; }
        .voice-video { width: 100%; max-height: 160px; border-radius: 8px; background: #000; object-fit: cover; border: 1px solid rgba(50,205,50,0.25); }
        .voice-remote-video { width: 48%; max-height: 120px; border-radius: 8px; background: #000; object-fit: cover; border: 1px solid rgba(255,106,0,0.3); }
        .voice-screen-video { width: 100%; max-height: 200px; border-radius: 8px; background: #000; object-fit: contain; border: 2px solid var(--fire); }
        .voice-visualizer { border-radius: 6px; overflow: hidden; background: rgba(0,0,0,0.3); }
        .voice-visualizer canvas { display: block; width: 100%; height: 30px; }
        @media (max-width: 768px) { .comms-hub { grid-template-columns: 1fr; } .comms-channels { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.06); max-height: none; } }

        /* === GOOGLE DRIVE === */
        .drive-toolbar { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; align-items: center; flex-wrap: wrap; }
        .drive-breadcrumb { display: flex; align-items: center; gap: 0.3rem; flex: 1; min-width: 0; overflow-x: auto; }
        .drive-crumb { font-size: 0.78rem; font-weight: 600; color: var(--fire); cursor: pointer; white-space: nowrap; background: none; border: none; font-family: 'Inter', sans-serif; padding: 0.2rem 0.4rem; border-radius: 4px; transition: background 0.15s; }
        .drive-crumb:hover { background: var(--ember); }
        .drive-crumb-sep { font-size: 0.7rem; color: var(--clarity-dim); }
        .drive-action-btn { padding: 0.4rem 0.8rem; border: 1px solid var(--ember-border); border-radius: 6px; background: var(--void-lift); color: var(--clarity-soft); font-family: 'Inter', sans-serif; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .drive-action-btn:hover { border-color: var(--fire); color: var(--fire); background: var(--ember); }
        .drive-action-btn.primary { background: var(--fire); color: #fff; border-color: var(--fire); }
        .drive-action-btn.primary:hover { background: var(--fire-bright); }
        .drive-list { max-height: 360px; overflow-y: auto; }
        .drive-row { display: flex; align-items: center; gap: 0.6rem; padding: 0.6rem 0.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); transition: background 0.1s; cursor: pointer; border-radius: 6px; }
        .drive-row:hover { background: var(--ember); }
        .drive-row:last-child { border-bottom: none; }
        .drive-row-icon { font-size: 1.2rem; flex-shrink: 0; width: 28px; text-align: center; }
        .drive-row-name { flex: 1; font-size: 0.82rem; font-weight: 500; color: var(--clarity); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .drive-row-size { font-size: 0.68rem; color: var(--clarity-dim); font-family: 'JetBrains Mono', monospace; white-space: nowrap; }
        .drive-row-open { font-size: 0.65rem; font-weight: 600; color: var(--fire); background: none; border: 1px solid var(--ember-border); border-radius: 4px; padding: 0.2rem 0.5rem; cursor: pointer; opacity: 0; transition: opacity 0.15s, border-color 0.15s; white-space: nowrap; }
        .drive-row:hover .drive-row-open { opacity: 1; }
        .drive-row-open:hover { border-color: var(--fire); }
        .drive-empty { text-align: center; padding: 2rem; color: var(--clarity-dim); font-size: 0.82rem; }
        .drive-synced { font-size: 0.6rem; color: var(--clarity-dim); margin-top: 0.5rem; text-align: right; font-family: 'JetBrains Mono', monospace; }

        /* === BOOKMARKS === */
        .bookmarks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
        .bookmark { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.1rem; background: var(--void-soft); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; text-decoration: none; transition: all 0.2s; cursor: pointer; }
        .bookmark:hover { border-color: var(--fire); background: var(--ember); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,140,0,0.08); }
        .bookmark-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.06); }
        .bookmark-info { min-width: 0; }
        .bookmark-name { font-size: 0.82rem; font-weight: 600; color: var(--clarity); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bookmark-url { font-size: 0.68rem; color: var(--clarity-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bookmark-category { font-size: 0.65rem; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; color: var(--clarity-dim); margin-bottom: 0.75rem; margin-top: 1.25rem; padding-left: 0.25rem; }
        .bookmark-category:first-child { margin-top: 0; }

        /* === DIVIDER === */
        .flow-divider { width: 60px; height: 2px; background: linear-gradient(90deg, transparent, rgba(255,140,0,0.4), transparent); margin: 0.5rem auto; border-radius: 1px; }

        /* === DAILY BRIEFING === */
        .briefing { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; }
        .briefing-card { background: var(--void-soft); border: 1px solid var(--ember-border); border-radius: 12px; padding: 1rem; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .briefing-label { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.12em; color: var(--fire); margin-bottom: 0.4rem; }
        .briefing-value { font-size: 1.5rem; font-weight: 700; color: var(--clarity); font-family: 'JetBrains Mono', monospace; }
        .briefing-sub { font-size: 0.7rem; color: var(--clarity-muted); margin-top: 0.2rem; }
        .briefing-list { list-style: none; max-height: 100px; overflow-y: auto; }
        .briefing-list li { font-size: 0.75rem; color: var(--clarity-muted); padding: 0.2rem 0; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .briefing-list li:last-child { border-bottom: none; }
        @media (max-width: 768px) { .briefing { grid-template-columns: repeat(2, 1fr); } }

        /* === EXPENSE TRACKER === */
        .exp-summary { display: flex; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .exp-stat { flex: 1; min-width: 100px; text-align: center; padding: 0.6rem; border-radius: 8px; }
        .exp-stat.income { background: rgba(50,205,50,0.1); border: 1px solid rgba(50,205,50,0.25); }
        .exp-stat.expense { background: rgba(255,68,68,0.1); border: 1px solid rgba(255,68,68,0.25); }
        .exp-stat.net { background: var(--ember); border: 1px solid var(--ember-border); }
        .exp-stat-label { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--clarity-dim); }
        .exp-stat-val { font-size: 1.1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .exp-stat.income .exp-stat-val { color: var(--green); }
        .exp-stat.expense .exp-stat-val { color: var(--red); }
        .exp-stat.net .exp-stat-val { color: var(--fire); }
        .exp-add-row { display: flex; gap: 0.4rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .exp-input { flex: 1; min-width: 80px; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.45rem 0.6rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.78rem; outline: none; }
        .exp-input:focus { border-color: var(--fire); }
        .exp-select { background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.45rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.78rem; outline: none; cursor: pointer; }
        .exp-list { max-height: 250px; overflow-y: auto; }
        .exp-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.45rem 0.3rem; border-bottom: 1px solid rgba(0,0,0,0.04); font-size: 0.78rem; }
        .exp-row:last-child { border-bottom: none; }
        .exp-row-type { font-size: 0.6rem; font-weight: 700; padding: 0.1rem 0.4rem; border-radius: 3px; text-transform: uppercase; }
        .exp-row-type.income { background: rgba(50,205,50,0.15); color: var(--green); }
        .exp-row-type.expense { background: rgba(255,68,68,0.15); color: var(--red); }
        .exp-row-desc { flex: 1; color: var(--clarity-muted); }
        .exp-row-cat { font-size: 0.65rem; color: var(--clarity-dim); }
        .exp-row-amt { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 0.8rem; }
        .exp-row-del { background: none; border: none; color: var(--clarity-dim); cursor: pointer; opacity: 0; transition: opacity 0.15s; font-size: 0.85rem; }
        .exp-row:hover .exp-row-del { opacity: 1; }
        .exp-row-del:hover { color: var(--red); }

        /* === BUSINESS FINANCE DASHBOARD === */
        .biz-tabs { display: flex; gap: 0.3rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .biz-tab { padding: 0.35rem 0.7rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; background: var(--void-lift); color: var(--clarity-muted); font-family: 'Inter', sans-serif; font-size: 0.72rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .biz-tab:hover { border-color: var(--fire); color: var(--fire); }
        .biz-tab.active { background: var(--fire); color: #fff; border-color: var(--fire); }
        .biz-tab-content { display: none; }
        .biz-tab-content.active { display: block; }
        .biz-overview-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.6rem; margin-bottom: 1rem; }
        .biz-overview-card { text-align: center; padding: 0.6rem 0.4rem; border-radius: 8px; background: var(--void-soft); border: 1px solid var(--ember-border); }
        .biz-overview-label { font-size: 0.55rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--clarity-dim); margin-bottom: 0.2rem; }
        .biz-overview-val { font-size: 1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--clarity); }
        .biz-overview-card.revenue .biz-overview-val { color: var(--green); }
        .biz-overview-card.deposits .biz-overview-val { color: #5599ff; }
        .biz-overview-card.costs .biz-overview-val { color: var(--red); }
        .biz-overview-card.ads .biz-overview-val { color: #e69500; }
        .biz-overview-card.profit .biz-overview-val { color: var(--fire); }
        .biz-overview-card.jobs .biz-overview-val { color: var(--clarity); }
        @media (max-width: 768px) { .biz-overview-grid { grid-template-columns: repeat(3, 1fr); } }
        .biz-bar-chart { margin-top: 0.5rem; }
        .biz-bar-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem; font-size: 0.75rem; }
        .biz-bar-label { min-width: 90px; text-align: right; color: var(--clarity-muted); font-size: 0.7rem; }
        .biz-bar-track { flex: 1; height: 18px; background: var(--void-lift); border-radius: 4px; overflow: hidden; }
        .biz-bar-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
        .biz-bar-val { min-width: 60px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 600; color: var(--clarity-muted); }
        .biz-section-title { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: var(--fire); margin-bottom: 0.5rem; margin-top: 0.75rem; }
        .job-pipeline { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .job-pipeline-btn { padding: 0.3rem 0.6rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; background: var(--void-lift); color: var(--clarity-muted); font-family: 'Inter', sans-serif; font-size: 0.7rem; cursor: pointer; transition: all 0.15s; }
        .job-pipeline-btn:hover { border-color: var(--fire); color: var(--fire); }
        .job-pipeline-btn.active { background: var(--fire); color: #fff; border-color: var(--fire); }
        .job-pipeline-btn .count { font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .job-list { max-height: 350px; overflow-y: auto; }
        .job-row { padding: 0.6rem 0.4rem; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .job-row:last-child { border-bottom: none; }
        .job-row-top { display: flex; align-items: center; gap: 0.5rem; }
        .job-row-bottom { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem; padding-left: 0.3rem; font-size: 0.7rem; color: var(--clarity-dim); }
        .job-status-badge { font-size: 0.55rem; font-weight: 700; padding: 0.12rem 0.45rem; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.03em; white-space: nowrap; }
        .job-status-badge.scheduled { background: rgba(85,153,255,0.15); color: #5599ff; }
        .job-status-badge.in_progress { background: rgba(255,165,0,0.15); color: #e69500; }
        .job-status-badge.completed { background: rgba(50,205,50,0.15); color: var(--green); }
        .job-status-badge.paid { background: rgba(255,215,0,0.2); color: #d4a800; }
        .job-row-customer { font-size: 0.82rem; font-weight: 600; color: var(--clarity); }
        .job-row-desc { font-size: 0.78rem; color: var(--clarity-muted); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .job-row-price { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 0.82rem; color: var(--green); white-space: nowrap; }
        .job-row-deposit { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: #5599ff; }
        .job-row-actions { display: flex; gap: 0.25rem; }
        .job-action-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: var(--void-lift); color: var(--clarity-muted); font-size: 0.65rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .job-action-btn:hover { border-color: var(--fire); color: var(--fire); }
        .job-action-btn.advance:hover { border-color: var(--green); color: var(--green); }
        .job-action-btn.paid-btn:hover { border-color: #d4a800; color: #d4a800; }
        .job-action-btn.del:hover { border-color: var(--red); color: var(--red); }
        .job-add-row { display: flex; gap: 0.4rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .ad-summary { display: flex; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .ad-summary-card { flex: 1; min-width: 90px; text-align: center; padding: 0.6rem; border-radius: 8px; background: var(--void-soft); border: 1px solid var(--ember-border); }
        .ad-summary-label { font-size: 0.55rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--clarity-dim); }
        .ad-summary-val { font-size: 1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--fire); }
        .ad-platform-badges { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
        .ad-platform-badge { padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.15s; border: 1px solid rgba(255,255,255,0.1); background: var(--void-lift); color: var(--clarity-muted); }
        .ad-platform-badge:hover { border-color: var(--fire); }
        .ad-platform-badge .ad-badge-amt { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; margin-left: 0.3rem; }
        .ad-add-row { display: flex; gap: 0.4rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .ad-list { max-height: 250px; overflow-y: auto; }
        .biz-cat-filter { background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.35rem 0.5rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.72rem; outline: none; cursor: pointer; margin-bottom: 0.5rem; }

        /* === CONTACTS === */
        .contacts-search { width: 100%; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.5rem 0.75rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.82rem; outline: none; margin-bottom: 0.5rem; }
        .contacts-search:focus { border-color: var(--fire); }
        .contacts-list { max-height: 300px; overflow-y: auto; }
        .contact-row { display: flex; align-items: center; gap: 0.6rem; padding: 0.55rem 0.4rem; border-bottom: 1px solid rgba(0,0,0,0.04); transition: background 0.1s; border-radius: 4px; }
        .contact-row:hover { background: var(--ember); }
        .contact-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--ember); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem; color: var(--fire); flex-shrink: 0; }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-size: 0.82rem; font-weight: 600; color: var(--clarity); }
        .contact-role { font-size: 0.6rem; color: var(--clarity-dim); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }
        .contact-actions { display: flex; gap: 0.3rem; }
        .contact-action { width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: var(--void-lift); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; cursor: pointer; transition: all 0.15s; text-decoration: none; }
        .contact-action:hover { border-color: var(--fire); background: var(--ember); }

        /* === HABITS / WORKOUT === */
        .habit-date-nav { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.6rem; }
        .habit-date-btn { background: none; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--clarity-dim); font-size: 0.75rem; padding: 0.2rem 0.5rem; cursor: pointer; font-family: 'Inter', sans-serif; }
        .habit-date-btn:hover { border-color: var(--fire); color: var(--fire); }
        .habit-date-label { font-size: 0.78rem; font-weight: 600; color: var(--clarity); flex: 1; text-align: center; }
        .habit-list { list-style: none; }
        .habit-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.3rem; border-bottom: 1px solid rgba(0,0,0,0.04); }
        .habit-item:last-child { border-bottom: none; }
        .habit-check { width: 22px; height: 22px; border: 2px solid var(--clarity-dim); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: transparent; transition: all 0.15s; flex-shrink: 0; }
        .habit-check.done { border-color: var(--green); background: var(--green-dim); color: var(--green); }
        .habit-name { flex: 1; font-size: 0.82rem; color: var(--clarity-muted); }
        .habit-cat { font-size: 0.58rem; color: var(--clarity-dim); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }
        .habit-streak { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--fire); font-weight: 600; }
        .habit-add-row { display: flex; gap: 0.4rem; margin-top: 0.5rem; }

        /* === MEAL PLAN === */
        .meal-days { display: flex; gap: 0.3rem; margin-bottom: 0.6rem; overflow-x: auto; }
        .meal-day-btn { padding: 0.35rem 0.6rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; background: var(--void-lift); color: var(--clarity-dim); font-family: 'Inter', sans-serif; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
        .meal-day-btn:hover { border-color: var(--fire); color: var(--fire); }
        .meal-day-btn.active { background: var(--fire); color: #fff; border-color: var(--fire); }
        .meal-section { margin-bottom: 0.5rem; }
        .meal-section-label { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--fire); margin-bottom: 0.3rem; }
        .meal-item { display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0; font-size: 0.78rem; color: var(--clarity-muted); }
        .meal-item-cal { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--clarity-dim); }
        .meal-item-del { background: none; border: none; color: var(--clarity-dim); cursor: pointer; font-size: 0.8rem; opacity: 0; transition: opacity 0.15s; }
        .meal-item:hover .meal-item-del { opacity: 1; }
        .meal-add-row { display: flex; gap: 0.3rem; margin-top: 0.3rem; }
        .meal-total { font-size: 0.7rem; color: var(--clarity-dim); text-align: right; margin-top: 0.3rem; font-family: 'JetBrains Mono', monospace; }

        /* === APPLE MUSIC === */
        .music-embed { border-radius: 10px; overflow: hidden; background: rgba(0,0,0,0.05); }
        .music-embed iframe { display: block; width: 100%; border: none; border-radius: 10px; }

        /* === STRETCH + BREATHE === */
        .stretch-main { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
        .stretch-breath-ring { position: relative; width: 140px; height: 140px; }
        .stretch-breath-circle { width: 140px; height: 140px; border-radius: 50%; border: 3px solid var(--fire); display: flex; align-items: center; justify-content: center; flex-direction: column; transition: transform 4s ease-in-out, border-color 0.3s; background: rgba(255,106,0,0.06); }
        .stretch-breath-circle.inhale { transform: scale(1.25); border-color: var(--green); background: rgba(50,205,50,0.08); }
        .stretch-breath-circle.exhale { transform: scale(0.85); border-color: #5599ff; background: rgba(85,153,255,0.08); }
        .stretch-breath-circle.hold { transform: scale(1.25); border-color: var(--yellow); background: rgba(255,215,0,0.08); }
        .stretch-breath-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.12em; color: var(--fire); }
        .stretch-breath-timer { font-family: 'JetBrains Mono', monospace; font-size: 1.8rem; font-weight: 700; color: var(--clarity); }
        .stretch-name { font-size: 1rem; font-weight: 700; color: var(--clarity); text-align: center; }
        .stretch-cue { font-size: 0.78rem; color: var(--clarity-muted); text-align: center; max-width: 280px; line-height: 1.5; }
        .stretch-progress { width: 100%; height: 4px; background: rgba(0,0,0,0.08); border-radius: 2px; overflow: hidden; }
        .stretch-progress-bar { height: 100%; background: linear-gradient(90deg, var(--fire-deep), var(--fire-bright)); border-radius: 2px; transition: width 0.3s; }
        .stretch-step-label { font-size: 0.65rem; color: var(--clarity-dim); font-family: 'JetBrains Mono', monospace; }
        .stretch-controls { display: flex; gap: 0.5rem; }
        .stretch-btn { padding: 0.5rem 1.2rem; border: 1px solid var(--ember-border); border-radius: 8px; background: var(--void-lift); color: var(--clarity-soft); font-family: 'Inter', sans-serif; font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .stretch-btn:hover { border-color: var(--fire); color: var(--fire); }
        .stretch-btn.primary { background: var(--fire); color: #fff; border-color: var(--fire); }
        .stretch-btn.primary:hover { background: var(--fire-bright); }
        .stretch-btn:disabled { opacity: 0.4; cursor: default; }
        .stretch-upcoming { width: 100%; }
        .stretch-upcoming-label { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--clarity-dim); margin-bottom: 0.3rem; }
        .stretch-upcoming-list { display: flex; flex-direction: column; gap: 0.15rem; }
        .stretch-up-item { font-size: 0.72rem; color: var(--clarity-muted); padding: 0.2rem 0.3rem; border-radius: 3px; display: flex; align-items: center; gap: 0.4rem; }
        .stretch-up-item.active { background: var(--ember); color: var(--fire); font-weight: 600; }
        .stretch-up-num { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--clarity-dim); width: 16px; }
        .stretch-done-msg { text-align: center; padding: 1.5rem; }
        .stretch-done-msg h3 { font-size: 1.1rem; color: var(--fire); margin-bottom: 0.3rem; }
        .stretch-done-msg p { font-size: 0.82rem; color: var(--clarity-muted); }

        /* === MAP WIDGET === */
        .map-container { height: 380px; border-radius: 10px; overflow: hidden; margin-bottom: 0.75rem; border: 1px solid rgba(255,106,0,0.2); }
        .map-search-row { display: flex; gap: 0.4rem; margin-bottom: 0.6rem; }
        .map-search-input { flex: 1; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.5rem 0.75rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.82rem; outline: none; }
        .map-search-input:focus { border-color: var(--fire); }
        .map-search-input::placeholder { color: var(--clarity-dim); }
        .map-search-results { position: relative; }
        .map-search-dropdown { position: absolute; top: 0; left: 0; right: 0; background: var(--void-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--ember-border); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .map-search-dropdown.show { display: block; }
        .map-dd-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .map-dd-item:hover { background: var(--ember); }
        .map-dd-item:last-child { border-bottom: none; }
        .map-dd-cat { font-size: 0.65rem; color: var(--clarity-dim); background: rgba(255,106,0,0.1); padding: 0.1rem 0.4rem; border-radius: 4px; }
        .map-filters { display: flex; gap: 0.3rem; margin-bottom: 0.6rem; flex-wrap: wrap; }
        .map-filter-btn { padding: 0.3rem 0.6rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; background: var(--void-lift); color: var(--clarity-muted); font-family: 'Inter', sans-serif; font-size: 0.7rem; cursor: pointer; transition: all 0.2s; }
        .map-filter-btn:hover, .map-filter-btn.active { border-color: var(--fire); background: var(--ember); color: var(--fire); }
        .map-saved-list { max-height: 200px; overflow-y: auto; }
        .map-saved-item { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 0.78rem; }
        .map-saved-item:hover { background: rgba(255,106,0,0.05); }
        .map-saved-name { cursor: pointer; flex: 1; }
        .map-saved-name:hover { color: var(--fire); }
        .map-saved-cat { font-size: 0.6rem; color: var(--clarity-dim); margin-right: 0.5rem; }
        .map-saved-del { background: none; border: none; color: var(--red); cursor: pointer; font-size: 0.8rem; padding: 0.2rem; }
        .map-badge { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.65rem; font-weight: 600; padding: 0.15rem 0.5rem; border-radius: 10px; margin-left: auto; }
        .map-badge.online { background: var(--green-dim); color: var(--green); }
        .map-badge.offline { background: var(--red-dim); color: var(--red); }
        .map-badge-dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; }
        /* Map modal */
        .map-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .map-modal-overlay.show { display: flex; }
        .map-modal { background: var(--void-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--ember-border); border-radius: 14px; padding: 1.5rem; width: 90%; max-width: 420px; }
        .map-modal h3 { font-size: 0.9rem; color: var(--fire); margin-bottom: 1rem; }
        .map-modal label { font-size: 0.72rem; font-weight: 600; color: var(--clarity-muted); display: block; margin-bottom: 0.2rem; }
        .map-modal input, .map-modal select, .map-modal textarea { width: 100%; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.45rem 0.6rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.82rem; outline: none; margin-bottom: 0.6rem; }
        .map-modal input:focus, .map-modal select:focus, .map-modal textarea:focus { border-color: var(--fire); }
        .map-modal textarea { resize: vertical; min-height: 60px; }
        .map-modal-btns { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 0.5rem; }
        .map-modal-btn { padding: 0.4rem 1rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; background: var(--void-lift); color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.8rem; cursor: pointer; }
        .map-modal-btn.primary { background: var(--fire); color: #fff; border-color: var(--fire); }

        /* === INVESTMENT TRACKER === */
        .inv-summary { display: flex; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .inv-stat { flex: 1; min-width: 100px; text-align: center; padding: 0.6rem; border-radius: 8px; }
        .inv-stat.invested { background: rgba(85,153,255,0.1); border: 1px solid rgba(85,153,255,0.25); }
        .inv-stat.value { background: rgba(50,205,50,0.1); border: 1px solid rgba(50,205,50,0.25); }
        .inv-stat.roi { background: var(--ember); border: 1px solid var(--ember-border); }
        .inv-stat-label { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--clarity-dim); }
        .inv-stat-val { font-size: 1.1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .inv-stat.invested .inv-stat-val { color: #5599ff; }
        .inv-stat.value .inv-stat-val { color: var(--green); }
        .inv-stat.roi .inv-stat-val { color: var(--fire); }
        .inv-tabs { display: flex; gap: 0.3rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .inv-tab { padding: 0.35rem 0.7rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; background: var(--void-lift); color: var(--clarity-muted); font-family: 'Inter', sans-serif; font-size: 0.72rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .inv-tab:hover { border-color: var(--fire); color: var(--fire); }
        .inv-tab.active { background: var(--fire); color: #fff; border-color: var(--fire); }
        .inv-list { max-height: 320px; overflow-y: auto; }
        .inv-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.55rem 0.3rem; border-bottom: 1px solid rgba(0,0,0,0.04); font-size: 0.78rem; }
        .inv-row:last-child { border-bottom: none; }
        .inv-row:hover { background: rgba(255,106,0,0.03); }
        .inv-type-badge { font-size: 0.55rem; font-weight: 700; padding: 0.12rem 0.4rem; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
        .inv-type-badge.crypto { background: rgba(255,165,0,0.15); color: #e69500; }
        .inv-type-badge.stock { background: rgba(85,153,255,0.15); color: #5599ff; }
        .inv-type-badge.business { background: rgba(50,205,50,0.15); color: var(--green); }
        .inv-type-badge.real_estate { background: rgba(160,80,220,0.15); color: #a050dc; }
        .inv-name { flex: 1; font-weight: 600; color: var(--clarity); min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .inv-ticker { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--clarity-dim); }
        .inv-col { text-align: right; min-width: 70px; font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; }
        .inv-gain { font-weight: 600; }
        .inv-gain.up { color: var(--green); }
        .inv-gain.down { color: var(--red); }
        .inv-gain.flat { color: var(--clarity-dim); }
        .inv-row-del { background: none; border: none; color: var(--clarity-dim); cursor: pointer; opacity: 0; transition: opacity 0.15s; font-size: 0.85rem; }
        .inv-row:hover .inv-row-del { opacity: 1; }
        .inv-row-del:hover { color: var(--red); }
        .inv-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .inv-modal-overlay.active { display: flex; }
        .inv-modal { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border: 1px solid var(--ember-border); border-radius: 16px; padding: 1.5rem; width: 90%; max-width: 480px; }
        .inv-modal-title { font-size: 1rem; font-weight: 600; color: var(--clarity); margin-bottom: 1rem; }
        .inv-modal label { font-size: 0.72rem; font-weight: 600; color: var(--clarity-muted); display: block; margin-bottom: 0.2rem; }
        .inv-modal input, .inv-modal select { width: 100%; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.5rem 0.75rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.82rem; outline: none; margin-bottom: 0.6rem; }
        .inv-modal input:focus, .inv-modal select:focus { border-color: var(--fire); }
        .inv-modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem; }
        .inv-modal-btns { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 0.5rem; }
        .inv-hcp-badge { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.55rem; font-weight: 600; padding: 0.1rem 0.35rem; border-radius: 3px; background: rgba(85,153,255,0.12); color: #5599ff; margin-left: 0.3rem; }

        /* === STICKY BOTTOM BAR === */
        #cockpit-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 48px; background: rgba(255,255,255,0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid var(--ember-border); z-index: 9999; display: flex; align-items: center; padding: 0 1rem; gap: 0.75rem; }
        .bar-section { display: flex; align-items: center; gap: 0.5rem; }
        .bar-left { flex: 0 0 auto; }
        .bar-center { flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; min-width: 0; }
        .bar-right { flex: 0 0 280px; }
        .bar-btn { background: none; border: none; color: var(--clarity-muted); cursor: pointer; font-size: 1.1rem; padding: 0.3rem; border-radius: 6px; transition: color 0.2s, background 0.2s; }
        .bar-btn:hover { color: var(--fire); background: var(--ember); }
        .bar-art { width: 28px; height: 28px; border-radius: 4px; object-fit: cover; display: none; }
        .bar-track { font-size: 0.72rem; font-weight: 500; color: var(--clarity); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .bar-vol { width: 60px; accent-color: var(--fire); height: 3px; }
        .bar-search-wrap { position: relative; width: 100%; }
        .bar-search { width: 100%; background: var(--void-lift); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.35rem 0.6rem 0.35rem 1.8rem; color: var(--clarity); font-family: 'Inter', sans-serif; font-size: 0.75rem; outline: none; }
        .bar-search:focus { border-color: var(--fire); }
        .bar-search::placeholder { color: var(--clarity-dim); }
        .bar-search-icon { position: absolute; left: 0.6rem; top: 50%; transform: translateY(-50%); font-size: 0.8rem; color: var(--clarity-dim); pointer-events: none; }
        .bar-search-results { position: absolute; bottom: 100%; left: 0; right: 0; background: var(--void-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--ember-border); border-radius: 8px; max-height: 250px; overflow-y: auto; display: none; margin-bottom: 4px; }
        .bar-search-results.show { display: block; }
        .bar-sr-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.78rem; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 0.5rem; }
        .bar-sr-item:hover { background: var(--ember); }
        .bar-sr-item:last-child { border-bottom: none; }
        .bar-sr-type { font-size: 0.6rem; color: var(--clarity-dim); background: rgba(255,106,0,0.1); padding: 0.1rem 0.4rem; border-radius: 4px; white-space: nowrap; }
        /* Settings panel */
        .bar-settings-panel { display: none; position: fixed; bottom: 56px; left: 1rem; background: var(--void-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--ember-border); border-radius: 12px; padding: 1rem; width: 260px; z-index: 10000; }
        .bar-settings-panel.show { display: block; }
        .bar-settings-panel h4 { font-size: 0.75rem; font-weight: 600; color: var(--fire); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; }
        .bar-setting-row { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; font-size: 0.8rem; }
        .bar-setting-label { color: var(--clarity-muted); }
        .bar-toggle { width: 36px; height: 20px; border-radius: 10px; background: rgba(0,0,0,0.15); border: none; cursor: pointer; position: relative; transition: background 0.2s; }
        .bar-toggle.on { background: var(--fire); }
        .bar-toggle::after { content: ''; position: absolute; width: 16px; height: 16px; border-radius: 50%; background: white; top: 2px; left: 2px; transition: transform 0.2s; }
        .bar-toggle.on::after { transform: translateX(16px); }

        /* === RESPONSIVE === */
        @media (max-width: 1024px) {
            .widgets-grid { grid-template-columns: repeat(2, 1fr); }
            .widget-span-2 { grid-column: span 2; }
            .widget-span-4 { grid-column: span 2; }
            .todo-columns { grid-template-columns: 1fr; }
            .cal-container { grid-template-columns: 1fr; }
            .cal-sidebar { border-left: none; padding-left: 0; border-top: 1px solid rgba(255,255,255,0.06); padding-top: 1rem; }
        }
        @media (max-width: 768px) {
            .ops-grid { grid-template-columns: 1fr; }
            .widgets-grid { grid-template-columns: 1fr; }
            .widget-span-2, .widget-span-4 { grid-column: span 1; }
            .header h1 { font-size: 1.8rem; }
            .bookmarks-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
            .cockpit { padding: 1.5rem 1rem 3rem; }
            .bar-right { flex: 0 0 160px; }
            .bar-track { max-width: 100px; }
            .bar-vol { width: 40px; }
            .map-container { height: 280px; }
        }
        @media (max-width: 480px) {
            .bookmarks-grid { grid-template-columns: 1fr; }
        }

        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body>

<!-- NASCAR BORDER RACE TRACK -->
<div class="racetrack-overlay">
    <svg viewBox="0 0 1000 600" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Track path (invisible, just for cars to follow) -->
        <defs>
            <path id="border-track" d="M 30,20 L 970,20 Q 990,20 990,40 L 990,560 Q 990,580 970,580 L 30,580 Q 10,580 10,560 L 10,40 Q 10,20 30,20 Z"/>
        </defs>

        <!-- Subtle track lines on page border -->
        <use href="#border-track" fill="none" stroke="rgba(255,106,0,0.08)" stroke-width="28"/>
        <use href="#border-track" fill="none" stroke="rgba(255,106,0,0.12)" stroke-width="2" stroke-dasharray="8 6"/>

        <!-- Car 1 — Orange #95 -->
        <g>
            <animateMotion dur="12s" repeatCount="indefinite" rotate="auto" keyPoints="0;1" keyTimes="0;1" calcMode="linear">
                <mpath href="#border-track"/>
            </animateMotion>
            <rect x="-16" y="-7" width="32" height="14" rx="5" fill="#FF6A00" stroke="#E55A00" stroke-width="1"/>
            <rect x="9" y="-5" width="6" height="10" rx="2" fill="#222"/>
            <rect x="-14" y="-5" width="7" height="10" rx="2" fill="#FFD700" opacity="0.8"/>
            <circle cx="-8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <circle cx="8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <text x="0" y="3.5" text-anchor="middle" fill="#FFF" font-size="6" font-weight="700" font-family="Inter,sans-serif">95</text>
            <!-- Glow trail -->
            <rect x="-40" y="-4" width="24" height="8" rx="4" fill="rgba(255,106,0,0.3)"/>
            <rect x="-56" y="-2" width="16" height="4" rx="2" fill="rgba(255,106,0,0.12)"/>
        </g>

        <!-- Car 2 — Blue #24 -->
        <g>
            <animateMotion dur="13.2s" repeatCount="indefinite" rotate="auto" keyPoints="0;1" keyTimes="0;1" calcMode="linear" begin="-2.2s">
                <mpath href="#border-track"/>
            </animateMotion>
            <rect x="-16" y="-7" width="32" height="14" rx="5" fill="#0099FF" stroke="#0077CC" stroke-width="1"/>
            <rect x="9" y="-5" width="6" height="10" rx="2" fill="#222"/>
            <rect x="-14" y="-5" width="7" height="10" rx="2" fill="#00DDFF" opacity="0.8"/>
            <circle cx="-8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <circle cx="8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <text x="0" y="3.5" text-anchor="middle" fill="#FFF" font-size="6" font-weight="700" font-family="Inter,sans-serif">24</text>
            <rect x="-40" y="-4" width="24" height="8" rx="4" fill="rgba(0,153,255,0.3)"/>
            <rect x="-56" y="-2" width="16" height="4" rx="2" fill="rgba(0,153,255,0.12)"/>
        </g>

        <!-- Car 3 — Red #3 -->
        <g>
            <animateMotion dur="11.5s" repeatCount="indefinite" rotate="auto" keyPoints="0;1" keyTimes="0;1" calcMode="linear" begin="-4.5s">
                <mpath href="#border-track"/>
            </animateMotion>
            <rect x="-16" y="-7" width="32" height="14" rx="5" fill="#FF2222" stroke="#CC0000" stroke-width="1"/>
            <rect x="9" y="-5" width="6" height="10" rx="2" fill="#222"/>
            <rect x="-14" y="-5" width="7" height="10" rx="2" fill="#FF6666" opacity="0.8"/>
            <circle cx="-8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <circle cx="8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <text x="0" y="3.5" text-anchor="middle" fill="#FFF" font-size="6" font-weight="700" font-family="Inter,sans-serif">3</text>
            <rect x="-40" y="-4" width="24" height="8" rx="4" fill="rgba(255,34,34,0.3)"/>
            <rect x="-56" y="-2" width="16" height="4" rx="2" fill="rgba(255,34,34,0.12)"/>
        </g>

        <!-- Car 4 — Green #18 -->
        <g>
            <animateMotion dur="14s" repeatCount="indefinite" rotate="auto" keyPoints="0;1" keyTimes="0;1" calcMode="linear" begin="-7s">
                <mpath href="#border-track"/>
            </animateMotion>
            <rect x="-16" y="-7" width="32" height="14" rx="5" fill="#32CD32" stroke="#228B22" stroke-width="1"/>
            <rect x="9" y="-5" width="6" height="10" rx="2" fill="#222"/>
            <rect x="-14" y="-5" width="7" height="10" rx="2" fill="#90EE90" opacity="0.8"/>
            <circle cx="-8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <circle cx="8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <text x="0" y="3.5" text-anchor="middle" fill="#FFF" font-size="6" font-weight="700" font-family="Inter,sans-serif">18</text>
            <rect x="-40" y="-4" width="24" height="8" rx="4" fill="rgba(50,205,50,0.3)"/>
            <rect x="-56" y="-2" width="16" height="4" rx="2" fill="rgba(50,205,50,0.12)"/>
        </g>

        <!-- Car 5 — Purple #48 -->
        <g>
            <animateMotion dur="12.6s" repeatCount="indefinite" rotate="auto" keyPoints="0;1" keyTimes="0;1" calcMode="linear" begin="-9.5s">
                <mpath href="#border-track"/>
            </animateMotion>
            <rect x="-16" y="-7" width="32" height="14" rx="5" fill="#9933FF" stroke="#7722CC" stroke-width="1"/>
            <rect x="9" y="-5" width="6" height="10" rx="2" fill="#222"/>
            <rect x="-14" y="-5" width="7" height="10" rx="2" fill="#CC88FF" opacity="0.8"/>
            <circle cx="-8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <circle cx="8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <text x="0" y="3.5" text-anchor="middle" fill="#FFF" font-size="6" font-weight="700" font-family="Inter,sans-serif">48</text>
            <rect x="-40" y="-4" width="24" height="8" rx="4" fill="rgba(153,51,255,0.3)"/>
            <rect x="-56" y="-2" width="16" height="4" rx="2" fill="rgba(153,51,255,0.12)"/>
        </g>

        <!-- Car 6 — Yellow #22 -->
        <g>
            <animateMotion dur="13.8s" repeatCount="indefinite" rotate="auto" keyPoints="0;1" keyTimes="0;1" calcMode="linear" begin="-11.5s">
                <mpath href="#border-track"/>
            </animateMotion>
            <rect x="-16" y="-7" width="32" height="14" rx="5" fill="#FFD700" stroke="#DAA520" stroke-width="1"/>
            <rect x="9" y="-5" width="6" height="10" rx="2" fill="#222"/>
            <rect x="-14" y="-5" width="7" height="10" rx="2" fill="#FFF68F" opacity="0.8"/>
            <circle cx="-8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <circle cx="8" cy="8" r="3" fill="#333" stroke="#555" stroke-width="0.7"/>
            <text x="0" y="3.5" text-anchor="middle" fill="#111" font-size="6" font-weight="700" font-family="Inter,sans-serif">22</text>
            <rect x="-40" y="-4" width="24" height="8" rx="4" fill="rgba(255,215,0,0.3)"/>
            <rect x="-56" y="-2" width="16" height="4" rx="2" fill="rgba(255,215,0,0.12)"/>
        </g>
    </svg>
</div>

<div class="cockpit">

    <!-- HEADER -->
    <header class="header">
        <h1>COMMAND COCKPIT</h1>
        <p class="header-sub">One page. Zero friction. Everything flows.</p>
        <div class="clock" id="clock"></div>
    </header>

    <!-- DAILY INSIGHT — very top, small and centered -->
    <div class="insight-bar">
        <span class="insight-text" id="motivation-quote"></span>
        <span class="insight-source" id="motivation-source"></span>
        <button class="insight-refresh" onclick="nextQuote()">&#8635;</button>
    </div>

    <!-- DAILY BRIEFING -->
    <section>
        <div class="section-label">Daily Briefing</div>
        <div class="briefing" id="briefing">
            <div class="briefing-card">
                <div class="briefing-label">Your Location</div>
                <div class="briefing-value" id="brief-weather">--</div>
                <div class="briefing-sub" id="brief-weather-desc">Loading...</div>
            </div>
            <div class="briefing-card">
                <div class="briefing-label">Denver, CO</div>
                <div class="briefing-value" id="brief-denver">--</div>
                <div class="briefing-sub" id="brief-denver-desc">Loading...</div>
            </div>
            <div class="briefing-card">
                <div class="briefing-label">Today's Jobs</div>
                <div class="briefing-value" id="brief-jobs">0</div>
                <div class="briefing-sub" id="brief-jobs-next">No jobs today</div>
            </div>
            <div class="briefing-card">
                <div class="briefing-label">Tasks Due</div>
                <div class="briefing-value" id="brief-tasks">0</div>
                <div class="briefing-sub" id="brief-tasks-pts">0 pts remaining</div>
            </div>
            <div class="briefing-card">
                <div class="briefing-label">This Month</div>
                <div class="briefing-value" id="brief-income">$0</div>
                <div class="briefing-sub" id="brief-expense">$0 expenses</div>
            </div>
        </div>
    </section>

    <div class="flow-divider"></div>

    <!-- OPS HUB (Fire) -->
    <section>
        <div class="section-label">Operations Hub</div>
        <div class="ops-grid">
            <div class="card ops-card">
                <div class="card-title"><span class="icon">🏠</span> Housecall Pro</div>
                <p class="card-desc">Field service management — scheduling, dispatching, invoicing, and customer communications.</p>
                <span class="ops-status connected"><span class="ops-dot"></span> CONNECTED</span>
                <div class="ops-actions">
                    <a href="https://pro.housecallpro.com" target="_blank" class="ops-btn primary">Open Dashboard</a>
                    <a href="https://pro.housecallpro.com/pro/calendar" target="_blank" class="ops-btn">Calendar</a>
                    <a href="https://pro.housecallpro.com/pro/customers" target="_blank" class="ops-btn">Customers</a>
                    <a href="https://pro.housecallpro.com/pro/invoices" target="_blank" class="ops-btn">Invoices</a>
                    <a href="https://pro.housecallpro.com/pro/reports" target="_blank" class="ops-btn">Reports</a>
                </div>
            </div>
            <div class="card ops-card">
                <div class="card-title"><span class="icon">⚡</span> Zapier</div>
                <p class="card-desc">Automation engine — connects Housecall Pro, Gmail, Slack, and every tool in the stack.</p>
                <span class="ops-status connected"><span class="ops-dot"></span> CONNECTED</span>
                <div class="ops-actions">
                    <a href="https://zapier.com/app/dashboard" target="_blank" class="ops-btn primary">Open Dashboard</a>
                    <a href="https://zapier.com/app/zaps" target="_blank" class="ops-btn">My Zaps</a>
                    <a href="https://zapier.com/app/history" target="_blank" class="ops-btn">Task History</a>
                    <a href="https://zapier.com/apps" target="_blank" class="ops-btn">App Directory</a>
                </div>
            </div>
        </div>
    </section>

    <div class="flow-divider"></div>

    <!-- MORNING ROUTINE -->
    <section>
        <div class="section-label">Morning Routine</div>
        <div class="widgets-grid">

            <!-- Stretch + Breathe Routine -->
            <div class="widget widget-span-2" id="stretch-widget">
                <div class="widget-head"><span class="w-icon">🧘</span> 10-Min Stretch + Breathe</div>
                <div class="stretch-main" id="stretch-main">
                    <div class="stretch-breath-ring">
                        <div class="stretch-breath-circle" id="stretch-circle">
                            <span class="stretch-breath-label" id="stretch-breath-label">Ready</span>
                            <span class="stretch-breath-timer" id="stretch-timer">10:00</span>
                        </div>
                    </div>
                    <div class="stretch-name" id="stretch-name">Press Start</div>
                    <div class="stretch-cue" id="stretch-cue">A 10-minute guided routine — stretching + box breathing for focus and recovery.</div>
                    <div class="stretch-progress"><div class="stretch-progress-bar" id="stretch-progress" style="width:0%;"></div></div>
                    <div class="stretch-step-label" id="stretch-step-label">0 / 12</div>
                    <div class="stretch-controls">
                        <button class="stretch-btn" id="stretch-prev-btn" onclick="stretchPrev()" disabled>&larr;</button>
                        <button class="stretch-btn primary" id="stretch-play-btn" onclick="stretchToggle()">Start</button>
                        <button class="stretch-btn" id="stretch-next-btn" onclick="stretchNext()">&rarr;</button>
                        <button class="stretch-btn" onclick="stretchReset()">Reset</button>
                    </div>
                    <div class="stretch-upcoming" id="stretch-upcoming"></div>
                </div>
            </div>

            <!-- Meal Plan -->
            <div class="widget widget-span-2" id="meal-widget">
                <div class="widget-head"><span class="w-icon">🍽</span> Meal Plan</div>
                <div class="meal-days" id="meal-days"></div>
                <div id="meal-content"></div>
                <div class="meal-add-row">
                    <select class="exp-select" id="meal-type-sel"><option value="Breakfast">Breakfast</option><option value="Lunch">Lunch</option><option value="Dinner">Dinner</option><option value="Snack">Snack</option></select>
                    <input type="text" class="exp-input" id="meal-name" placeholder="Meal name" style="flex:1;">
                    <input type="number" class="exp-input" id="meal-cal" placeholder="Cal" style="max-width:60px;">
                    <button class="todo-add-btn" onclick="mealAdd()" style="width:32px;">+</button>
                </div>
                <div class="meal-total" id="meal-total"></div>
            </div>

            <!-- Habits / Workout Tracker -->
            <div class="widget widget-span-2" id="habits-widget">
                <div class="widget-head">
                    <span class="w-icon">🔥</span> Habits / Workout
                    <div class="widget-head-right"><button class="todo-add-btn" onclick="habitOpenAdd()" style="width:28px;height:28px;font-size:0.9rem;border-radius:50%;">+</button></div>
                </div>
                <div class="habit-date-nav">
                    <button class="habit-date-btn" onclick="habitPrevDay()">&larr;</button>
                    <span class="habit-date-label" id="habit-date-label">Today</span>
                    <button class="habit-date-btn" onclick="habitNextDay()">&rarr;</button>
                </div>
                <ul class="habit-list" id="habit-list"></ul>
                <div class="habit-add-row" id="habit-add-row" style="display:none;">
                    <input type="text" class="exp-input" id="habit-new-name" placeholder="New habit name" style="flex:1;">
                    <select class="exp-select" id="habit-new-cat"><option value="Workout">Workout</option><option value="Health">Health</option><option value="Growth">Growth</option><option value="Daily">Daily</option></select>
                    <button class="todo-add-btn" onclick="habitAdd()" style="width:32px;">+</button>
                </div>
            </div>

            <!-- Spotify -->
            <div class="widget widget-span-2" id="music-widget">
                <div class="widget-head">
                    <span class="w-icon">🎵</span> Spotify
                    <div class="widget-head-right">
                        <span id="sp-user" style="font-size:0.65rem;color:var(--clarity-dim);"></span>
                        <span id="sp-device-badge" style="font-size:0.58rem;color:var(--green);background:var(--green-dim);padding:0.15rem 0.5rem;border-radius:8px;display:none;"></span>
                        <button class="ops-btn" id="sp-connect-btn" onclick="spConnect()" style="font-size:0.68rem;padding:0.3rem 0.7rem;">Connect</button>
                    </div>
                </div>
                <!-- Not connected state -->
                <div id="sp-login-view" style="text-align:center;padding:2rem 1rem;">
                    <div style="font-size:2.5rem;margin-bottom:0.5rem;">🎧</div>
                    <div style="font-size:0.9rem;font-weight:600;color:var(--clarity);margin-bottom:0.3rem;">Connect Your Spotify</div>
                    <div style="font-size:0.78rem;color:var(--clarity-muted);margin-bottom:1rem;">Log in to play your music, playlists, and more.</div>
                    <button class="stretch-btn primary" onclick="spConnect()">Connect Spotify</button>
                </div>
                <!-- Player state -->
                <div id="sp-player-view" style="display:none;">
                    <!-- Now Playing -->
                    <div id="sp-now-playing" style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                        <img id="sp-art" src="" style="width:64px;height:64px;border-radius:6px;object-fit:cover;background:rgba(0,0,0,0.1);display:none;">
                        <div style="flex:1;min-width:0;">
                            <div id="sp-track" style="font-size:0.88rem;font-weight:600;color:var(--clarity);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">No track playing</div>
                            <div id="sp-artist" style="font-size:0.75rem;color:var(--clarity-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                        <span id="sp-time-cur" style="font-size:0.6rem;color:var(--clarity-dim);font-family:'JetBrains Mono',monospace;width:32px;">0:00</span>
                        <div style="flex:1;height:4px;background:rgba(0,0,0,0.08);border-radius:2px;cursor:pointer;overflow:hidden;" onclick="spSeek(event)">
                            <div id="sp-progress" style="height:100%;background:var(--fire);border-radius:2px;width:0%;transition:width 0.3s;"></div>
                        </div>
                        <span id="sp-time-dur" style="font-size:0.6rem;color:var(--clarity-dim);font-family:'JetBrains Mono',monospace;width:32px;text-align:right;">0:00</span>
                    </div>
                    <!-- Status -->
                    <div id="sp-status" style="font-size:0.68rem;color:var(--clarity-dim);text-align:center;margin-bottom:0.4rem;"></div>
                    <!-- Controls -->
                    <div style="display:flex;justify-content:center;align-items:center;gap:0.6rem;margin-bottom:0.75rem;">
                        <button class="stretch-btn" onclick="spShuffle()" id="sp-shuffle-btn" title="Shuffle" style="padding:0.4rem 0.6rem;">🔀</button>
                        <button class="stretch-btn" onclick="spPrev()" title="Previous" style="padding:0.4rem 0.7rem;">⏮</button>
                        <button class="stretch-btn primary" onclick="spPlayPause()" id="sp-play-btn" style="padding:0.5rem 1.2rem;font-size:1rem;">▶</button>
                        <button class="stretch-btn" onclick="spNext()" title="Next" style="padding:0.4rem 0.7rem;">⏭</button>
                        <button class="stretch-btn" onclick="spRepeat()" id="sp-repeat-btn" title="Repeat" style="padding:0.4rem 0.6rem;">🔁</button>
                    </div>
                    <!-- Volume -->
                    <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.75rem;">
                        <span style="font-size:0.75rem;">🔊</span>
                        <input type="range" id="sp-volume" min="0" max="100" value="50" oninput="spSetVolume(this.value)" style="flex:1;accent-color:var(--fire);">
                    </div>
                    <!-- Tabs: Library | Search | Queue -->
                    <div style="display:flex;gap:0;margin-bottom:0.5rem;border-bottom:1px solid rgba(0,0,0,0.08);">
                        <button class="sp-tab active" onclick="spSwitchTab('library')" id="sp-tab-library" style="flex:1;padding:0.4rem;font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;border:none;background:none;cursor:pointer;color:var(--fire);border-bottom:2px solid var(--fire);">Library</button>
                        <button class="sp-tab" onclick="spSwitchTab('search')" id="sp-tab-search" style="flex:1;padding:0.4rem;font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;border:none;background:none;cursor:pointer;color:var(--clarity-dim);border-bottom:2px solid transparent;">Search</button>
                        <button class="sp-tab" onclick="spSwitchTab('queue')" id="sp-tab-queue" style="flex:1;padding:0.4rem;font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;border:none;background:none;cursor:pointer;color:var(--clarity-dim);border-bottom:2px solid transparent;">Queue</button>
                    </div>
                    <!-- Library Panel -->
                    <div id="sp-panel-library">
                        <div id="sp-playlists" style="max-height:280px;overflow-y:auto;"></div>
                    </div>
                    <!-- Search Panel -->
                    <div id="sp-panel-search" style="display:none;">
                        <div style="position:relative;margin-bottom:0.5rem;">
                            <input type="text" id="sp-search-input" placeholder="Search songs, artists, albums..." oninput="spSearchDebounce()" style="width:100%;padding:0.5rem 0.75rem 0.5rem 2rem;border:1px solid rgba(0,0,0,0.1);border-radius:8px;font-size:0.78rem;background:rgba(255,255,255,0.5);color:var(--clarity);outline:none;font-family:inherit;" />
                            <span style="position:absolute;left:0.6rem;top:50%;transform:translateY(-50%);font-size:0.8rem;opacity:0.4;">🔍</span>
                        </div>
                        <div id="sp-search-results" style="max-height:280px;overflow-y:auto;"></div>
                    </div>
                    <!-- Queue Panel -->
                    <div id="sp-panel-queue" style="display:none;">
                        <div id="sp-queue-list" style="max-height:320px;overflow-y:auto;">
                            <div style="font-size:0.78rem;color:var(--clarity-dim);padding:1rem;text-align:center;">Play something to see your queue</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <div class="flow-divider"></div>

    <!-- COMMS (Water) — moved up -->

    <!-- Memory Modal -->
    <div class="mem-modal-overlay" id="mem-modal-overlay" onclick="if(event.target===this)memCloseModal()">
        <div class="mem-modal">
            <div class="mem-modal-title" id="mem-modal-title">New Memory</div>
            <input type="hidden" id="mem-edit-id">
            <select id="mem-modal-cat" onchange="if(this.value==='__custom__'){document.getElementById('mem-custom-cat').style.display='block';document.getElementById('mem-custom-cat').focus();}else{document.getElementById('mem-custom-cat').style.display='none';}">
                <option value="General">General</option>
                <option value="Credentials">Credentials</option>
                <option value="Contacts">Contacts</option>
                <option value="Jobs">Jobs</option>
                <option value="Ideas">Ideas</option>
                <option value="Code">Code</option>
                <option value="Files">Files</option>
                <option value="__custom__">+ New Category...</option>
            </select>
            <input type="text" id="mem-custom-cat" placeholder="Custom category name" style="display:none;">
            <input type="text" id="mem-modal-title-input" placeholder="Title">
            <textarea id="mem-modal-content" placeholder="Content — notes, links, details..."></textarea>
            <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.78rem;color:var(--clarity-muted);margin-bottom:0.5rem;cursor:pointer;">
                <input type="checkbox" id="mem-modal-pinned"> Pin to top
            </label>
            <div class="mem-modal-btns">
                <button class="mem-modal-btn cancel" onclick="memCloseModal()">Cancel</button>
                <button class="mem-modal-btn save" onclick="memSave()">Save</button>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="mem-modal-overlay" id="contact-modal-overlay" onclick="if(event.target===this)contactCloseModal()">
        <div class="mem-modal">
            <div class="mem-modal-title" id="contact-modal-title">New Contact</div>
            <input type="hidden" id="contact-edit-id">
            <input type="text" id="contact-modal-name" placeholder="Name">
            <input type="tel" id="contact-modal-phone" placeholder="Phone number">
            <input type="email" id="contact-modal-email" placeholder="Email">
            <select id="contact-modal-role">
                <option value="Customer">Customer</option>
                <option value="Crew">Crew</option>
                <option value="Vendor">Vendor</option>
                <option value="Partner">Partner</option>
                <option value="Friend">Friend</option>
            </select>
            <textarea id="contact-modal-notes" placeholder="Notes (optional)" style="min-height:60px;"></textarea>
            <div class="mem-modal-btns">
                <button class="mem-modal-btn cancel" onclick="contactCloseModal()">Cancel</button>
                <button class="mem-modal-btn save" onclick="contactSave()">Save</button>
            </div>
        </div>
    </div>

    <div class="flow-divider"></div>

    <!-- COMMS (Water) -->
    <section>
        <div class="section-label">Communications</div>
        <div class="card" style="padding:0;overflow:hidden;">
            <div class="comms-hub">
                <!-- Channel sidebar -->
                <div class="comms-channels">
                    <div class="comms-channels-head">Channels</div>
                    <div class="comms-channel-list" id="comms-channel-list"></div>
                    <div class="comms-add-channel">
                        <input type="text" class="comms-add-input" id="comms-new-channel" placeholder="+ New channel">
                    </div>
                    <div class="comms-customer-section">
                        <div class="comms-customer-head">Customer Comms</div>
                        <div class="comms-channel-list" id="comms-customer-list"></div>
                        <div class="comms-add-channel">
                            <input type="text" class="comms-add-input" id="comms-new-customer" placeholder="+ New customer thread">
                        </div>
                    </div>
                    <div class="voice-section">
                        <div class="voice-section-head">Voice</div>
                        <div id="voice-panel-idle" class="voice-panel">
                            <div class="voice-code-gen">
                                <div class="voice-code-display" id="voice-code-display">——</div>
                                <button class="voice-gen-btn" onclick="voiceGenerateCode()">Generate Code</button>
                                <button class="voice-copy-code-btn" id="voice-copy-idle-btn" onclick="voiceCopyIdleCode()" style="display:none;">Copy</button>
                            </div>
                            <div style="margin:0.6rem 0 0.3rem;font-size:0.6rem;color:var(--clarity-dim);text-transform:uppercase;letter-spacing:0.1em;font-weight:600;">Join or Host</div>
                            <input type="text" class="comms-add-input" id="voice-room-input" placeholder="Paste room code here" style="margin-bottom:0.4rem;">
                            <div style="display:flex;gap:0.4rem;">
                                <button class="voice-btn voice-join" onclick="voiceJoin()">Join Room</button>
                                <button class="voice-btn voice-create" onclick="voiceHostGenerated()">Host Room</button>
                            </div>
                        </div>
                        <div id="voice-panel-active" class="voice-panel" style="display:none;">
                            <div class="voice-room-info">
                                <span class="voice-room-label">Room:</span>
                                <span class="voice-room-code" id="voice-room-code"></span>
                                <button class="voice-copy-btn" onclick="voiceCopyCode()" title="Copy code">Copy</button>
                            </div>
                            <div class="voice-status" id="voice-status">Connecting...</div>
                            <div class="voice-users" id="voice-users"></div>
                            <div class="voice-controls">
                                <button class="voice-ctrl" id="voice-mute-btn" onclick="voiceToggleMute()" title="Mute">Mute</button>
                                <button class="voice-ctrl" id="voice-video-btn" onclick="voiceToggleVideo()" title="Camera">Cam</button>
                                <button class="voice-ctrl" id="voice-screen-btn" onclick="voiceToggleScreen()" title="Screen Share">Screen</button>
                                <button class="voice-ctrl voice-leave" onclick="voiceLeave()" title="Disconnect">Leave</button>
                            </div>
                            <div class="voice-videos" id="voice-videos">
                                <video id="voice-local-video" class="voice-video" autoplay muted playsinline style="display:none;"></video>
                            </div>
                            <div class="voice-visualizer" id="voice-visualizer">
                                <canvas id="voice-canvas" width="180" height="30"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Message area -->
                <div class="comms-main">
                    <div class="comms-main-head">
                        <span class="comms-main-title" id="comms-main-title">Select a channel</span>
                        <span class="comms-main-count" id="comms-main-count"></span>
                        <button class="comms-pin-btn" id="comms-pin-btn" onclick="commsTogglePin()" title="Pin message">Pin</button>
                        <button class="comms-del-channel-btn" id="comms-del-ch-btn" onclick="commsDeleteChannel()" title="Delete channel">Delete</button>
                    </div>
                    <div class="comms-pinned" id="comms-pinned"></div>
                    <div class="comms-messages" id="comms-messages">
                        <div class="comms-empty">Pick a channel to start</div>
                    </div>
                    <div class="comms-compose" id="comms-compose" style="display:none;">
                        <input type="text" class="comms-compose-input" id="comms-msg-input" placeholder="Type a message...">
                        <button class="comms-compose-send" onclick="commsSend()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="flow-divider"></div>

    <!-- WORK -->
    <section>
        <div class="section-label">Work</div>
        <div class="widgets-grid">

            <!-- TASKS -->
            <div class="widget widget-span-4" id="tasks-widget">
                <div class="widget-head">
                    <span class="w-icon">✅</span> Tasks
                    <div class="widget-head-right">
                        <span style="font-size:0.65rem;color:var(--clarity-dim);letter-spacing:0.05em;text-transform:none;">Total Points:</span>
                        <span class="todo-score" id="todo-score">0</span>
                    </div>
                </div>
                <div class="todo-input-row">
                    <input type="text" class="todo-input" id="todo-input" placeholder="What needs to get done?">
                    <select class="todo-priority-select" id="todo-priority">
                        <option value="5">Critical — 5 pts</option>
                        <option value="3">High — 3 pts</option>
                        <option value="2" selected>Medium — 2 pts</option>
                        <option value="1">Low — 1 pt</option>
                    </select>
                    <button class="todo-add-btn" onclick="todoAdd()">+</button>
                </div>
                <div class="todo-columns">
                    <div>
                        <div class="todo-column-label">Active</div>
                        <ul class="todo-list" id="todo-list-active"></ul>
                    </div>
                    <div>
                        <div class="todo-column-label">Completed</div>
                        <ul class="todo-list" id="todo-list-done"></ul>
                    </div>
                </div>
                <div class="todo-footer">
                    <span id="todo-count">0 tasks remaining</span>
                    <button class="todo-clear" onclick="todoClearDone()">Clear completed</button>
                </div>
            </div>

            <!-- CALENDAR -->
            <div class="widget widget-span-4" id="cal-widget">
                <div class="widget-head"><span class="w-icon">📅</span> Calendar</div>
                <div class="cal-container">
                    <div class="cal-month-area">
                        <div class="cal-month-nav">
                            <button class="cal-nav-btn" onclick="calPrev()">&larr;</button>
                            <span class="cal-month-title" id="cal-month-title"></span>
                            <button class="cal-today-btn" onclick="calToday()">Today</button>
                            <button class="cal-nav-btn" onclick="calNext()">&rarr;</button>
                        </div>
                        <div class="cal-grid" id="cal-grid"></div>
                    </div>
                    <div class="cal-sidebar">
                        <div class="cal-sidebar-date" id="cal-sidebar-date">Select a day</div>
                        <ul class="cal-sidebar-events" id="cal-sidebar-events">
                            <li class="cal-sidebar-empty">Click a day to view events</li>
                        </ul>
                        <div class="cal-add-form">
                            <div class="cal-add-row">
                                <input type="text" class="cal-input" id="cal-title" placeholder="Job / event name">
                                <input type="time" class="cal-input" id="cal-time" style="max-width:100px;">
                            </div>
                            <div class="cal-add-row">
                                <input type="text" class="cal-input" id="cal-crew" placeholder="Crew — who's working? (optional)">
                                <button class="cal-add-btn" onclick="calAdd()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Business Finance Dashboard -->
            <div class="widget widget-span-4" id="biz-finance-widget">
                <div class="widget-head">
                    <span class="w-icon">💼</span> Business Finance
                    <div class="widget-head-right">
                        <button class="ops-btn" id="hcp-sync-btn" onclick="hcpSync()" style="font-size:0.65rem;padding:0.25rem 0.6rem;display:none;">Sync HCP</button>
                        <button class="ops-btn" id="hcp-cust-sync-btn" onclick="hcpSyncCustomers()" style="font-size:0.65rem;padding:0.25rem 0.6rem;display:none;">Sync Customers</button>
                        <button class="ops-btn" id="hcp-connect-btn" onclick="hcpConnect()" style="font-size:0.65rem;padding:0.25rem 0.6rem;">Connect HCP</button>
                    </div>
                </div>

                <!-- Tab Bar -->
                <div class="biz-tabs" id="biz-tabs">
                    <button class="biz-tab active" onclick="bizTab('overview')">Overview</button>
                    <button class="biz-tab" onclick="bizTab('jobs')">Jobs</button>
                    <button class="biz-tab" onclick="bizTab('costs')">Costs</button>
                    <button class="biz-tab" onclick="bizTab('adspend')">Ad Spend</button>
                </div>

                <!-- OVERVIEW TAB -->
                <div class="biz-tab-content active" id="biz-panel-overview">
                    <div class="biz-overview-grid" id="biz-overview-grid">
                        <div class="biz-overview-card revenue"><div class="biz-overview-label">Revenue</div><div class="biz-overview-val" id="biz-revenue">$0</div></div>
                        <div class="biz-overview-card deposits"><div class="biz-overview-label">Deposits</div><div class="biz-overview-val" id="biz-deposits">$0</div></div>
                        <div class="biz-overview-card costs"><div class="biz-overview-label">Costs</div><div class="biz-overview-val" id="biz-costs">$0</div></div>
                        <div class="biz-overview-card ads"><div class="biz-overview-label">Ad Spend</div><div class="biz-overview-val" id="biz-adspend">$0</div></div>
                        <div class="biz-overview-card profit"><div class="biz-overview-label">Profit</div><div class="biz-overview-val" id="biz-profit">$0</div></div>
                        <div class="biz-overview-card jobs"><div class="biz-overview-label">Jobs</div><div class="biz-overview-val" id="biz-jobcount">0</div></div>
                    </div>
                    <div class="biz-section-title">Cost Breakdown</div>
                    <div class="biz-bar-chart" id="biz-bar-chart"></div>
                </div>

                <!-- JOBS TAB -->
                <div class="biz-tab-content" id="biz-panel-jobs">
                    <div class="job-pipeline" id="job-pipeline">
                        <button class="job-pipeline-btn active" onclick="jobFilterStatus('all')">All: <span class="count" id="job-count-all">0</span></button>
                        <button class="job-pipeline-btn" onclick="jobFilterStatus('scheduled')">Scheduled: <span class="count" id="job-count-scheduled">0</span></button>
                        <button class="job-pipeline-btn" onclick="jobFilterStatus('in_progress')">In Progress: <span class="count" id="job-count-in_progress">0</span></button>
                        <button class="job-pipeline-btn" onclick="jobFilterStatus('completed')">Completed: <span class="count" id="job-count-completed">0</span></button>
                        <button class="job-pipeline-btn" onclick="jobFilterStatus('paid')">Paid: <span class="count" id="job-count-paid">0</span></button>
                    </div>
                    <div class="job-add-row">
                        <input type="text" class="exp-input" id="job-customer" placeholder="Customer name">
                        <input type="text" class="exp-input" id="job-desc" placeholder="Description">
                        <input type="number" class="exp-input" id="job-price" placeholder="Price" style="max-width:90px;" step="0.01">
                        <input type="number" class="exp-input" id="job-deposit" placeholder="Deposit" style="max-width:80px;" step="0.01">
                        <input type="date" class="exp-input" id="job-date" style="max-width:130px;">
                        <button class="todo-add-btn" onclick="jobAdd()">+</button>
                    </div>
                    <div class="job-list" id="job-list"></div>
                </div>

                <!-- COSTS TAB -->
                <div class="biz-tab-content" id="biz-panel-costs">
                    <div class="exp-add-row">
                        <input type="number" class="exp-input" id="exp-amount" placeholder="Amount" style="max-width:100px;" step="0.01">
                        <input type="text" class="exp-input" id="exp-desc" placeholder="Description">
                        <select class="exp-select" id="exp-cat">
                            <option value="Fuel">Fuel</option>
                            <option value="Supplies">Supplies</option>
                            <option value="Food">Food</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Crew Pay">Crew Pay</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Vehicle/Gas">Vehicle/Gas</option>
                            <option value="Storage">Storage</option>
                            <option value="Software/Subscriptions">Software/Subs</option>
                            <option value="Other">Other</option>
                        </select>
                        <button class="todo-add-btn" onclick="expAdd()">+</button>
                    </div>
                    <select class="biz-cat-filter" id="cost-cat-filter" onchange="expRender()">
                        <option value="all">All Categories</option>
                        <option value="Fuel">Fuel</option>
                        <option value="Supplies">Supplies</option>
                        <option value="Food">Food</option>
                        <option value="Equipment">Equipment</option>
                        <option value="Crew Pay">Crew Pay</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Vehicle/Gas">Vehicle/Gas</option>
                        <option value="Storage">Storage</option>
                        <option value="Software/Subscriptions">Software/Subs</option>
                        <option value="Other">Other</option>
                    </select>
                    <div class="exp-list" id="exp-list"></div>
                </div>

                <!-- AD SPEND TAB -->
                <div class="biz-tab-content" id="biz-panel-adspend">
                    <div class="ad-summary" id="ad-summary">
                        <div class="ad-summary-card"><div class="ad-summary-label">Total Spent</div><div class="ad-summary-val" id="ad-total">$0</div></div>
                        <div class="ad-summary-card"><div class="ad-summary-label">Leads</div><div class="ad-summary-val" id="ad-leads">0</div></div>
                        <div class="ad-summary-card"><div class="ad-summary-label">Cost / Lead</div><div class="ad-summary-val" id="ad-cpl">$0</div></div>
                    </div>
                    <div class="ad-add-row">
                        <select class="exp-select" id="ad-platform">
                            <option value="Ad — Google">Google</option>
                            <option value="Ad — Yelp">Yelp</option>
                            <option value="Ad — Thumbtack">Thumbtack</option>
                            <option value="Ad — Facebook">Facebook</option>
                            <option value="Ad — Other">Other</option>
                        </select>
                        <input type="number" class="exp-input" id="ad-amount" placeholder="Amount" style="max-width:90px;" step="0.01">
                        <input type="number" class="exp-input" id="ad-leads-input" placeholder="Leads" style="max-width:70px;">
                        <input type="text" class="exp-input" id="ad-desc" placeholder="Note (optional)">
                        <button class="todo-add-btn" onclick="adAdd()">+</button>
                    </div>
                    <div class="ad-platform-badges" id="ad-badges"></div>
                    <div class="ad-list" id="ad-list"></div>
                </div>
            </div>

            <!-- Investment Tracker -->
            <div class="widget widget-span-4" id="investment-widget">
                <div class="widget-head">
                    <span class="w-icon">📈</span> Investment Tracker
                    <div class="widget-head-right">
                        <button class="ops-btn" onclick="invRefreshPrices()" style="font-size:0.65rem;padding:0.25rem 0.6rem;" id="inv-refresh-btn">Refresh Prices</button>
                        <button class="todo-add-btn" onclick="invOpenModal()" style="width:28px;height:28px;font-size:0.9rem;border-radius:50%;">+</button>
                    </div>
                </div>
                <div class="inv-summary">
                    <div class="inv-stat invested"><div class="inv-stat-label">Total Invested</div><div class="inv-stat-val" id="inv-invested">$0</div></div>
                    <div class="inv-stat value"><div class="inv-stat-label">Current Value</div><div class="inv-stat-val" id="inv-value">$0</div></div>
                    <div class="inv-stat roi"><div class="inv-stat-label">Total ROI</div><div class="inv-stat-val" id="inv-roi">0%</div></div>
                </div>
                <div class="inv-tabs" id="inv-tabs">
                    <button class="inv-tab active" onclick="invFilter('all')">All</button>
                    <button class="inv-tab" onclick="invFilter('crypto')">Crypto</button>
                    <button class="inv-tab" onclick="invFilter('stock')">Stocks</button>
                    <button class="inv-tab" onclick="invFilter('business')">Business</button>
                    <button class="inv-tab" onclick="invFilter('real_estate')">Real Estate</button>
                </div>
                <div class="inv-list" id="inv-list"></div>
            </div>

            <!-- Investment Modal -->
            <div class="inv-modal-overlay" id="inv-modal">
                <div class="inv-modal">
                    <div class="inv-modal-title" id="inv-modal-title">Add Investment</div>
                    <label>Name</label>
                    <input type="text" id="inv-name" placeholder="Bitcoin, AAPL, Work Van, Rental Property...">
                    <div class="inv-modal-row">
                        <div>
                            <label>Type</label>
                            <select id="inv-type">
                                <option value="crypto">Crypto</option>
                                <option value="stock">Stock</option>
                                <option value="business">Business</option>
                                <option value="real_estate">Real Estate</option>
                            </select>
                        </div>
                        <div>
                            <label>Ticker (optional)</label>
                            <input type="text" id="inv-ticker" placeholder="BTC, AAPL, etc.">
                        </div>
                    </div>
                    <div class="inv-modal-row">
                        <div>
                            <label>Amount Invested ($)</label>
                            <input type="number" id="inv-amount" placeholder="0.00" step="0.01">
                        </div>
                        <div>
                            <label>Current Value ($)</label>
                            <input type="number" id="inv-current" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                    <div class="inv-modal-row">
                        <div>
                            <label>Quantity (optional)</label>
                            <input type="number" id="inv-qty" placeholder="Shares, coins, units" step="any">
                        </div>
                        <div>
                            <label>Date Acquired</label>
                            <input type="date" id="inv-date">
                        </div>
                    </div>
                    <label>Notes (optional)</label>
                    <input type="text" id="inv-notes" placeholder="Any notes...">
                    <input type="hidden" id="inv-edit-id">
                    <div class="inv-modal-btns">
                        <button class="mem-modal-btn cancel" onclick="invCloseModal()">Cancel</button>
                        <button class="mem-modal-btn save" onclick="invSave()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Contacts / Quick Dial -->
            <div class="widget widget-span-2" id="contacts-widget">
                <div class="widget-head">
                    <span class="w-icon">📇</span> Contacts
                    <div class="widget-head-right"><button class="todo-add-btn" onclick="contactOpenModal()" style="width:28px;height:28px;font-size:0.9rem;border-radius:50%;">+</button></div>
                </div>
                <input type="text" class="contacts-search" id="contacts-search" placeholder="Search contacts..." oninput="contactRender()">
                <div class="contacts-list" id="contacts-list"></div>
            </div>

            <!-- Notes -->
            <div class="widget widget-span-2">
                <div class="widget-head"><span class="w-icon">📝</span> Quick Notes</div>
                <textarea class="notes-area" id="notes-area" placeholder="Jot down thoughts, ideas, reminders..."></textarea>
                <div class="notes-saved" id="notes-saved"></div>
            </div>

        </div>
    </section>

    <div class="flow-divider"></div>

    <!-- TOOLS & MORE -->
    <section>
        <div class="section-label">Tools</div>
        <div class="widgets-grid">

            <!-- Memory Vault -->
            <div class="widget widget-span-4" id="memory-widget">
                <div class="widget-head"><span class="w-icon">🧠</span> Memory Vault</div>
                <div class="mem-toolbar">
                    <input type="text" class="mem-search" id="mem-search" placeholder="Search memories..." oninput="memRender()">
                    <select class="mem-cat-filter" id="mem-cat-filter" onchange="memRender()">
                        <option value="">All Categories</option>
                    </select>
                    <button class="mem-add-btn" onclick="memOpenModal()" title="Add memory">+</button>
                </div>
                <div class="mem-grid" id="mem-grid"></div>
            </div>

            <!-- Denver Area Map -->
            <div class="widget widget-span-4" id="map-widget">
                <div class="widget-head">
                    <span class="w-icon">🗺️</span> Denver Area Map
                    <span class="map-badge" id="map-badge"><span class="map-badge-dot"></span> <span id="map-badge-text">Online</span></span>
                </div>
                <div class="map-search-row">
                    <input type="text" class="map-search-input" id="map-search" placeholder="Search addresses, cities, zip codes..." oninput="mapSearch(this.value)" onfocus="mapSearch(this.value)" onkeydown="if(event.key==='Enter')mapSearchGo()" autocomplete="off">
                    <button class="todo-add-btn" onclick="mapSearchGo()" style="width:36px;" title="Search">🔍</button>
                </div>
                <div class="map-search-results">
                    <div class="map-search-dropdown" id="map-dropdown"></div>
                </div>
                <div class="map-filters" id="map-filters">
                    <button class="map-filter-btn active" onclick="mapFilter('All')">All</button>
                    <button class="map-filter-btn" onclick="mapFilter('Job Sites')">Job Sites</button>
                    <button class="map-filter-btn" onclick="mapFilter('Customers')">Customers</button>
                    <button class="map-filter-btn" onclick="mapFilter('Warehouses')">Warehouses</button>
                    <button class="map-filter-btn" onclick="mapFilter('Storage')">Storage</button>
                    <button class="map-filter-btn" onclick="mapFilter('Landmarks')">Landmarks</button>
                </div>
                <div class="map-container" id="map-container"></div>
                <div style="display:flex;align-items:center;justify-content:space-between;margin-top:0.5rem;">
                    <span style="font-size:0.7rem;color:var(--clarity-dim);">Saved Locations</span>
                    <span style="font-size:0.65rem;color:var(--clarity-dim);" id="map-count">0 locations</span>
                </div>
                <div class="map-saved-list" id="map-saved-list"></div>
            </div>

            <!-- Map Save Modal -->
            <div class="map-modal-overlay" id="map-modal">
                <div class="map-modal">
                    <h3>Save Location</h3>
                    <label>Name</label>
                    <input type="text" id="map-save-name" placeholder="Location name">
                    <label>Address</label>
                    <input type="text" id="map-save-address" placeholder="Address (optional)">
                    <label>Category</label>
                    <select id="map-save-cat">
                        <option value="General">General</option>
                        <option value="Job Sites">Job Sites</option>
                        <option value="Customers">Customers</option>
                        <option value="Warehouses">Warehouses</option>
                        <option value="Storage">Storage</option>
                        <option value="Landmarks">Landmarks</option>
                    </select>
                    <label>Notes</label>
                    <textarea id="map-save-notes" placeholder="Notes (optional)"></textarea>
                    <input type="hidden" id="map-save-lat">
                    <input type="hidden" id="map-save-lng">
                    <div class="map-modal-btns">
                        <button class="map-modal-btn" onclick="mapCloseModal()">Cancel</button>
                        <button class="map-modal-btn primary" onclick="mapSaveLocation()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Weather -->
            <div class="widget">
                <div class="widget-head"><span class="w-icon">🌤</span> Weather</div>
                <div id="weather-content"><div class="weather-loading">Locating...</div></div>
            </div>

            <!-- Services -->
            <div class="widget">
                <div class="widget-head"><span class="w-icon">📡</span> Services</div>
                <ul class="status-list" id="status-list"></ul>
                <button class="status-refresh" onclick="checkAllServices()">Refresh</button>
            </div>

            <!-- Calculator -->
            <div class="widget">
                <div class="widget-head"><span class="w-icon">🧮</span> Calculator</div>
                <div class="calc-display" id="calc-display">0</div>
                <div class="calc-grid">
                    <button class="calc-btn clear" onclick="calcClear()">C</button>
                    <button class="calc-btn op" onclick="calcInput('(')">(</button>
                    <button class="calc-btn op" onclick="calcInput(')')">)</button>
                    <button class="calc-btn op" onclick="calcInput('/')">÷</button>
                    <button class="calc-btn" onclick="calcInput('7')">7</button>
                    <button class="calc-btn" onclick="calcInput('8')">8</button>
                    <button class="calc-btn" onclick="calcInput('9')">9</button>
                    <button class="calc-btn op" onclick="calcInput('*')">×</button>
                    <button class="calc-btn" onclick="calcInput('4')">4</button>
                    <button class="calc-btn" onclick="calcInput('5')">5</button>
                    <button class="calc-btn" onclick="calcInput('6')">6</button>
                    <button class="calc-btn op" onclick="calcInput('-')">−</button>
                    <button class="calc-btn" onclick="calcInput('1')">1</button>
                    <button class="calc-btn" onclick="calcInput('2')">2</button>
                    <button class="calc-btn" onclick="calcInput('3')">3</button>
                    <button class="calc-btn op" onclick="calcInput('+')">+</button>
                    <button class="calc-btn" onclick="calcInput('0')">0</button>
                    <button class="calc-btn" onclick="calcInput('.')">.</button>
                    <button class="calc-btn" onclick="calcBackspace()">⌫</button>
                    <button class="calc-btn eq" onclick="calcEval()">=</button>
                </div>
            </div>

        </div>
    </section>

    <div class="flow-divider"></div>

    <!-- GOOGLE DRIVE -->
    <section>
        <div class="section-label">Google Drive</div>
        <div class="card" style="padding:1.25rem;">
            <div class="drive-toolbar">
                <div class="drive-breadcrumb" id="drive-breadcrumb">
                    <button class="drive-crumb" onclick="driveNav('/')">My Drive</button>
                </div>
                <a href="https://drive.google.com/drive/folders/1l620CCNKDLUGgyHjGS98XuR8Dn9jmalR" target="_blank" class="drive-action-btn">Trinity Comms</a>
                <a href="https://drive.google.com" target="_blank" class="drive-action-btn primary">Open Drive</a>
            </div>
            <div class="drive-list" id="drive-list"></div>
            <div class="drive-synced" id="drive-synced"></div>
        </div>
    </section>

    <div class="flow-divider"></div>

    <!-- BOOKMARKS (Metal) -->
    <section>
        <div class="section-label">Bookmarks</div>
        <div class="card" style="padding:1.5rem;">
            <div class="bookmark-category">Operations</div>
            <div class="bookmarks-grid">
                <a href="https://pro.housecallpro.com" target="_blank" class="bookmark"><div class="bookmark-icon">🏠</div><div class="bookmark-info"><div class="bookmark-name">Housecall Pro</div><div class="bookmark-url">pro.housecallpro.com</div></div></a>
                <a href="https://zapier.com/app/dashboard" target="_blank" class="bookmark"><div class="bookmark-icon">⚡</div><div class="bookmark-info"><div class="bookmark-name">Zapier</div><div class="bookmark-url">zapier.com</div></div></a>
            </div>
            <div class="bookmark-category">Development & Hosting</div>
            <div class="bookmarks-grid">
                <a href="https://github.com/handsonnewfurniture-arch" target="_blank" class="bookmark"><div class="bookmark-icon">🐙</div><div class="bookmark-info"><div class="bookmark-name">GitHub</div><div class="bookmark-url">github.com</div></div></a>
                <a href="https://railway.com/project/97faa02d-53ca-4f31-be2e-439889355ccf" target="_blank" class="bookmark"><div class="bookmark-icon">🚂</div><div class="bookmark-info"><div class="bookmark-name">Railway</div><div class="bookmark-url">railway.com</div></div></a>
                <a href="https://app.netlify.com/teams/overkor-tek/" target="_blank" class="bookmark"><div class="bookmark-icon">🌐</div><div class="bookmark-info"><div class="bookmark-name">Netlify</div><div class="bookmark-url">app.netlify.com</div></div></a>
            </div>
            <div class="bookmark-category">Sites & Dashboards</div>
            <div class="bookmarks-grid">
                <a href="https://conciousnessrevolution.io" target="_blank" class="bookmark"><div class="bookmark-icon">🔮</div><div class="bookmark-info"><div class="bookmark-name">Consciousness Revolution</div><div class="bookmark-url">conciousnessrevolution.io</div></div></a>
                <a href="https://trinity-consciousness.netlify.app" target="_blank" class="bookmark"><div class="bookmark-icon">🔺</div><div class="bookmark-info"><div class="bookmark-name">Trinity Consciousness</div><div class="bookmark-url">trinity-consciousness.netlify.app</div></div></a>
                <a href="https://napoleonstubrochargedmemes.netlify.app" target="_blank" class="bookmark"><div class="bookmark-icon">🎭</div><div class="bookmark-info"><div class="bookmark-name">Turbo Charged Memes</div><div class="bookmark-url">napoleonstubrochargedmemes.netlify.app</div></div></a>
                <a href="https://cockpit-hq.netlify.app" target="_blank" class="bookmark"><div class="bookmark-icon">🎯</div><div class="bookmark-info"><div class="bookmark-name">Mission Cockpit</div><div class="bookmark-url">cockpit-hq.netlify.app</div></div></a>
            </div>
            <div class="bookmark-category">Communication</div>
            <div class="bookmarks-grid">
                <a href="https://drive.google.com/drive/folders/1l620CCNKDLUGgyHjGS98XuR8Dn9jmalR" target="_blank" class="bookmark"><div class="bookmark-icon">📁</div><div class="bookmark-info"><div class="bookmark-name">Trinity Comms (Drive)</div><div class="bookmark-url">drive.google.com</div></div></a>
                <a href="https://mail.google.com" target="_blank" class="bookmark"><div class="bookmark-icon">✉️</div><div class="bookmark-info"><div class="bookmark-name">Gmail</div><div class="bookmark-url">mail.google.com</div></div></a>
            </div>
        </div>
    </section>

    <footer style="text-align:center;padding:1.5rem 0 0;color:var(--clarity-dim);font-size:0.7rem;font-family:'JetBrains Mono',monospace;letter-spacing:0.05em;">
        COMMAND COCKPIT v2.2 — Overkor Tek
    </footer>
</div>

<script>
// =============================================
// SUPABASE INIT
// =============================================
var SB_URL='https://hzcgpuctetpfmxisehhe.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6Y2dwdWN0ZXRwZm14aXNlaGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNDgxMDIsImV4cCI6MjA4MzcyNDEwMn0.r-W8ImGAwW1OIGl6KKx6vRK4JRnB4x5-3c2JTwl75LU';
var sb=supabase.createClient(SB_URL,SB_KEY);

// =============================================
// UTILITIES
// =============================================
function escapeHtml(t) { var d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

// =============================================
// CLOCK
// =============================================
function updateClock() {
    document.getElementById('clock').textContent = new Date().toLocaleDateString('en-US', {
        weekday:'long', year:'numeric', month:'long', day:'numeric'
    });
}
updateClock();

// =============================================
// ROTATING COLORADO ROCKY MOUNTAIN BACKGROUNDS
// =============================================
var BG_IMAGES = [
    'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80',
    'https://images.unsplash.com/photo-1472396961693-142e6e269027?w=1920&q=80',
    'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1920&q=80',
    'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?w=1920&q=80',
    'https://images.unsplash.com/photo-1509316975850-ff9c5deb0cd9?w=1920&q=80',
    'https://images.unsplash.com/photo-1508739773434-c26b3d09e071?w=1920&q=80',
    'https://images.unsplash.com/photo-1485470733090-0aae1788d668?w=1920&q=80',
    'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=1920&q=80'
];
var bgIndex = Math.floor(Math.random() * BG_IMAGES.length);
function setBg() {
    document.body.style.backgroundImage = 'linear-gradient(180deg, rgba(10,5,20,0.4) 0%, rgba(10,5,20,0.2) 40%, rgba(10,5,20,0.1) 60%, rgba(10,5,20,0.35) 100%), url(' + BG_IMAGES[bgIndex] + ')';
}
function nextBg() {
    bgIndex = (bgIndex + 1) % BG_IMAGES.length;
    setBg();
}
setBg();
setInterval(nextBg, 120000);

// =============================================
// TASKS — Supabase-backed
// =============================================
var PRI_LABELS = { 5: 'CRITICAL', 3: 'HIGH', 2: 'MED', 1: 'LOW' };
var PRI_CLASS  = { 5: 'p5', 3: 'p3', 2: 'p2', 1: 'p1' };

async function todoAdd() {
    var input = document.getElementById('todo-input');
    var text = input.value.trim();
    if (!text) return;
    var pts = parseInt(document.getElementById('todo-priority').value);
    await sb.from('cockpit_todos').insert({text:text,done:false,pts:pts});
    input.value = '';
    renderTodos();
}

async function todoToggle(id) {
    var {data}=await sb.from('cockpit_todos').select('done').eq('id',id).single();
    if(data) await sb.from('cockpit_todos').update({done:!data.done}).eq('id',id);
    renderTodos();
}

async function todoDelete(id) {
    await sb.from('cockpit_todos').delete().eq('id',id);
    renderTodos();
}

async function todoClearDone() {
    await sb.from('cockpit_todos').delete().eq('done',true);
    renderTodos();
}

async function renderTodos() {
    var {data:todos}=await sb.from('cockpit_todos').select('*').order('pts',{ascending:false});
    todos=todos||[];
    var active = todos.filter(function(t) { return !t.done; });
    var done = todos.filter(function(t) { return t.done; });

    function renderItem(t) {
        return '<li class="todo-item' + (t.done ? ' done' : '') + '">' +
            '<div class="todo-check" onclick="todoToggle(' + t.id + ')">' + (t.done ? '✓' : '') + '</div>' +
            '<span class="todo-text">' + escapeHtml(t.text) + '</span>' +
            '<span class="todo-pts ' + PRI_CLASS[t.pts] + '">' + t.pts + 'pt' + (t.pts > 1 ? 's' : '') + ' · ' + PRI_LABELS[t.pts] + '</span>' +
            '<button class="todo-delete" onclick="todoDelete(' + t.id + ')">×</button>' +
        '</li>';
    }

    document.getElementById('todo-list-active').innerHTML = active.length ?
        active.map(renderItem).join('') :
        '<li style="color:var(--clarity-dim);font-size:0.78rem;padding:0.5rem 0;font-style:italic;">No active tasks</li>';
    document.getElementById('todo-list-done').innerHTML = done.length ?
        done.map(renderItem).join('') :
        '<li style="color:var(--clarity-dim);font-size:0.78rem;padding:0.5rem 0;font-style:italic;">Nothing completed yet</li>';

    var totalPts = active.reduce(function(s, t) { return s + t.pts; }, 0);
    var earnedPts = done.reduce(function(s, t) { return s + t.pts; }, 0);
    document.getElementById('todo-score').textContent = earnedPts + ' / ' + (totalPts + earnedPts);
    document.getElementById('todo-count').textContent = active.length + ' task' + (active.length !== 1 ? 's' : '') + ' remaining · ' + totalPts + ' pts to go';
}

document.getElementById('todo-input').addEventListener('keydown', function(e) { if (e.key === 'Enter') todoAdd(); });
renderTodos();

// =============================================
// CALENDAR — Supabase-backed
// =============================================
var calViewYear, calViewMonth, calSelectedDate;

function calInit() {
    var now = new Date();
    calViewYear = now.getFullYear();
    calViewMonth = now.getMonth();
    calSelectedDate = formatDate(now);
    renderCal();
}

function formatDate(d) {
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function calPrev() { calViewMonth--; if (calViewMonth < 0) { calViewMonth = 11; calViewYear--; } renderCal(); }
function calNext() { calViewMonth++; if (calViewMonth > 11) { calViewMonth = 0; calViewYear++; } renderCal(); }
function calToday() { var n = new Date(); calViewYear = n.getFullYear(); calViewMonth = n.getMonth(); calSelectedDate = formatDate(n); renderCal(); }

function calSelectDay(dateStr) {
    calSelectedDate = dateStr;
    renderCal();
}

async function calAdd() {
    var title = document.getElementById('cal-title').value.trim();
    var time = document.getElementById('cal-time').value;
    var crew = document.getElementById('cal-crew').value.trim();
    if (!title || !calSelectedDate) return;
    await sb.from('cockpit_calendar').insert({title:title,date:calSelectedDate,time:time||'',crew:crew||''});
    document.getElementById('cal-title').value = '';
    document.getElementById('cal-time').value = '';
    document.getElementById('cal-crew').value = '';
    renderCal();
}

async function calDelete(id) {
    await sb.from('cockpit_calendar').delete().eq('id',id);
    renderCal();
}

async function renderCal() {
    var MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    var DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    var {data:events}=await sb.from('cockpit_calendar').select('*').order('date').order('time');
    events=events||[];
    var todayStr = formatDate(new Date());

    // Build event lookup
    var eventMap = {};
    events.forEach(function(e) {
        if (!eventMap[e.date]) eventMap[e.date] = [];
        eventMap[e.date].push(e);
    });

    // Month title
    document.getElementById('cal-month-title').textContent = MONTHS[calViewMonth] + ' ' + calViewYear;

    // Build grid
    var grid = document.getElementById('cal-grid');
    var html = '';

    // Day of week headers
    DAYS.forEach(function(d) {
        html += '<div class="cal-dow">' + d + '</div>';
    });

    // First day of month
    var firstDay = new Date(calViewYear, calViewMonth, 1);
    var startDow = firstDay.getDay();
    var daysInMonth = new Date(calViewYear, calViewMonth + 1, 0).getDate();

    // Previous month fill
    var prevMonthDays = new Date(calViewYear, calViewMonth, 0).getDate();
    for (var i = startDow - 1; i >= 0; i--) {
        var pDay = prevMonthDays - i;
        var pMonth = calViewMonth === 0 ? 12 : calViewMonth;
        var pYear = calViewMonth === 0 ? calViewYear - 1 : calViewYear;
        var pDate = pYear + '-' + String(pMonth).padStart(2,'0') + '-' + String(pDay).padStart(2,'0');
        html += '<div class="cal-day other-month" onclick="calSelectDay(\'' + pDate + '\')">' +
            '<span class="cal-day-num">' + pDay + '</span></div>';
    }

    // Current month days
    for (var d = 1; d <= daysInMonth; d++) {
        var dateStr = calViewYear + '-' + String(calViewMonth+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
        var classes = 'cal-day';
        if (dateStr === todayStr) classes += ' today';
        if (dateStr === calSelectedDate) classes += ' selected';

        var dots = '';
        if (eventMap[dateStr]) {
            dots = '<div class="cal-day-dots">';
            var count = Math.min(eventMap[dateStr].length, 3);
            for (var j = 0; j < count; j++) dots += '<span class="cal-dot"></span>';
            if (eventMap[dateStr].length > 3) dots += '<span style="font-size:0.5rem;color:var(--fire);">+</span>';
            dots += '</div>';
        }

        html += '<div class="' + classes + '" onclick="calSelectDay(\'' + dateStr + '\')">' +
            '<span class="cal-day-num">' + d + '</span>' + dots + '</div>';
    }

    // Next month fill (complete the last row)
    var totalCells = startDow + daysInMonth;
    var remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (var n = 1; n <= remaining; n++) {
        var nMonth = calViewMonth + 2;
        var nYear = calViewYear;
        if (nMonth > 12) { nMonth = 1; nYear++; }
        var nDate = nYear + '-' + String(nMonth).padStart(2,'0') + '-' + String(n).padStart(2,'0');
        html += '<div class="cal-day other-month" onclick="calSelectDay(\'' + nDate + '\')">' +
            '<span class="cal-day-num">' + n + '</span></div>';
    }

    grid.innerHTML = html;

    // Sidebar
    if (calSelectedDate) {
        var selDate = new Date(calSelectedDate + 'T12:00:00');
        var dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        document.getElementById('cal-sidebar-date').textContent =
            dayNames[selDate.getDay()] + ', ' + MONTHS[selDate.getMonth()] + ' ' + selDate.getDate();

        var dayEvents = eventMap[calSelectedDate] || [];
        var eventsEl = document.getElementById('cal-sidebar-events');

        if (dayEvents.length === 0) {
            eventsEl.innerHTML = '<li class="cal-sidebar-empty">No events this day</li>';
        } else {
            eventsEl.innerHTML = dayEvents.map(function(e) {
                var timeStr = '';
                if (e.time) {
                    var parts = e.time.split(':');
                    var h = parseInt(parts[0]);
                    var ampm = h >= 12 ? 'PM' : 'AM';
                    h = h % 12 || 12;
                    timeStr = h + ':' + parts[1] + ' ' + ampm;
                }
                var crewHtml = '';
                if (e.crew) {
                    crewHtml = '<div class="cal-sidebar-crew"><span class="cal-sidebar-crew-dot"></span> ' + escapeHtml(e.crew) + '</div>';
                }
                return '<li class="cal-sidebar-event">' +
                    '<span class="cal-sidebar-time-col">' + (timeStr || 'All day') + '</span>' +
                    '<div class="cal-sidebar-info">' +
                        '<div class="cal-sidebar-title">' + escapeHtml(e.title) + '</div>' +
                        crewHtml +
                    '</div>' +
                    '<button class="cal-sidebar-del" onclick="calDelete(' + e.id + ')">×</button>' +
                '</li>';
            }).join('');
        }
    }
}

calInit();

// =============================================
// WEATHER
// =============================================
function fetchWeather() {
    var el = document.getElementById('weather-content');
    if (!navigator.geolocation) { el.innerHTML = '<div class="weather-loading">Geolocation not supported</div>'; return; }
    navigator.geolocation.getCurrentPosition(function(pos) {
        var lat = pos.coords.latitude.toFixed(2), lon = pos.coords.longitude.toFixed(2);
        fetch('https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon +
            '&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto')
        .then(function(r){return r.json();}).then(function(data) {
            var c = data.current, code = c.weather_code;
            el.innerHTML = '<div class="weather-display"><div style="font-size:2.5rem;">' + weatherIcon(code) + '</div><div>' +
                '<div class="weather-temp">' + Math.round(c.temperature_2m) + '°F</div>' +
                '<div class="weather-condition">' + weatherCondition(code) + '</div></div></div>' +
                '<div class="weather-details" style="margin-top:0.6rem;">Humidity: ' + c.relative_humidity_2m + '% · Wind: ' + Math.round(c.wind_speed_10m) + ' mph</div>';
            // Update briefing
            document.getElementById('brief-weather').textContent=Math.round(c.temperature_2m)+'°F';
            document.getElementById('brief-weather-desc').textContent=weatherCondition(code)+' · '+Math.round(c.wind_speed_10m)+' mph wind';
        }).catch(function(){ el.innerHTML = '<div class="weather-loading">Could not load weather</div>'; });
    }, function(){ el.innerHTML = '<div class="weather-loading">Location access denied</div>'; });
}
function weatherIcon(c){if(c===0)return'☀️';if(c<=3)return'⛅';if(c<=48)return'🌫️';if(c<=67)return'🌧️';if(c<=77)return'🌨️';if(c<=86)return'🌨️';if(c>=95)return'⛈️';return'🌤️';}
function weatherCondition(c){if(c===0)return'Clear sky';if(c<=3)return'Partly cloudy';if(c<=48)return'Fog';if(c<=55)return'Drizzle';if(c<=57)return'Freezing drizzle';if(c<=65)return'Rain';if(c<=67)return'Freezing rain';if(c<=75)return'Snowfall';if(c===77)return'Snow grains';if(c<=82)return'Rain showers';if(c<=86)return'Snow showers';if(c===95)return'Thunderstorm';if(c>=96)return'Thunderstorm w/ hail';return'Unknown';}
fetchWeather();

// Denver weather (39.74, -104.99)
fetch('https://api.open-meteo.com/v1/forecast?latitude=39.74&longitude=-104.99&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America/Denver')
.then(function(r){return r.json();}).then(function(data){
    var c=data.current,code=c.weather_code;
    document.getElementById('brief-denver').textContent=Math.round(c.temperature_2m)+'°F';
    document.getElementById('brief-denver-desc').textContent=weatherCondition(code)+' · '+Math.round(c.wind_speed_10m)+' mph wind';
}).catch(function(){
    document.getElementById('brief-denver').textContent='--';
    document.getElementById('brief-denver-desc').textContent='Could not load';
});

// =============================================
// SERVICE STATUS
// =============================================
var SERVICES = [
    {name:'GitHub',url:'https://github.com/favicon.ico'},
    {name:'Railway',url:'https://railway.com/favicon.ico'},
    {name:'Netlify',url:'https://app.netlify.com/favicon.ico'},
    {name:'Housecall Pro',url:'https://pro.housecallpro.com/favicon.ico'},
    {name:'Zapier',url:'https://zapier.com/favicon.ico'}
];
function checkAllServices() {
    var list = document.getElementById('status-list');
    list.innerHTML = SERVICES.map(function(s){
        var k = s.name.replace(/\s/g,'');
        return '<li class="status-item"><span class="status-dot checking" id="dot-'+k+'"></span><span class="status-name">'+s.name+'</span><span class="status-ms" id="ms-'+k+'">checking...</span></li>';
    }).join('');
    SERVICES.forEach(function(s){
        var k=s.name.replace(/\s/g,''), start=performance.now(), img=new Image();
        img.onload=function(){var ms=Math.round(performance.now()-start);document.getElementById('dot-'+k).className='status-dot up';document.getElementById('ms-'+k).textContent=ms+'ms';};
        img.onerror=function(){var ms=Math.round(performance.now()-start);if(ms<5000){document.getElementById('dot-'+k).className='status-dot up';document.getElementById('ms-'+k).textContent=ms+'ms';}else{document.getElementById('dot-'+k).className='status-dot down';document.getElementById('ms-'+k).textContent='timeout';}};
        img.src=s.url+'?_='+Date.now();
        setTimeout(function(){var d=document.getElementById('dot-'+k);if(d&&d.classList.contains('checking')){d.className='status-dot down';document.getElementById('ms-'+k).textContent='timeout';}},8000);
    });
}
checkAllServices();

// =============================================
// MOTIVATION
// =============================================
var QUOTES=[
    {text:'The obstacle is the way. What stands in the way becomes the way.',source:'Marcus Aurelius — Zero Resistance'},
    {text:'Simplicity is the ultimate sophistication. Remove until only the essential remains.',source:'Leonardo da Vinci — Zero Excess'},
    {text:'Where attention goes, energy flows. Guard your focus like a fortress.',source:'Feng Shui Principle — Chi Direction'},
    {text:'Strategy without tactics is the slowest route to victory. Tactics without strategy is the noise before defeat.',source:'Sun Tzu — Zero Wasted Motion'},
    {text:'Clear space, clear mind. Clutter blocks the flow of opportunity.',source:'Feng Shui — Space Clearing'},
    {text:'Do less, but do it fully. Then rest, fully. Then do the next thing, fully.',source:'Zero Principle — Total Presence'},
    {text:'The best time to plant a tree was 20 years ago. The second best time is now.',source:'Chinese Proverb — Zero Delay'},
    {text:'Position yourself where the energy naturally converges. Don\'t fight the current — redirect it.',source:'Feng Shui Strategy — Flow Alignment'},
    {text:'Every system is perfectly designed to get the results it gets. Change the system, change the results.',source:'W. Edwards Deming — Zero Blame'},
    {text:'Empty your cup so that it may be filled. Become devoid to gain totality.',source:'Bruce Lee — Zero Assumption'},
    {text:'The five elements must be in balance: too much fire burns, too much water drowns. Harmony is power.',source:'Feng Shui — Elemental Balance'},
    {text:'What you do every day matters more than what you do once in a while. Build the ritual, trust the process.',source:'Zero Principle — Compound Discipline'},
    {text:'In the space between stimulus and response lies your power and your freedom.',source:'Viktor Frankl — Zero Reactivity'},
    {text:'A goal without a plan is just a wish. A plan without execution is just a dream.',source:'Zero Strategy — Execution First'},
    {text:'Let your workspace tell you where to go next. When everything has a place, nothing is lost.',source:'Feng Shui — Intentional Arrangement'}
];
var quoteIndex=Math.floor(Math.random()*QUOTES.length);
function showQuote(){var q=QUOTES[quoteIndex];document.getElementById('motivation-quote').textContent='\u201C'+q.text+'\u201D';document.getElementById('motivation-source').textContent='\u2014 '+q.source;}
function nextQuote(){quoteIndex=(quoteIndex+1)%QUOTES.length;showQuote();}
showQuote();

// =============================================
// CALCULATOR
// =============================================
var calcExpr='';
function calcInput(v){if(calcExpr==='0'&&v!=='.')calcExpr='';calcExpr+=v;document.getElementById('calc-display').textContent=calcExpr||'0';}
function calcClear(){calcExpr='';document.getElementById('calc-display').textContent='0';}
function calcBackspace(){calcExpr=calcExpr.slice(0,-1);document.getElementById('calc-display').textContent=calcExpr||'0';}
function calcEval(){try{if(/^[\d+\-*/.() ]+$/.test(calcExpr)){var r=Function('"use strict"; return ('+calcExpr+')')();calcExpr=String(Math.round(r*1e8)/1e8);document.getElementById('calc-display').textContent=calcExpr;}}catch(e){document.getElementById('calc-display').textContent='Error';calcExpr='';}}

// =============================================
// NOTES — Supabase-backed
// =============================================
var notesSaveTimer;
var notesArea=document.getElementById('notes-area');
(async function(){var{data}=await sb.from('cockpit_notes').select('content').eq('id',1).single();if(data)notesArea.value=data.content||'';})();
async function saveNotes(){
    try{
        await sb.from('cockpit_notes').upsert({id:1,content:notesArea.value,updated_at:new Date().toISOString()});
        document.getElementById('notes-saved').textContent='Saved '+new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    }catch(e){document.getElementById('notes-saved').textContent='Save failed!';}
}
notesArea.addEventListener('input',function(){clearTimeout(notesSaveTimer);notesSaveTimer=setTimeout(saveNotes,600);});
notesArea.addEventListener('blur',saveNotes);
window.addEventListener('beforeunload',function(){if(notesArea.value){navigator.sendBeacon||saveNotes();}});

// =============================================
// MEMORY VAULT — Supabase-backed
// =============================================
var memData=[];

async function memLoad(){
    var {data}=await sb.from('cockpit_memory').select('*').order('pinned',{ascending:false}).order('updated_at',{ascending:false});
    memData=data||[];
    memUpdateCatFilter();
    memRender();
}

function memUpdateCatFilter(){
    var sel=document.getElementById('mem-cat-filter');
    var current=sel.value;
    var cats=[...new Set(memData.map(function(m){return m.category;}))].sort();
    var html='<option value="">All Categories</option>';
    cats.forEach(function(c){html+='<option value="'+escapeHtml(c)+'">'+escapeHtml(c)+'</option>';});
    sel.innerHTML=html;
    sel.value=current;
}

function memRender(){
    var search=document.getElementById('mem-search').value.toLowerCase().trim();
    var catFilter=document.getElementById('mem-cat-filter').value;
    var filtered=memData.filter(function(m){
        if(catFilter && m.category!==catFilter) return false;
        if(search){
            return m.title.toLowerCase().indexOf(search)!==-1 ||
                   m.content.toLowerCase().indexOf(search)!==-1 ||
                   m.category.toLowerCase().indexOf(search)!==-1;
        }
        return true;
    });
    var grid=document.getElementById('mem-grid');
    if(!filtered.length){
        grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--clarity-dim);font-size:0.82rem;">'+(search||catFilter?'No matches found':'No memories yet — click + to add one')+'</div>';
        return;
    }
    var html='';
    filtered.forEach(function(m){
        var date=new Date(m.updated_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
        html+='<div class="mem-card'+(m.pinned?' pinned':'')+'" onclick="memOpenModal(\''+m.id+'\')">';
        html+='<div class="mem-card-actions">';
        html+='<button class="mem-card-btn" onclick="event.stopPropagation();memTogglePin(\''+m.id+'\','+!m.pinned+')" title="'+(m.pinned?'Unpin':'Pin')+'">'+(m.pinned?'Unpin':'Pin')+'</button>';
        html+='<button class="mem-card-btn del" onclick="event.stopPropagation();memDelete(\''+m.id+'\')" title="Delete">Del</button>';
        html+='</div>';
        html+='<div class="mem-card-cat">'+escapeHtml(m.category)+'</div>';
        html+='<div class="mem-card-title">'+escapeHtml(m.title)+'</div>';
        html+='<div class="mem-card-content">'+escapeHtml(m.content)+'</div>';
        html+='<div class="mem-card-time">'+date+'</div>';
        html+='</div>';
    });
    grid.innerHTML=html;
}

function memOpenModal(editId){
    var overlay=document.getElementById('mem-modal-overlay');
    overlay.classList.add('active');
    if(editId){
        var m=memData.find(function(x){return x.id===editId;});
        if(!m) return;
        document.getElementById('mem-modal-title').textContent='Edit Memory';
        document.getElementById('mem-edit-id').value=m.id;
        document.getElementById('mem-modal-cat').value=m.category;
        document.getElementById('mem-modal-title-input').value=m.title;
        document.getElementById('mem-modal-content').value=m.content;
        document.getElementById('mem-modal-pinned').checked=m.pinned;
    } else {
        document.getElementById('mem-modal-title').textContent='New Memory';
        document.getElementById('mem-edit-id').value='';
        document.getElementById('mem-modal-cat').value='General';
        document.getElementById('mem-modal-title-input').value='';
        document.getElementById('mem-modal-content').value='';
        document.getElementById('mem-modal-pinned').checked=false;
    }
    document.getElementById('mem-modal-title-input').focus();
}

function memCloseModal(){
    document.getElementById('mem-modal-overlay').classList.remove('active');
    document.getElementById('mem-custom-cat').style.display='none';
    document.getElementById('mem-custom-cat').value='';
}

async function memSave(){
    var editId=document.getElementById('mem-edit-id').value;
    var catSel=document.getElementById('mem-modal-cat').value;
    var cat=catSel==='__custom__'?document.getElementById('mem-custom-cat').value.trim():catSel;
    if(!cat) cat='General';
    var title=document.getElementById('mem-modal-title-input').value.trim();
    var content=document.getElementById('mem-modal-content').value.trim();
    var pinned=document.getElementById('mem-modal-pinned').checked;
    if(!title) return;
    if(editId){
        await sb.from('cockpit_memory').update({category:cat,title:title,content:content,pinned:pinned,updated_at:new Date().toISOString()}).eq('id',editId);
    } else {
        await sb.from('cockpit_memory').insert({category:cat,title:title,content:content,pinned:pinned});
    }
    memCloseModal();
    memLoad();
}

async function memDelete(id){
    if(!confirm('Delete this memory?')) return;
    await sb.from('cockpit_memory').delete().eq('id',id);
    memLoad();
}

async function memTogglePin(id,pinned){
    await sb.from('cockpit_memory').update({pinned:pinned,updated_at:new Date().toISOString()}).eq('id',id);
    memLoad();
}

memLoad();

// Realtime for memory
sb.channel('cockpit-memory-realtime')
    .on('postgres_changes',{event:'*',schema:'public',table:'cockpit_memory'},function(){
        memLoad();
    })
    .subscribe();

// =============================================
// DAILY BRIEFING
// =============================================
async function briefingLoad(){
    // Today's jobs from calendar + job pipeline
    var today=new Date().toISOString().slice(0,10);
    var {data:events}=await sb.from('cockpit_calendar').select('*').eq('date',today);
    events=events||[];
    // Also count scheduled jobs for today from cockpit_jobs
    var {data:todayJobs}=await sb.from('cockpit_jobs').select('*').eq('date_scheduled',today).neq('status','paid');
    todayJobs=todayJobs||[];
    var totalToday=events.length+todayJobs.length;
    document.getElementById('brief-jobs').textContent=totalToday;
    var nextJobText=todayJobs.length?todayJobs[0].customer_name:(events.length?events[0].title:'No jobs today');
    // Show pipeline summary
    var {data:activeJobs}=await sb.from('cockpit_jobs').select('status').in('status',['scheduled','in_progress']);
    activeJobs=activeJobs||[];
    if(activeJobs.length)nextJobText+=(' ('+activeJobs.length+' in pipeline)');
    document.getElementById('brief-jobs-next').textContent=nextJobText;

    // Active tasks
    var {data:todos}=await sb.from('cockpit_todos').select('*').eq('done',false);
    todos=todos||[];
    var pts=0;todos.forEach(function(t){pts+=t.priority||0;});
    document.getElementById('brief-tasks').textContent=todos.length;
    document.getElementById('brief-tasks-pts').textContent=pts+' pts remaining';

    // This month income/expenses + job revenue
    var monthStart=new Date();monthStart.setDate(1);
    var ms=monthStart.toISOString().slice(0,10);
    var {data:exps}=await sb.from('cockpit_expenses').select('*').gte('date',ms);
    exps=exps||[];
    var inc=0,exp=0;
    exps.forEach(function(e){
        if(e.type==='income')inc+=parseFloat(e.amount);
        else exp+=parseFloat(e.amount);
    });
    // Add paid jobs this month
    var {data:paidJobs}=await sb.from('cockpit_jobs').select('total_price').eq('status','paid').gte('date_completed',ms);
    (paidJobs||[]).forEach(function(j){inc+=parseFloat(j.total_price||0);});
    document.getElementById('brief-income').textContent='$'+inc.toLocaleString();
    document.getElementById('brief-expense').textContent='$'+exp.toLocaleString()+' expenses';
}
briefingLoad();

// =============================================
// BUSINESS FINANCE DASHBOARD
// =============================================
var expData=[];
var jobData=[];
var jobCurrentFilter='all';
var bizCurrentTab='overview';

// --- Tab switching ---
function bizTab(tabName){
    bizCurrentTab=tabName;
    var tabs=document.querySelectorAll('#biz-tabs .biz-tab');
    tabs.forEach(function(t){t.classList.remove('active');});
    document.querySelectorAll('.biz-tab-content').forEach(function(p){p.classList.remove('active');});
    // Activate correct tab button
    var idx={overview:0,jobs:1,costs:2,adspend:3}[tabName]||0;
    tabs[idx].classList.add('active');
    document.getElementById('biz-panel-'+tabName).classList.add('active');
    // Refresh data for the active tab
    if(tabName==='overview')bizOverviewRender();
    if(tabName==='jobs')jobRender();
    if(tabName==='costs')expRender();
    if(tabName==='adspend')adRender();
}

// =============================================
// EXPENSE / COSTS — Supabase-backed
// =============================================
async function expLoad(){
    var {data}=await sb.from('cockpit_expenses').select('*').order('date',{ascending:false}).order('created_at',{ascending:false});
    expData=data||[];
    expRender();
    bizOverviewRender();
    adRender();
}

function expRender(){
    var filterCat=(document.getElementById('cost-cat-filter')||{}).value||'all';
    // Costs tab: show only expense entries (not income, not ads)
    var costs=expData.filter(function(e){return e.type==='expense'&&!(e.category||'').startsWith('Ad —');});
    if(filterCat!=='all')costs=costs.filter(function(e){return e.category===filterCat;});

    var list=document.getElementById('exp-list');
    if(!costs.length){list.innerHTML='<div style="text-align:center;padding:1rem;color:var(--clarity-dim);font-size:0.8rem;">No expenses yet</div>';return;}
    var html='';
    costs.forEach(function(e){
        html+='<div class="exp-row">';
        html+='<span class="exp-row-type expense">expense</span>';
        html+='<span class="exp-row-desc">'+escapeHtml(e.description)+(e.source==='hcp'?'<span class="inv-hcp-badge">HCP</span>':'')+'</span>';
        html+='<span class="exp-row-cat">'+escapeHtml(e.category)+'</span>';
        html+='<span class="exp-row-amt" style="color:var(--red)">$'+parseFloat(e.amount).toFixed(2)+'</span>';
        html+='<button class="exp-row-del" onclick="expDelete(\''+e.id+'\')">&times;</button>';
        html+='</div>';
    });
    list.innerHTML=html;
}

async function expAdd(){
    var amount=parseFloat(document.getElementById('exp-amount').value);
    var desc=document.getElementById('exp-desc').value.trim();
    var cat=document.getElementById('exp-cat').value;
    if(!amount||!desc)return;
    await sb.from('cockpit_expenses').insert({type:'expense',amount:amount,description:desc,category:cat});
    document.getElementById('exp-amount').value='';
    document.getElementById('exp-desc').value='';
    expLoad();briefingLoad();
}

async function expDelete(id){
    await sb.from('cockpit_expenses').delete().eq('id',id);
    expLoad();briefingLoad();
}

// =============================================
// JOBS — Supabase-backed
// =============================================
async function jobLoad(){
    var {data}=await sb.from('cockpit_jobs').select('*').order('date_scheduled',{ascending:true}).order('created_at',{ascending:false});
    jobData=data||[];
    jobRender();
    bizOverviewRender();
}

function jobRender(){
    // Pipeline counts
    var counts={all:jobData.length,scheduled:0,in_progress:0,completed:0,paid:0};
    jobData.forEach(function(j){counts[j.status]=(counts[j.status]||0)+1;});
    ['all','scheduled','in_progress','completed','paid'].forEach(function(s){
        var el=document.getElementById('job-count-'+s);
        if(el)el.textContent=counts[s]||0;
    });

    // Update pipeline button active state
    document.querySelectorAll('.job-pipeline-btn').forEach(function(b){b.classList.remove('active');});
    var pipelineBtns=document.querySelectorAll('.job-pipeline-btn');
    var filterIdx={all:0,scheduled:1,in_progress:2,completed:3,paid:4}[jobCurrentFilter]||0;
    if(pipelineBtns[filterIdx])pipelineBtns[filterIdx].classList.add('active');

    // Filter jobs
    var filtered=jobCurrentFilter==='all'?jobData:jobData.filter(function(j){return j.status===jobCurrentFilter;});

    var list=document.getElementById('job-list');
    if(!filtered.length){list.innerHTML='<div style="text-align:center;padding:1rem;color:var(--clarity-dim);font-size:0.8rem;">No jobs</div>';return;}
    var html='';
    filtered.forEach(function(j){
        var statusLabel=j.status.replace('_',' ');
        html+='<div class="job-row">';
        html+='<div class="job-row-top">';
        html+='<span class="job-status-badge '+j.status+'">'+escapeHtml(statusLabel)+'</span>';
        html+='<span class="job-row-customer">'+escapeHtml(j.customer_name)+'</span>';
        if(j.description)html+=' <span class="job-row-desc">— '+escapeHtml(j.description)+'</span>';
        html+='<span class="job-row-price">$'+parseFloat(j.total_price||0).toFixed(0)+'</span>';
        html+='<div class="job-row-actions">';
        if(j.status!=='paid'){
            html+='<button class="job-action-btn advance" onclick="jobAdvance(\''+j.id+'\')" title="Advance status">&#9654;</button>';
        }
        if(j.status==='completed'){
            html+='<button class="job-action-btn paid-btn" onclick="jobMarkPaid(\''+j.id+'\')" title="Mark paid">&#10003;</button>';
        }
        html+='<button class="job-action-btn del" onclick="jobDelete(\''+j.id+'\')" title="Delete">&times;</button>';
        html+='</div>';
        html+='</div>';
        // Bottom row: deposit + date
        var parts=[];
        if(parseFloat(j.deposit_amount||0)>0)parts.push('Dep: $'+parseFloat(j.deposit_amount).toFixed(0));
        if(j.date_scheduled)parts.push('Sched: '+j.date_scheduled);
        if(j.date_completed)parts.push('Done: '+j.date_completed);
        if(j.source==='hcp')parts.push('<span class="inv-hcp-badge">HCP</span>');
        if(parts.length)html+='<div class="job-row-bottom">'+parts.join(' &middot; ')+'</div>';
        html+='</div>';
    });
    list.innerHTML=html;
}

function jobFilterStatus(status){
    jobCurrentFilter=status;
    jobRender();
}

async function jobAdd(){
    var customer=document.getElementById('job-customer').value.trim();
    var desc=document.getElementById('job-desc').value.trim();
    var price=parseFloat(document.getElementById('job-price').value)||0;
    var deposit=parseFloat(document.getElementById('job-deposit').value)||0;
    var date=document.getElementById('job-date').value||null;
    if(!customer)return;
    await sb.from('cockpit_jobs').insert({customer_name:customer,description:desc,total_price:price,deposit_amount:deposit,date_scheduled:date,status:'scheduled'});
    document.getElementById('job-customer').value='';
    document.getElementById('job-desc').value='';
    document.getElementById('job-price').value='';
    document.getElementById('job-deposit').value='';
    document.getElementById('job-date').value='';
    jobLoad();briefingLoad();
}

async function jobAdvance(id){
    var job=jobData.find(function(j){return String(j.id)===String(id);});
    if(!job)return;
    var next={scheduled:'in_progress',in_progress:'completed',completed:'paid'};
    var nextStatus=next[job.status];
    if(!nextStatus)return;
    var update={status:nextStatus};
    if(nextStatus==='completed')update.date_completed=new Date().toISOString().slice(0,10);
    await sb.from('cockpit_jobs').update(update).eq('id',id);
    jobLoad();briefingLoad();
}

async function jobMarkPaid(id){
    await sb.from('cockpit_jobs').update({status:'paid'}).eq('id',id);
    jobLoad();briefingLoad();
}

async function jobDelete(id){
    await sb.from('cockpit_jobs').delete().eq('id',id);
    jobLoad();briefingLoad();
}

// =============================================
// OVERVIEW — calculated from jobs + expenses
// =============================================
function bizOverviewRender(){
    // Revenue: income from expenses + total_price of paid jobs
    var incFromExp=0;
    expData.forEach(function(e){if(e.type==='income')incFromExp+=parseFloat(e.amount||0);});
    var jobRevenue=0,jobDeposits=0,totalJobs=0;
    jobData.forEach(function(j){
        if(j.status==='paid')jobRevenue+=parseFloat(j.total_price||0);
        jobDeposits+=parseFloat(j.deposit_amount||0);
        totalJobs++;
    });
    var revenue=incFromExp+jobRevenue;

    // Costs: non-ad expenses
    var costTotal=0;
    expData.forEach(function(e){
        if(e.type==='expense'&&!(e.category||'').startsWith('Ad —'))costTotal+=parseFloat(e.amount||0);
    });

    // Ad spend
    var adTotal=0;
    expData.forEach(function(e){
        if((e.category||'').startsWith('Ad —'))adTotal+=parseFloat(e.amount||0);
    });

    var profit=revenue-costTotal-adTotal;

    var fmt=function(v){return '$'+Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});};
    document.getElementById('biz-revenue').textContent=fmt(revenue);
    document.getElementById('biz-deposits').textContent=fmt(jobDeposits);
    document.getElementById('biz-costs').textContent=fmt(costTotal);
    document.getElementById('biz-adspend').textContent=fmt(adTotal);
    document.getElementById('biz-profit').textContent=(profit>=0?'+':'-')+fmt(profit);
    document.getElementById('biz-jobcount').textContent=totalJobs;

    // Cost breakdown bar chart
    var catTotals={};
    expData.forEach(function(e){
        if(e.type==='expense'){
            var cat=e.category||'Other';
            catTotals[cat]=(catTotals[cat]||0)+parseFloat(e.amount||0);
        }
    });
    var sorted=Object.keys(catTotals).sort(function(a,b){return catTotals[b]-catTotals[a];});
    var maxVal=sorted.length?catTotals[sorted[0]]:1;
    var colors=['#ff6a00','#e69500','#5599ff','#32cd32','#ff4444','#d4a800','#9966ff','#ff69b4','#00bcd4','#8bc34a'];
    var chartHtml='';
    sorted.forEach(function(cat,i){
        var pct=Math.round((catTotals[cat]/maxVal)*100);
        chartHtml+='<div class="biz-bar-row">';
        chartHtml+='<span class="biz-bar-label">'+escapeHtml(cat)+'</span>';
        chartHtml+='<div class="biz-bar-track"><div class="biz-bar-fill" style="width:'+pct+'%;background:'+colors[i%colors.length]+';"></div></div>';
        chartHtml+='<span class="biz-bar-val">$'+catTotals[cat].toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})+'</span>';
        chartHtml+='</div>';
    });
    document.getElementById('biz-bar-chart').innerHTML=chartHtml||'<div style="text-align:center;padding:1rem;color:var(--clarity-dim);font-size:0.8rem;">No expenses to chart</div>';
}

// =============================================
// AD SPEND — filtered view of expenses
// =============================================
function adRender(){
    var ads=expData.filter(function(e){return (e.category||'').startsWith('Ad —');});
    var totalSpent=0,totalLeads=0;
    var platformTotals={};
    ads.forEach(function(e){
        var amt=parseFloat(e.amount||0);
        totalSpent+=amt;
        totalLeads+=parseInt(e.leads||0);
        var plat=e.category||'Ad — Other';
        if(!platformTotals[plat])platformTotals[plat]={spent:0,leads:0};
        platformTotals[plat].spent+=amt;
        platformTotals[plat].leads+=parseInt(e.leads||0);
    });
    var cpl=totalLeads>0?(totalSpent/totalLeads):0;

    document.getElementById('ad-total').textContent='$'+totalSpent.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
    document.getElementById('ad-leads').textContent=totalLeads;
    document.getElementById('ad-cpl').textContent=cpl>0?'$'+cpl.toFixed(2):'—';

    // Platform badges
    var badgeHtml='';
    Object.keys(platformTotals).forEach(function(plat){
        var label=plat.replace('Ad — ','');
        badgeHtml+='<span class="ad-platform-badge">'+escapeHtml(label)+'<span class="ad-badge-amt">$'+platformTotals[plat].spent.toFixed(0)+'</span></span>';
    });
    document.getElementById('ad-badges').innerHTML=badgeHtml;

    // Ad list
    var listEl=document.getElementById('ad-list');
    if(!ads.length){listEl.innerHTML='<div style="text-align:center;padding:1rem;color:var(--clarity-dim);font-size:0.8rem;">No ad spend entries</div>';return;}
    var html='';
    ads.forEach(function(e){
        html+='<div class="exp-row">';
        html+='<span class="exp-row-type expense" style="background:rgba(255,165,0,0.15);color:#e69500;">AD</span>';
        html+='<span class="exp-row-desc">'+escapeHtml(e.category.replace('Ad — ',''))+(e.description?' — '+escapeHtml(e.description):'')+'</span>';
        if(parseInt(e.leads||0)>0)html+='<span class="exp-row-cat">'+e.leads+' leads</span>';
        html+='<span class="exp-row-amt" style="color:#e69500;">$'+parseFloat(e.amount).toFixed(2)+'</span>';
        html+='<button class="exp-row-del" onclick="expDelete(\''+e.id+'\')">&times;</button>';
        html+='</div>';
    });
    listEl.innerHTML=html;
}

async function adAdd(){
    var platform=document.getElementById('ad-platform').value;
    var amount=parseFloat(document.getElementById('ad-amount').value);
    var leads=parseInt(document.getElementById('ad-leads-input').value)||0;
    var desc=document.getElementById('ad-desc').value.trim();
    if(!amount)return;
    await sb.from('cockpit_expenses').insert({type:'expense',amount:amount,description:desc,category:platform,leads:leads});
    document.getElementById('ad-amount').value='';
    document.getElementById('ad-leads-input').value='';
    document.getElementById('ad-desc').value='';
    expLoad();briefingLoad();
}

// =============================================
// LOAD ALL BIZ DATA
// =============================================
expLoad();
jobLoad();

// Realtime for jobs
sb.channel('cockpit-jobs-realtime').on('postgres_changes',{event:'*',schema:'public',table:'cockpit_jobs'},function(){jobLoad();}).subscribe();

// =============================================
// HCP (Housecall Pro) SYNC
// =============================================
var hcpKey=localStorage.getItem('cockpit_hcp_key')||'';
if(hcpKey){
    document.getElementById('hcp-connect-btn').textContent='HCP Connected';
    document.getElementById('hcp-connect-btn').style.borderColor='var(--green)';
    document.getElementById('hcp-connect-btn').style.color='var(--green)';
    document.getElementById('hcp-sync-btn').style.display='inline-flex';
    document.getElementById('hcp-cust-sync-btn').style.display='inline-flex';
}

function hcpConnect(){
    var key=prompt('Enter your Housecall Pro API key:');
    if(!key)return;
    localStorage.setItem('cockpit_hcp_key',key);
    hcpKey=key;
    document.getElementById('hcp-connect-btn').textContent='HCP Connected';
    document.getElementById('hcp-connect-btn').style.borderColor='var(--green)';
    document.getElementById('hcp-connect-btn').style.color='var(--green)';
    document.getElementById('hcp-sync-btn').style.display='inline-flex';
    document.getElementById('hcp-cust-sync-btn').style.display='inline-flex';
}

async function hcpSync(){
    if(!hcpKey){hcpConnect();return;}
    var btn=document.getElementById('hcp-sync-btn');
    btn.textContent='Syncing...';btn.disabled=true;
    var imported=0;
    try{
        // --- Import invoices as income ---
        var resp=await fetch('/api/hcp/invoices?page_size=50',{
            headers:{'x-hcp-key':hcpKey}
        });
        var data=await resp.json();
        if(!resp.ok){alert('HCP Error: '+(data.error||'Unknown error'));btn.textContent='Sync HCP';btn.disabled=false;return;}
        var invoices=data.invoices||data||[];
        if(!Array.isArray(invoices))invoices=[];
        var {data:existing}=await sb.from('cockpit_expenses').select('source_id').eq('source','hcp').not('source_id','is',null);
        var existingIds=new Set((existing||[]).map(function(e){return e.source_id;}));
        for(var i=0;i<invoices.length;i++){
            var inv=invoices[i];
            var invoiceId=inv.id||inv.invoice_id||('hcp-'+i);
            if(existingIds.has(String(invoiceId)))continue;
            if(inv.status&&inv.status!=='paid'&&inv.status!=='completed')continue;
            var amount=parseFloat(inv.total_amount||inv.balance||inv.amount||0);
            if(!amount||amount<=0)continue;
            var desc=(inv.customer?(inv.customer.first_name||'')+' '+(inv.customer.last_name||''):inv.customer_name||'')+(inv.work_status?' — '+inv.work_status:'');
            if(!desc.trim())desc='HCP Invoice #'+invoiceId;
            await sb.from('cockpit_expenses').insert({
                type:'income',amount:amount,description:desc.trim(),category:'HCP Job',source:'hcp',source_id:String(invoiceId)
            });
            imported++;
        }

        // --- Import jobs into cockpit_jobs ---
        try{
            var jResp=await fetch('/api/hcp/jobs?page_size=50',{
                headers:{'x-hcp-key':hcpKey}
            });
            var jData=await jResp.json();
            if(jResp.ok){
                var hcpJobs=jData.jobs||jData||[];
                if(!Array.isArray(hcpJobs))hcpJobs=[];
                var {data:existingJobs}=await sb.from('cockpit_jobs').select('source_id').eq('source','hcp').not('source_id','is',null);
                var existingJobIds=new Set((existingJobs||[]).map(function(j){return j.source_id;}));
                var statusMap={scheduled:'scheduled',unscheduled:'scheduled',in_progress:'in_progress',complete:'completed',completed:'completed',paid:'paid'};
                for(var k=0;k<hcpJobs.length;k++){
                    var hj=hcpJobs[k];
                    var jobId=hj.id||hj.job_id||('hcpj-'+k);
                    if(existingJobIds.has(String(jobId)))continue;
                    var cname=(hj.customer?(hj.customer.first_name||'')+' '+(hj.customer.last_name||''):hj.customer_name||'HCP Job');
                    var jdesc=hj.description||hj.work_status||'';
                    var jprice=parseFloat(hj.total_amount||hj.invoice_total||hj.amount||0);
                    var jdeposit=parseFloat(hj.outstanding_balance||0);
                    var jstatus=statusMap[(hj.work_status||'').toLowerCase()]||'scheduled';
                    var jdate=hj.scheduled_start?hj.scheduled_start.slice(0,10):null;
                    await sb.from('cockpit_jobs').insert({
                        customer_name:cname.trim()||'HCP Job',description:jdesc,total_price:jprice,deposit_amount:jdeposit>0?jprice-jdeposit:0,
                        status:jstatus,date_scheduled:jdate,source:'hcp',source_id:String(jobId)
                    });
                    imported++;
                }
            }
        }catch(je){console.error('HCP jobs sync error:',je);}

        btn.textContent=imported?imported+' imported':'Up to date';
        setTimeout(function(){btn.textContent='Sync HCP';},3000);
        if(imported){expLoad();jobLoad();briefingLoad();}
    }catch(err){
        console.error('HCP sync error:',err);
        btn.textContent='Sync Failed';
        setTimeout(function(){btn.textContent='Sync HCP';},3000);
    }
    btn.disabled=false;
}

// ========== HCP CUSTOMER → COMMS SYNC ==========
async function hcpSyncCustomers(){
    if(!hcpKey){hcpConnect();return;}
    try{
        var resp=await fetch('/api/hcp/sync-customers',{
            method:'POST',
            headers:{'x-hcp-key':hcpKey,'Content-Type':'application/json'}
        });
        var result=await resp.json();
        if(resp.ok){
            console.log('HCP customers synced:',result);
            commsRenderChannels();
        }else{
            console.error('HCP customer sync error:',result.error);
        }
    }catch(err){console.error('HCP customer sync error:',err);}
}

// Auto-sync HCP on load if key is present
if(hcpKey)setTimeout(function(){hcpSync();hcpSyncCustomers();},3000);

// =============================================
// INVESTMENT TRACKER — Supabase-backed
// =============================================
var invData=[];
var invCurrentFilter='all';

async function invLoad(){
    var {data}=await sb.from('cockpit_investments').select('*').order('created_at',{ascending:false});
    invData=data||[];
    invRender();
}

function invRender(){
    var filtered=invCurrentFilter==='all'?invData:invData.filter(function(i){return i.type===invCurrentFilter;});
    // Summary
    var totalInvested=0,totalValue=0;
    invData.forEach(function(i){
        totalInvested+=parseFloat(i.amount_invested)||0;
        totalValue+=parseFloat(i.current_value)||parseFloat(i.amount_invested)||0;
    });
    var roi=totalInvested>0?((totalValue-totalInvested)/totalInvested*100):0;
    var roiDollar=totalValue-totalInvested;
    document.getElementById('inv-invested').textContent='$'+totalInvested.toLocaleString(undefined,{minimumFractionDigits:2});
    document.getElementById('inv-value').textContent='$'+totalValue.toLocaleString(undefined,{minimumFractionDigits:2});
    document.getElementById('inv-roi').textContent=(roi>=0?'+':'')+roi.toFixed(1)+'% ('+(roiDollar>=0?'+$':'−$')+Math.abs(roiDollar).toLocaleString(undefined,{minimumFractionDigits:2})+')';
    // Color ROI
    var roiEl=document.getElementById('inv-roi');
    roiEl.style.color=roi>0?'var(--green)':roi<0?'var(--red)':'var(--clarity-dim)';

    var list=document.getElementById('inv-list');
    if(!filtered.length){
        list.innerHTML='<div style="text-align:center;padding:1.5rem;color:var(--clarity-dim);font-size:0.82rem;">No investments yet. Click + to add one.</div>';
        return;
    }
    var html='';
    filtered.forEach(function(inv){
        var invested=parseFloat(inv.amount_invested)||0;
        var current=parseFloat(inv.current_value)||invested;
        var gain=invested>0?((current-invested)/invested*100):0;
        var gainClass=gain>0.5?'up':gain<-0.5?'down':'flat';
        html+='<div class="inv-row">';
        html+='<span class="inv-type-badge '+inv.type+'">'+inv.type.replace('_',' ')+'</span>';
        html+='<span class="inv-name">'+escapeHtml(inv.name)+(inv.ticker?' <span class="inv-ticker">'+escapeHtml(inv.ticker)+'</span>':'')+'</span>';
        html+='<span class="inv-col">$'+invested.toLocaleString(undefined,{minimumFractionDigits:2})+'</span>';
        html+='<span class="inv-col">$'+current.toLocaleString(undefined,{minimumFractionDigits:2})+'</span>';
        html+='<span class="inv-col inv-gain '+gainClass+'">'+(gain>=0?'+':'')+gain.toFixed(1)+'%</span>';
        html+='<button class="inv-row-del" onclick="invDelete(\''+inv.id+'\')">&times;</button>';
        html+='</div>';
    });
    list.innerHTML=html;
}

function invFilter(type){
    invCurrentFilter=type;
    document.querySelectorAll('.inv-tab').forEach(function(t){
        t.classList.toggle('active',t.textContent.toLowerCase().replace(' ','_')===type||(type==='all'&&t.textContent==='All'));
    });
    invRender();
}

function invOpenModal(editItem){
    document.getElementById('inv-modal').classList.add('active');
    if(editItem){
        document.getElementById('inv-modal-title').textContent='Edit Investment';
        document.getElementById('inv-edit-id').value=editItem.id;
        document.getElementById('inv-name').value=editItem.name;
        document.getElementById('inv-type').value=editItem.type;
        document.getElementById('inv-ticker').value=editItem.ticker||'';
        document.getElementById('inv-amount').value=editItem.amount_invested;
        document.getElementById('inv-current').value=editItem.current_value||'';
        document.getElementById('inv-qty').value=editItem.quantity||'';
        document.getElementById('inv-date').value=editItem.date_acquired||'';
        document.getElementById('inv-notes').value=editItem.notes||'';
    }else{
        document.getElementById('inv-modal-title').textContent='Add Investment';
        document.getElementById('inv-edit-id').value='';
        document.getElementById('inv-name').value='';
        document.getElementById('inv-type').value='crypto';
        document.getElementById('inv-ticker').value='';
        document.getElementById('inv-amount').value='';
        document.getElementById('inv-current').value='';
        document.getElementById('inv-qty').value='';
        document.getElementById('inv-date').value=new Date().toISOString().slice(0,10);
        document.getElementById('inv-notes').value='';
    }
}

function invCloseModal(){document.getElementById('inv-modal').classList.remove('active');}

async function invSave(){
    var name=document.getElementById('inv-name').value.trim();
    var type=document.getElementById('inv-type').value;
    var amount=parseFloat(document.getElementById('inv-amount').value);
    if(!name||!amount){alert('Name and amount are required.');return;}
    var obj={
        name:name,
        type:type,
        amount_invested:amount,
        current_value:parseFloat(document.getElementById('inv-current').value)||null,
        quantity:parseFloat(document.getElementById('inv-qty').value)||null,
        ticker:document.getElementById('inv-ticker').value.trim().toUpperCase()||null,
        notes:document.getElementById('inv-notes').value.trim(),
        date_acquired:document.getElementById('inv-date').value||null
    };
    var editId=document.getElementById('inv-edit-id').value;
    if(editId){
        await sb.from('cockpit_investments').update(obj).eq('id',editId);
    }else{
        await sb.from('cockpit_investments').insert(obj);
    }
    invCloseModal();
    invLoad();
}

async function invDelete(id){
    if(!confirm('Delete this investment?'))return;
    await sb.from('cockpit_investments').delete().eq('id',id);
    invLoad();
}

// Crypto ticker mapping for CoinGecko
var CRYPTO_MAP={
    'BTC':'bitcoin','ETH':'ethereum','SOL':'solana','ADA':'cardano',
    'XRP':'ripple','DOT':'polkadot','DOGE':'dogecoin','SHIB':'shiba-inu',
    'AVAX':'avalanche-2','MATIC':'matic-network','LINK':'chainlink',
    'UNI':'uniswap','ATOM':'cosmos','LTC':'litecoin','FIL':'filecoin',
    'NEAR':'near','APT':'aptos','ARB':'arbitrum','OP':'optimism',
    'PEPE':'pepe','BONK':'bonk','WIF':'dogwifcoin','RENDER':'render-token',
    'FET':'fetch-ai','INJ':'injective-protocol','TIA':'celestia',
    'SUI':'sui','SEI':'sei-network','JUP':'jupiter-exchange-solana'
};

async function invRefreshPrices(){
    var btn=document.getElementById('inv-refresh-btn');
    btn.textContent='Refreshing...';btn.disabled=true;
    var updated=0;
    try{
        // Crypto prices via CoinGecko
        var cryptoInvs=invData.filter(function(i){return i.type==='crypto'&&i.ticker;});
        if(cryptoInvs.length){
            var ids=[];
            cryptoInvs.forEach(function(c){
                var cgId=CRYPTO_MAP[c.ticker.toUpperCase()];
                if(cgId&&ids.indexOf(cgId)===-1)ids.push(cgId);
            });
            if(ids.length){
                var resp=await fetch('https://api.coingecko.com/api/v3/simple/price?ids='+ids.join(',')+'&vs_currencies=usd');
                var prices=await resp.json();
                for(var i=0;i<cryptoInvs.length;i++){
                    var c=cryptoInvs[i];
                    var cgId=CRYPTO_MAP[c.ticker.toUpperCase()];
                    if(cgId&&prices[cgId]&&prices[cgId].usd&&c.quantity){
                        var newVal=prices[cgId].usd*parseFloat(c.quantity);
                        await sb.from('cockpit_investments').update({current_value:newVal}).eq('id',c.id);
                        updated++;
                    }
                }
            }
        }
        // Stock prices via Yahoo Finance v8 (free, no key)
        var stockInvs=invData.filter(function(i){return i.type==='stock'&&i.ticker;});
        for(var j=0;j<stockInvs.length;j++){
            var s=stockInvs[j];
            try{
                var sResp=await fetch('https://query1.finance.yahoo.com/v8/finance/chart/'+encodeURIComponent(s.ticker)+'?interval=1d&range=1d');
                var sData=await sResp.json();
                var price=sData.chart&&sData.chart.result&&sData.chart.result[0]&&sData.chart.result[0].meta?sData.chart.result[0].meta.regularMarketPrice:null;
                if(price&&s.quantity){
                    var sVal=price*parseFloat(s.quantity);
                    await sb.from('cockpit_investments').update({current_value:sVal}).eq('id',s.id);
                    updated++;
                }
            }catch(se){console.warn('Stock price fetch failed for '+s.ticker,se);}
        }
    }catch(err){console.error('Price refresh error:',err);}
    btn.textContent=updated?updated+' updated':'Refresh Prices';
    if(updated)setTimeout(function(){btn.textContent='Refresh Prices';},3000);
    btn.disabled=false;
    if(updated)invLoad();
}

invLoad();

// Realtime subscription for investments
sb.channel('investments_changes').on('postgres_changes',{event:'*',schema:'public',table:'cockpit_investments'},function(){invLoad();}).subscribe();

// =============================================
// CONTACTS / QUICK DIAL — Supabase-backed
// =============================================
var contactData=[];

async function contactLoad(){
    var {data}=await sb.from('cockpit_contacts').select('*').order('name');
    contactData=data||[];
    contactRender();
}

function contactRender(){
    var search=document.getElementById('contacts-search').value.toLowerCase().trim();
    var filtered=contactData.filter(function(c){
        if(!search)return true;
        return c.name.toLowerCase().indexOf(search)!==-1||(c.phone||'').indexOf(search)!==-1||(c.role||'').toLowerCase().indexOf(search)!==-1;
    });
    var list=document.getElementById('contacts-list');
    if(!filtered.length){list.innerHTML='<div style="text-align:center;padding:1rem;color:var(--clarity-dim);font-size:0.8rem;">'+(search?'No matches':'No contacts yet — click + to add')+'</div>';return;}
    var html='';
    filtered.forEach(function(c){
        var initials=c.name.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2);
        html+='<div class="contact-row">';
        html+='<div class="contact-avatar">'+initials+'</div>';
        html+='<div class="contact-info"><div class="contact-name">'+escapeHtml(c.name)+'</div><div class="contact-role">'+escapeHtml(c.role)+'</div></div>';
        html+='<div class="contact-actions">';
        if(c.phone)html+='<a href="tel:'+escapeHtml(c.phone)+'" class="contact-action" title="Call">📞</a><a href="sms:'+escapeHtml(c.phone)+'" class="contact-action" title="Text">💬</a>';
        if(c.email)html+='<a href="mailto:'+escapeHtml(c.email)+'" class="contact-action" title="Email">✉️</a>';
        html+='<button class="contact-action" onclick="contactOpenModal(\''+c.id+'\')" title="Edit">✏️</button>';
        html+='</div></div>';
    });
    list.innerHTML=html;
}

function contactOpenModal(editId){
    document.getElementById('contact-modal-overlay').classList.add('active');
    if(editId){
        var c=contactData.find(function(x){return x.id===editId;});
        if(!c)return;
        document.getElementById('contact-modal-title').textContent='Edit Contact';
        document.getElementById('contact-edit-id').value=c.id;
        document.getElementById('contact-modal-name').value=c.name;
        document.getElementById('contact-modal-phone').value=c.phone||'';
        document.getElementById('contact-modal-email').value=c.email||'';
        document.getElementById('contact-modal-role').value=c.role;
        document.getElementById('contact-modal-notes').value=c.notes||'';
    } else {
        document.getElementById('contact-modal-title').textContent='New Contact';
        document.getElementById('contact-edit-id').value='';
        document.getElementById('contact-modal-name').value='';
        document.getElementById('contact-modal-phone').value='';
        document.getElementById('contact-modal-email').value='';
        document.getElementById('contact-modal-role').value='Customer';
        document.getElementById('contact-modal-notes').value='';
    }
    document.getElementById('contact-modal-name').focus();
}

function contactCloseModal(){
    document.getElementById('contact-modal-overlay').classList.remove('active');
}

async function contactSave(){
    var editId=document.getElementById('contact-edit-id').value;
    var name=document.getElementById('contact-modal-name').value.trim();
    var phone=document.getElementById('contact-modal-phone').value.trim();
    var email=document.getElementById('contact-modal-email').value.trim();
    var role=document.getElementById('contact-modal-role').value;
    var notes=document.getElementById('contact-modal-notes').value.trim();
    if(!name)return;
    if(editId){
        await sb.from('cockpit_contacts').update({name:name,phone:phone,email:email,role:role,notes:notes}).eq('id',editId);
    } else {
        await sb.from('cockpit_contacts').insert({name:name,phone:phone,email:email,role:role,notes:notes});
    }
    contactCloseModal();
    contactLoad();
}

contactLoad();

// =============================================
// HABITS / WORKOUT TRACKER — Supabase-backed
// =============================================
var habitData=[], habitLogs={}, habitDate=new Date();

function habitDateStr(d){return d.toISOString().slice(0,10);}

async function habitLoad(){
    var {data}=await sb.from('cockpit_habits').select('*').order('category').order('name');
    habitData=data||[];
    await habitLoadLogs();
    habitRender();
}

async function habitLoadLogs(){
    var ds=habitDateStr(habitDate);
    var {data}=await sb.from('cockpit_habit_logs').select('*').eq('log_date',ds);
    habitLogs={};
    (data||[]).forEach(function(l){habitLogs[l.habit_id]=l;});
}

function habitRender(){
    var ds=habitDateStr(habitDate);
    var today=habitDateStr(new Date());
    var label=ds===today?'Today':habitDate.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
    document.getElementById('habit-date-label').textContent=label;
    var list=document.getElementById('habit-list');
    if(!habitData.length){list.innerHTML='<li style="text-align:center;padding:1rem;color:var(--clarity-dim);font-size:0.8rem;">No habits yet — click + to add</li>';return;}
    var html='';
    habitData.forEach(function(h){
        var log=habitLogs[h.id];
        var done=!!log;
        html+='<li class="habit-item">';
        html+='<div class="habit-check'+(done?' done':'')+'" onclick="habitToggle(\''+h.id+'\','+!done+')">'+(done?'✓':'')+'</div>';
        html+='<span class="habit-name">'+escapeHtml(h.name)+'</span>';
        html+='<span class="habit-cat">'+escapeHtml(h.category)+'</span>';
        html+='</li>';
    });
    list.innerHTML=html;
}

async function habitToggle(habitId,checked){
    var ds=habitDateStr(habitDate);
    if(checked){
        await sb.from('cockpit_habit_logs').upsert({habit_id:habitId,log_date:ds,value:'done'},{onConflict:'habit_id,log_date'});
    } else {
        await sb.from('cockpit_habit_logs').delete().eq('habit_id',habitId).eq('log_date',ds);
    }
    await habitLoadLogs();
    habitRender();
}

function habitPrevDay(){habitDate.setDate(habitDate.getDate()-1);habitLoadLogs().then(habitRender);}
function habitNextDay(){habitDate.setDate(habitDate.getDate()+1);habitLoadLogs().then(habitRender);}

function habitOpenAdd(){
    var row=document.getElementById('habit-add-row');
    row.style.display=row.style.display==='none'?'flex':'none';
    if(row.style.display==='flex')document.getElementById('habit-new-name').focus();
}

async function habitAdd(){
    var name=document.getElementById('habit-new-name').value.trim();
    var cat=document.getElementById('habit-new-cat').value;
    if(!name)return;
    await sb.from('cockpit_habits').insert({name:name,category:cat,icon:'x'});
    document.getElementById('habit-new-name').value='';
    document.getElementById('habit-add-row').style.display='none';
    habitLoad();
}

habitLoad();

// =============================================
// MEAL PLAN — Supabase-backed
// =============================================
var mealDay=new Date().getDay();
var mealData=[];
var MEAL_DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
var MEAL_TYPES=['Breakfast','Lunch','Dinner','Snack'];

function mealRenderDays(){
    var html='';
    MEAL_DAYS.forEach(function(d,i){
        html+='<button class="meal-day-btn'+(i===mealDay?' active':'')+'" onclick="mealSelectDay('+i+')">'+d+'</button>';
    });
    document.getElementById('meal-days').innerHTML=html;
}

function mealSelectDay(d){mealDay=d;mealRenderDays();mealRender();}

async function mealLoad(){
    var {data}=await sb.from('cockpit_meals').select('*').order('meal_type').order('name');
    mealData=data||[];
    mealRenderDays();
    mealRender();
}

function mealRender(){
    var filtered=mealData.filter(function(m){return m.day===mealDay;});
    var content=document.getElementById('meal-content');
    var totalCal=0;
    var html='';
    MEAL_TYPES.forEach(function(type){
        var items=filtered.filter(function(m){return m.meal_type===type;});
        if(!items.length)return;
        html+='<div class="meal-section"><div class="meal-section-label">'+type+'</div>';
        items.forEach(function(m){
            totalCal+=m.calories||0;
            html+='<div class="meal-item"><span style="flex:1;">'+escapeHtml(m.name)+'</span>';
            if(m.calories)html+='<span class="meal-item-cal">'+m.calories+' cal</span>';
            html+='<button class="meal-item-del" onclick="mealDelete(\''+m.id+'\')">&times;</button></div>';
        });
        html+='</div>';
    });
    if(!html)html='<div style="text-align:center;padding:1rem;color:var(--clarity-dim);font-size:0.8rem;">No meals planned for '+MEAL_DAYS[mealDay]+'</div>';
    content.innerHTML=html;
    document.getElementById('meal-total').textContent=totalCal?'Total: '+totalCal+' cal':'';
}

async function mealAdd(){
    var type=document.getElementById('meal-type-sel').value;
    var name=document.getElementById('meal-name').value.trim();
    var cal=parseInt(document.getElementById('meal-cal').value)||0;
    if(!name)return;
    await sb.from('cockpit_meals').insert({day:mealDay,meal_type:type,name:name,calories:cal});
    document.getElementById('meal-name').value='';
    document.getElementById('meal-cal').value='';
    mealLoad();
}

async function mealDelete(id){
    await sb.from('cockpit_meals').delete().eq('id',id);
    mealLoad();
}

mealLoad();

// =============================================
// STRETCH + BREATHE — 10-Minute Guided Routine
// =============================================
var STRETCH_ROUTINE=[
    {name:'Neck Rolls',duration:45,cue:'Slowly roll your head in circles. 5 clockwise, 5 counter-clockwise. Let the weight of your head do the work.'},
    {name:'Shoulder Shrugs & Rolls',duration:40,cue:'Shrug shoulders to ears, hold 3s, release. Then roll shoulders forward 5x, backward 5x.'},
    {name:'Standing Side Stretch',duration:50,cue:'Reach right arm overhead, lean left. Hold 25s. Switch sides. Feel the stretch along your ribs.'},
    {name:'Forward Fold',duration:50,cue:'Hinge at hips, let arms hang heavy. Bend knees slightly. Let gravity pull you down. Shake your head yes and no.'},
    {name:'Cat-Cow (Standing)',duration:45,cue:'Hands on knees. Round your back up like a cat (exhale), then arch and look up (inhale). Slow and fluid.'},
    {name:'Hip Circles',duration:40,cue:'Hands on hips, make big circles. 5 clockwise, 5 counter-clockwise. Loosen up those hip joints.'},
    {name:'Quad Stretch',duration:50,cue:'Stand on one leg, pull opposite foot to glute. Hold 25s each side. Use a wall for balance if needed.'},
    {name:'Hamstring Stretch',duration:50,cue:'Step one foot forward, hinge at hips, reach toward toes. 25s each leg. Keep back straight.'},
    {name:'Chest Opener',duration:45,cue:'Clasp hands behind your back, squeeze shoulder blades, lift chest. Open up that front body. Breathe deep.'},
    {name:'Seated Spinal Twist',duration:50,cue:'Sit cross-legged or in a chair. Twist right, left hand on right knee. 25s each side. Look over your shoulder.'},
    {name:'Pigeon Stretch (Figure 4)',duration:55,cue:'Cross right ankle over left knee, sit back slightly. Hold 27s, switch. Deep hip opener.'},
    {name:'Final Breathing — Box Breath',duration:60,cue:'Close your eyes. 4 count inhale, 4 count hold, 4 count exhale, 4 count hold. 4 full cycles. You earned this.'}
];
var STRETCH_TOTAL=0;STRETCH_ROUTINE.forEach(function(s){STRETCH_TOTAL+=s.duration;});

var stretchIndex=0,stretchTimeLeft=0,stretchTotalElapsed=0,stretchPlaying=false,stretchInterval=null;
var breathPhase='ready',breathCycle=0;

// Breathing: 4s inhale, 2s hold, 6s exhale = 12s cycle
var BREATH_INHALE=4,BREATH_HOLD=2,BREATH_EXHALE=6,BREATH_CYCLE=12;

function stretchFormatTime(s){var m=Math.floor(s/60);var sec=s%60;return m+':'+(sec<10?'0':'')+sec;}

function stretchRenderUpcoming(){
    var html='<div class="stretch-upcoming-label">Routine</div><div class="stretch-upcoming-list">';
    STRETCH_ROUTINE.forEach(function(s,i){
        html+='<div class="stretch-up-item'+(i===stretchIndex?' active':'')+'"><span class="stretch-up-num">'+(i+1)+'</span>'+escapeHtml(s.name)+' <span style="margin-left:auto;font-family:JetBrains Mono,monospace;font-size:0.6rem;color:var(--clarity-dim);">'+stretchFormatTime(s.duration)+'</span></div>';
    });
    html+='</div>';
    document.getElementById('stretch-upcoming').innerHTML=html;
}

function stretchRenderCurrent(){
    var step=STRETCH_ROUTINE[stretchIndex];
    document.getElementById('stretch-name').textContent=step.name;
    document.getElementById('stretch-cue').textContent=step.cue;
    document.getElementById('stretch-step-label').textContent=(stretchIndex+1)+' / '+STRETCH_ROUTINE.length;
    document.getElementById('stretch-prev-btn').disabled=stretchIndex===0;
    stretchRenderUpcoming();
}

function stretchUpdateTimer(){
    // Total time remaining
    var remaining=0;
    for(var i=stretchIndex;i<STRETCH_ROUTINE.length;i++){
        remaining+=(i===stretchIndex?stretchTimeLeft:STRETCH_ROUTINE[i].duration);
    }
    document.getElementById('stretch-timer').textContent=stretchFormatTime(remaining);

    // Progress bar
    var elapsed=0;
    for(var j=0;j<stretchIndex;j++){elapsed+=STRETCH_ROUTINE[j].duration;}
    elapsed+=(STRETCH_ROUTINE[stretchIndex].duration-stretchTimeLeft);
    var pct=Math.round((elapsed/STRETCH_TOTAL)*100);
    document.getElementById('stretch-progress').style.width=pct+'%';
}

function stretchUpdateBreath(){
    var circle=document.getElementById('stretch-circle');
    var label=document.getElementById('stretch-breath-label');
    var elapsed=STRETCH_ROUTINE[stretchIndex].duration-stretchTimeLeft;
    var pos=elapsed%BREATH_CYCLE;
    if(pos<BREATH_INHALE){
        circle.className='stretch-breath-circle inhale';
        label.textContent='Inhale';
    } else if(pos<BREATH_INHALE+BREATH_HOLD){
        circle.className='stretch-breath-circle hold';
        label.textContent='Hold';
    } else {
        circle.className='stretch-breath-circle exhale';
        label.textContent='Exhale';
    }
}

function stretchTick(){
    if(stretchTimeLeft<=0){
        // Next step
        if(stretchIndex<STRETCH_ROUTINE.length-1){
            stretchIndex++;
            stretchTimeLeft=STRETCH_ROUTINE[stretchIndex].duration;
            stretchRenderCurrent();
        } else {
            // Done!
            stretchStop();
            document.getElementById('stretch-name').textContent='All Done!';
            document.getElementById('stretch-cue').textContent='Great job, Tiger. 10 minutes well spent. You\'re loose, focused, and ready to go.';
            document.getElementById('stretch-circle').className='stretch-breath-circle';
            document.getElementById('stretch-breath-label').textContent='Done';
            document.getElementById('stretch-progress').style.width='100%';
            document.getElementById('stretch-play-btn').textContent='Start';
            return;
        }
    }
    stretchTimeLeft--;
    stretchUpdateTimer();
    stretchUpdateBreath();
}

function stretchToggle(){
    if(stretchPlaying){
        stretchStop();
        document.getElementById('stretch-play-btn').textContent='Resume';
    } else {
        if(document.getElementById('stretch-play-btn').textContent==='Start'){
            stretchIndex=0;
            stretchTimeLeft=STRETCH_ROUTINE[0].duration;
            stretchRenderCurrent();
        }
        stretchPlaying=true;
        document.getElementById('stretch-play-btn').textContent='Pause';
        stretchInterval=setInterval(stretchTick,1000);
        stretchUpdateBreath();
    }
}

function stretchStop(){
    stretchPlaying=false;
    if(stretchInterval){clearInterval(stretchInterval);stretchInterval=null;}
}

function stretchNext(){
    if(stretchIndex<STRETCH_ROUTINE.length-1){
        stretchIndex++;
        stretchTimeLeft=STRETCH_ROUTINE[stretchIndex].duration;
        stretchRenderCurrent();
        stretchUpdateTimer();
        if(stretchPlaying)stretchUpdateBreath();
    }
}

function stretchPrev(){
    if(stretchIndex>0){
        stretchIndex--;
        stretchTimeLeft=STRETCH_ROUTINE[stretchIndex].duration;
        stretchRenderCurrent();
        stretchUpdateTimer();
        if(stretchPlaying)stretchUpdateBreath();
    }
}

function stretchReset(){
    stretchStop();
    stretchIndex=0;
    stretchTimeLeft=STRETCH_ROUTINE[0].duration;
    document.getElementById('stretch-circle').className='stretch-breath-circle';
    document.getElementById('stretch-breath-label').textContent='Ready';
    document.getElementById('stretch-timer').textContent=stretchFormatTime(STRETCH_TOTAL);
    document.getElementById('stretch-progress').style.width='0%';
    document.getElementById('stretch-play-btn').textContent='Start';
    stretchRenderCurrent();
    document.getElementById('stretch-name').textContent='Press Start';
    document.getElementById('stretch-cue').textContent='A 10-minute guided routine \u2014 stretching + box breathing for focus and recovery.';
}

// Init
document.getElementById('stretch-timer').textContent=stretchFormatTime(STRETCH_TOTAL);
stretchRenderUpcoming();

// =============================================
// SPOTIFY — PKCE Auth + Web Playback SDK + Search + Queue
// =============================================
var SP_CLIENT_ID='e10a999e9e564b1d808b6c64a83c7b34';
var SP_REDIRECT='https://cockpit-hq.netlify.app';
var SP_SCOPES='streaming user-read-email user-read-private user-library-read user-read-playback-state user-modify-playback-state user-read-currently-playing playlist-read-private playlist-read-collaborative';
var spToken=localStorage.getItem('sp_token')||null;
var spTokenExpiry=parseInt(localStorage.getItem('sp_token_expiry'))||0;
var spPlayer=null;
var spDeviceId=null;
var spProgressInterval=null;
var spCurrentState=null;
var spUseRemote=false;
var spPollTimer=null;
var spSearchTimer=null;
var spSDKRetries=0;
var spShuffleState=false;
var spRepeatState='off';

// PKCE helpers
function spGenerateRandom(len){var arr=new Uint8Array(len);crypto.getRandomValues(arr);return Array.from(arr,function(b){return b.toString(16).padStart(2,'0');}).join('');}
async function spSha256(plain){var enc=new TextEncoder().encode(plain);var hash=await crypto.subtle.digest('SHA-256',enc);return hash;}
function spBase64Encode(buf){return btoa(String.fromCharCode.apply(null,new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}

async function spConnect(){
    var verifier=spGenerateRandom(64);
    localStorage.setItem('sp_verifier',verifier);
    var hashed=await spSha256(verifier);
    var challenge=spBase64Encode(hashed);
    var url='https://accounts.spotify.com/authorize?client_id='+SP_CLIENT_ID+'&response_type=code&redirect_uri='+encodeURIComponent(SP_REDIRECT)+'&scope='+encodeURIComponent(SP_SCOPES)+'&code_challenge_method=S256&code_challenge='+challenge;
    window.location.href=url;
}

async function spExchangeCode(code){
    var verifier=localStorage.getItem('sp_verifier');
    var body='client_id='+SP_CLIENT_ID+'&grant_type=authorization_code&code='+code+'&redirect_uri='+encodeURIComponent(SP_REDIRECT)+'&code_verifier='+verifier;
    try{
        var resp=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body});
        var data=await resp.json();
        if(data.access_token){
            spToken=data.access_token;
            spTokenExpiry=Date.now()+(data.expires_in*1000);
            localStorage.setItem('sp_token',spToken);
            localStorage.setItem('sp_token_expiry',spTokenExpiry.toString());
            if(data.refresh_token)localStorage.setItem('sp_refresh_token',data.refresh_token);
            localStorage.removeItem('sp_verifier');
            spInit();
        } else {
            console.error('Spotify token exchange failed:',data);
            spStatus('Auth failed — try again');
        }
    }catch(e){console.error('Spotify token exchange error:',e);spStatus('Auth error');}
}

async function spRefreshToken(){
    var rt=localStorage.getItem('sp_refresh_token');
    if(!rt){spToken=null;return;}
    try{
        var body='client_id='+SP_CLIENT_ID+'&grant_type=refresh_token&refresh_token='+rt;
        var resp=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body});
        var data=await resp.json();
        if(data.access_token){
            spToken=data.access_token;
            spTokenExpiry=Date.now()+(data.expires_in*1000);
            localStorage.setItem('sp_token',spToken);
            localStorage.setItem('sp_token_expiry',spTokenExpiry.toString());
            if(data.refresh_token)localStorage.setItem('sp_refresh_token',data.refresh_token);
        } else {
            console.error('Spotify refresh failed:',data);
            spToken=null;
            localStorage.removeItem('sp_token');
        }
    }catch(e){console.error('Spotify refresh error:',e);spToken=null;}
}

function spStatus(msg){var el=document.getElementById('sp-status');if(el)el.textContent=msg;}

function spShowDeviceBadge(name){
    var badge=document.getElementById('sp-device-badge');
    if(badge){badge.textContent=name;badge.style.display='inline';}
}

async function spApi(endpoint,method,body){
    if(!spToken){spStatus('Not connected');return null;}
    if(Date.now()>spTokenExpiry-60000)await spRefreshToken();
    if(!spToken){spStatus('Session expired — reconnect');return null;}
    var opts={headers:{'Authorization':'Bearer '+spToken}};
    if(method){opts.method=method;}
    if(body){opts.body=JSON.stringify(body);opts.headers['Content-Type']='application/json';}
    try{
        var resp=await fetch('https://api.spotify.com/v1'+endpoint,opts);
        if(resp.status===204)return true;
        if(resp.status===202)return true;
        if(resp.status===401){
            await spRefreshToken();
            if(spToken){
                opts.headers['Authorization']='Bearer '+spToken;
                resp=await fetch('https://api.spotify.com/v1'+endpoint,opts);
                if(resp.status===204||resp.status===202)return true;
                if(!resp.ok){spStatus('Auth retry failed');return null;}
            } else {
                spStatus('Session expired — reconnect');return null;
            }
        }
        if(resp.status===403){spStatus('Premium required for this');return null;}
        if(resp.status===404){return null;}
        if(!resp.ok){var err=await resp.text();console.error('Spotify API '+resp.status+':',err);return null;}
        var text=await resp.text();
        if(!text)return null;
        return JSON.parse(text);
    }catch(e){console.error('Spotify fetch error:',e);spStatus('Network error');return null;}
}

function spFormatMs(ms){if(!ms||ms<0)return '0:00';var s=Math.floor(ms/1000);var m=Math.floor(s/60);s=s%60;return m+':'+(s<10?'0':'')+s;}

function spInit(){
    document.getElementById('sp-login-view').style.display='none';
    document.getElementById('sp-player-view').style.display='block';
    document.getElementById('sp-connect-btn').textContent='Connected';
    document.getElementById('sp-connect-btn').style.borderColor='var(--green)';
    document.getElementById('sp-connect-btn').style.color='var(--green)';

    spApi('/me').then(function(u){
        if(u&&u.display_name)document.getElementById('sp-user').textContent=u.display_name;
    });

    spLoadPlaylists();
    spInitPlayer();
}

function spInitPlayer(){
    if(typeof Spotify==='undefined'){
        window.onSpotifyWebPlaybackSDKReady=function(){spInitPlayer();};
        spStatus('Loading SDK...');
        return;
    }

    if(spPlayer){
        try{spPlayer.disconnect();}catch(e){}
        spPlayer=null;
    }

    spPlayer=new Spotify.Player({name:'Command Cockpit',getOAuthToken:function(cb){
        if(Date.now()>spTokenExpiry-60000){spRefreshToken().then(function(){cb(spToken);});}
        else{cb(spToken);}
    },volume:0.5});

    spStatus('Connecting SDK...');

    spPlayer.addListener('ready',function(d){
        spDeviceId=d.device_id;
        spUseRemote=false;
        spSDKRetries=0;
        spStatus('');
        spShowDeviceBadge('SDK Player');
        console.log('Spotify SDK ready, device:',spDeviceId);
        // Transfer playback to cockpit
        spApi('/me/player','PUT',{device_ids:[spDeviceId],play:false});
        // Get current state
        setTimeout(function(){
            spPlayer.getCurrentState().then(function(state){
                if(state)spUpdateFromSDKState(state);
            });
        },1000);
    });

    spPlayer.addListener('player_state_changed',function(state){
        if(!state)return;
        spCurrentState=state;
        spUpdateFromSDKState(state);
    });

    spPlayer.addListener('initialization_error',function(e){
        console.error('Spotify init error:',e);
        if(spSDKRetries<2){spSDKRetries++;setTimeout(spInitPlayer,2000);spStatus('SDK init failed, retrying...');}
        else spFallbackRemote();
    });
    spPlayer.addListener('authentication_error',function(e){
        console.error('Spotify auth error:',e);
        spRefreshToken().then(function(){
            if(spToken&&spSDKRetries<2){spSDKRetries++;setTimeout(spInitPlayer,1000);}
            else spFallbackRemote();
        });
    });
    spPlayer.addListener('account_error',function(e){
        console.error('Spotify account error:',e);
        spFallbackRemote();
    });

    spPlayer.connect().then(function(ok){
        if(!ok){
            if(spSDKRetries<2){spSDKRetries++;setTimeout(spInitPlayer,2000);spStatus('Reconnecting SDK...');}
            else{console.log('SDK connect failed, falling back');spFallbackRemote();}
        }
    });
}

function spUpdateFromSDKState(state){
    var track=state.track_window.current_track;
    document.getElementById('sp-track').textContent=track.name;
    document.getElementById('sp-artist').textContent=track.artists.map(function(a){return a.name;}).join(', ');
    if(track.album.images&&track.album.images.length){
        var img=document.getElementById('sp-art');
        img.src=track.album.images[track.album.images.length>1?1:0].url;
        img.style.display='block';
    }
    document.getElementById('sp-play-btn').textContent=state.paused?'▶':'⏸';
    document.getElementById('sp-time-dur').textContent=spFormatMs(state.duration);
    spShuffleState=state.shuffle;
    spRepeatState=({0:'off',1:'context',2:'track'})[state.repeat_mode]||'off';
    spUpdateToggleButtons();

    if(spProgressInterval)clearInterval(spProgressInterval);
    if(!state.paused){
        spProgressInterval=setInterval(function(){
            if(!spPlayer)return;
            spPlayer.getCurrentState().then(function(s){
                if(!s)return;
                document.getElementById('sp-time-cur').textContent=spFormatMs(s.position);
                var pct=s.duration?((s.position/s.duration)*100):0;
                document.getElementById('sp-progress').style.width=pct+'%';
            });
        },1000);
    } else {
        document.getElementById('sp-time-cur').textContent=spFormatMs(state.position);
        var pct=state.duration?((state.position/state.duration)*100):0;
        document.getElementById('sp-progress').style.width=pct+'%';
    }
}

function spUpdateToggleButtons(){
    var shBtn=document.getElementById('sp-shuffle-btn');
    var rpBtn=document.getElementById('sp-repeat-btn');
    if(shBtn)shBtn.style.opacity=spShuffleState?'1':'0.4';
    if(rpBtn){
        rpBtn.style.opacity=spRepeatState==='off'?'0.4':'1';
        rpBtn.textContent=spRepeatState==='track'?'🔂':'🔁';
    }
}

// Fallback: remote device control
async function spFallbackRemote(){
    spUseRemote=true;
    if(spPlayer){try{spPlayer.disconnect();}catch(e){}}
    spPlayer=null;
    spStatus('Looking for devices...');
    await spRefreshDevices();
    spPollRemote();
}

async function spRefreshDevices(){
    var devices=await spApi('/me/player/devices');
    if(devices&&devices.devices&&devices.devices.length){
        var active=devices.devices.find(function(d){return d.is_active;});
        var dev=active||devices.devices[0];
        spDeviceId=dev.id;
        spStatus('');
        spShowDeviceBadge(dev.name);
        console.log('Remote device:',dev.name,dev.id);
        return true;
    } else {
        spStatus('No devices — open Spotify app');
        spDeviceId=null;
        return false;
    }
}

function spPollRemote(){
    if(spPollTimer)clearInterval(spPollTimer);
    var noDeviceCount=0;
    spPollTimer=setInterval(async function(){
        if(!spUseRemote)return;
        var state=await spApi('/me/player');
        if(!state||!state.item){
            noDeviceCount++;
            if(noDeviceCount%5===0)await spRefreshDevices();
            return;
        }
        noDeviceCount=0;
        var track=state.item;
        document.getElementById('sp-track').textContent=track.name;
        document.getElementById('sp-artist').textContent=track.artists.map(function(a){return a.name;}).join(', ');
        if(track.album&&track.album.images&&track.album.images.length){
            var img=document.getElementById('sp-art');
            img.src=track.album.images[track.album.images.length>1?1:0].url;
            img.style.display='block';
        }
        document.getElementById('sp-play-btn').textContent=state.is_playing?'⏸':'▶';
        document.getElementById('sp-time-cur').textContent=spFormatMs(state.progress_ms);
        document.getElementById('sp-time-dur').textContent=spFormatMs(track.duration_ms);
        var pct=track.duration_ms?((state.progress_ms/track.duration_ms)*100):0;
        document.getElementById('sp-progress').style.width=pct+'%';
        if(state.device){spDeviceId=state.device.id;spShowDeviceBadge(state.device.name);}
        spShuffleState=state.shuffle_state;
        spRepeatState=state.repeat_state||'off';
        spUpdateToggleButtons();
    },2000);
}

async function spLoadPlaylists(){
    var el=document.getElementById('sp-playlists');
    el.innerHTML='<div style="text-align:center;padding:1rem;font-size:0.78rem;color:var(--clarity-dim);">Loading library...</div>';
    var html='';

    var saved=await spApi('/me/tracks?limit=1');
    if(saved&&saved.total){
        html+='<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.3rem;cursor:pointer;border-radius:4px;transition:background 0.1s;" onclick="spPlayLiked()" onmouseover="this.style.background=\'var(--ember)\'" onmouseout="this.style.background=\'none\'">';
        html+='<div style="width:32px;height:32px;border-radius:4px;background:linear-gradient(135deg,#4B27E8,#1DB954);display:flex;align-items:center;justify-content:center;font-size:0.9rem;">&#9829;</div>';
        html+='<div style="flex:1;min-width:0;"><div style="font-size:0.78rem;font-weight:600;color:var(--clarity);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Liked Songs</div><div style="font-size:0.62rem;color:var(--clarity-dim);">'+saved.total+' tracks</div></div>';
        html+='</div>';
    }

    var data=await spApi('/me/playlists?limit=50');
    if(data&&data.items&&data.items.length){
        data.items.forEach(function(p){
            var img=p.images&&p.images.length?p.images[p.images.length-1].url:'';
            html+='<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.3rem;cursor:pointer;border-radius:4px;transition:background 0.1s;" onclick="spPlayPlaylist(\''+p.uri+'\')" onmouseover="this.style.background=\'var(--ember)\'" onmouseout="this.style.background=\'none\'">';
            if(img)html+='<img src="'+img+'" style="width:32px;height:32px;border-radius:4px;object-fit:cover;">';
            else html+='<div style="width:32px;height:32px;border-radius:4px;background:var(--clarity-dim);display:flex;align-items:center;justify-content:center;font-size:0.8rem;">&#9835;</div>';
            html+='<div style="flex:1;min-width:0;"><div style="font-size:0.78rem;font-weight:600;color:var(--clarity);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(p.name)+'</div><div style="font-size:0.62rem;color:var(--clarity-dim);">'+p.tracks.total+' tracks</div></div>';
            html+='</div>';
        });
    }

    if(!html){el.innerHTML='<div style="font-size:0.78rem;color:var(--clarity-dim);padding:0.5rem;">No playlists found</div>';return;}
    el.innerHTML=html;
}

// --- Playback Controls ---
async function spEnsureDevice(){
    if(spDeviceId)return true;
    if(spUseRemote){
        var found=await spRefreshDevices();
        return found;
    }
    spStatus('No device — connecting...');
    return false;
}

async function spPlayPlaylist(uri){
    if(!await spEnsureDevice()){spStatus('No device — open Spotify');return;}
    spStatus('Starting...');
    await spApi('/me/player','PUT',{device_ids:[spDeviceId],play:false});
    await spApi('/me/player/play?device_id='+spDeviceId,'PUT',{context_uri:uri});
    spStatus('');
}

async function spPlayLiked(){
    if(!await spEnsureDevice()){spStatus('No device — open Spotify');return;}
    spStatus('Loading liked songs...');
    var data=await spApi('/me/tracks?limit=50');
    if(!data||!data.items||!data.items.length){spStatus('No liked songs');return;}
    var uris=data.items.map(function(item){return item.track.uri;});
    await spApi('/me/player','PUT',{device_ids:[spDeviceId],play:false});
    await spApi('/me/player/play?device_id='+spDeviceId,'PUT',{uris:uris});
    spStatus('');
}

async function spPlayPause(){
    if(!await spEnsureDevice())return;
    if(spUseRemote){
        var state=await spApi('/me/player');
        if(!state){
            await spApi('/me/player','PUT',{device_ids:[spDeviceId]});
            await spApi('/me/player/play?device_id='+spDeviceId,'PUT');
            return;
        }
        if(state.is_playing)await spApi('/me/player/pause','PUT');
        else await spApi('/me/player/play','PUT');
    } else if(spPlayer){
        spPlayer.togglePlay();
    }
}

async function spNext(){
    if(!await spEnsureDevice())return;
    if(spUseRemote)await spApi('/me/player/next','POST');
    else if(spPlayer)spPlayer.nextTrack();
}

async function spPrev(){
    if(!await spEnsureDevice())return;
    if(spUseRemote)await spApi('/me/player/previous','POST');
    else if(spPlayer)spPlayer.previousTrack();
}

function spSetVolume(val){
    if(spUseRemote)spApi('/me/player/volume?volume_percent='+val,'PUT');
    else if(spPlayer)spPlayer.setVolume(val/100);
}

function spSeek(e){
    var rect=e.currentTarget.getBoundingClientRect();
    var pct=(e.clientX-rect.left)/rect.width;
    if(spUseRemote){
        spApi('/me/player').then(function(state){
            if(!state||!state.item)return;
            var pos=Math.floor(pct*state.item.duration_ms);
            spApi('/me/player/seek?position_ms='+pos,'PUT');
        });
    } else if(spPlayer&&spCurrentState){
        spPlayer.seek(Math.floor(pct*spCurrentState.duration));
    }
}

async function spShuffle(){
    spShuffleState=!spShuffleState;
    spUpdateToggleButtons();
    await spApi('/me/player/shuffle?state='+spShuffleState,'PUT');
}

async function spRepeat(){
    var next=spRepeatState==='off'?'context':spRepeatState==='context'?'track':'off';
    spRepeatState=next;
    spUpdateToggleButtons();
    await spApi('/me/player/repeat?state='+next,'PUT');
}

// --- Tab Switching ---
function spSwitchTab(tab){
    ['library','search','queue'].forEach(function(t){
        document.getElementById('sp-panel-'+t).style.display=t===tab?'block':'none';
        var btn=document.getElementById('sp-tab-'+t);
        btn.style.color=t===tab?'var(--fire)':'var(--clarity-dim)';
        btn.style.borderBottom=t===tab?'2px solid var(--fire)':'2px solid transparent';
    });
    if(tab==='search')document.getElementById('sp-search-input').focus();
    if(tab==='queue')spLoadQueue();
}

// --- Search ---
function spSearchDebounce(){
    if(spSearchTimer)clearTimeout(spSearchTimer);
    spSearchTimer=setTimeout(spSearch,350);
}

async function spSearch(){
    var q=document.getElementById('sp-search-input').value.trim();
    var el=document.getElementById('sp-search-results');
    if(!q){el.innerHTML='';return;}

    el.innerHTML='<div style="text-align:center;padding:1rem;font-size:0.78rem;color:var(--clarity-dim);">Searching...</div>';

    var data=await spApi('/search?q='+encodeURIComponent(q)+'&type=track,artist,album&limit=8');
    if(!data){el.innerHTML='<div style="padding:0.5rem;font-size:0.78rem;color:var(--clarity-dim);">No results</div>';return;}

    var html='';

    // Tracks
    if(data.tracks&&data.tracks.items&&data.tracks.items.length){
        html+='<div style="font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--fire);padding:0.3rem 0;">Songs</div>';
        data.tracks.items.forEach(function(t){
            var img=t.album&&t.album.images&&t.album.images.length?t.album.images[t.album.images.length-1].url:'';
            var artists=t.artists.map(function(a){return a.name;}).join(', ');
            var uri=t.uri;
            html+='<div style="display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0.2rem;cursor:pointer;border-radius:4px;transition:background 0.1s;" onmouseover="this.style.background=\'var(--ember)\'" onmouseout="this.style.background=\'none\'">';
            if(img)html+='<img src="'+img+'" style="width:32px;height:32px;border-radius:4px;object-fit:cover;" onclick="spPlayUri(\''+uri+'\')">';
            else html+='<div style="width:32px;height:32px;border-radius:4px;background:rgba(0,0,0,0.05);display:flex;align-items:center;justify-content:center;font-size:0.8rem;" onclick="spPlayUri(\''+uri+'\')">&#9835;</div>';
            html+='<div style="flex:1;min-width:0;" onclick="spPlayUri(\''+uri+'\')">';
            html+='<div style="font-size:0.78rem;font-weight:600;color:var(--clarity);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(t.name)+'</div>';
            html+='<div style="font-size:0.62rem;color:var(--clarity-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(artists)+'</div>';
            html+='</div>';
            html+='<button onclick="spAddToQueue(\''+uri+'\')" title="Add to queue" style="border:none;background:none;cursor:pointer;font-size:0.8rem;opacity:0.5;padding:0.2rem;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">+</button>';
            html+='</div>';
        });
    }

    // Artists
    if(data.artists&&data.artists.items&&data.artists.items.length){
        html+='<div style="font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--fire);padding:0.5rem 0 0.3rem;">Artists</div>';
        data.artists.items.slice(0,4).forEach(function(a){
            var img=a.images&&a.images.length?a.images[a.images.length-1].url:'';
            var uri=a.uri;
            html+='<div style="display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0.2rem;cursor:pointer;border-radius:4px;transition:background 0.1s;" onclick="spPlayContext(\''+uri+'\')" onmouseover="this.style.background=\'var(--ember)\'" onmouseout="this.style.background=\'none\'">';
            if(img)html+='<img src="'+img+'" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">';
            else html+='<div style="width:32px;height:32px;border-radius:50%;background:rgba(0,0,0,0.05);display:flex;align-items:center;justify-content:center;font-size:0.7rem;">🎤</div>';
            html+='<div style="flex:1;min-width:0;"><div style="font-size:0.78rem;font-weight:600;color:var(--clarity);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(a.name)+'</div>';
            var followers=a.followers?a.followers.total:0;
            if(followers)html+='<div style="font-size:0.62rem;color:var(--clarity-dim);">'+followers.toLocaleString()+' followers</div>';
            html+='</div></div>';
        });
    }

    // Albums
    if(data.albums&&data.albums.items&&data.albums.items.length){
        html+='<div style="font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--fire);padding:0.5rem 0 0.3rem;">Albums</div>';
        data.albums.items.slice(0,4).forEach(function(al){
            var img=al.images&&al.images.length?al.images[al.images.length-1].url:'';
            var uri=al.uri;
            var artist=al.artists&&al.artists.length?al.artists[0].name:'';
            html+='<div style="display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0.2rem;cursor:pointer;border-radius:4px;transition:background 0.1s;" onclick="spPlayContext(\''+uri+'\')" onmouseover="this.style.background=\'var(--ember)\'" onmouseout="this.style.background=\'none\'">';
            if(img)html+='<img src="'+img+'" style="width:32px;height:32px;border-radius:4px;object-fit:cover;">';
            else html+='<div style="width:32px;height:32px;border-radius:4px;background:rgba(0,0,0,0.05);display:flex;align-items:center;justify-content:center;font-size:0.7rem;">💿</div>';
            html+='<div style="flex:1;min-width:0;"><div style="font-size:0.78rem;font-weight:600;color:var(--clarity);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(al.name)+'</div>';
            if(artist)html+='<div style="font-size:0.62rem;color:var(--clarity-dim);">'+escapeHtml(artist)+' · '+al.total_tracks+' tracks</div>';
            html+='</div></div>';
        });
    }

    el.innerHTML=html||'<div style="padding:0.5rem;font-size:0.78rem;color:var(--clarity-dim);">No results found</div>';
}

async function spPlayUri(uri){
    if(!await spEnsureDevice()){spStatus('No device');return;}
    await spApi('/me/player','PUT',{device_ids:[spDeviceId],play:false});
    await spApi('/me/player/play?device_id='+spDeviceId,'PUT',{uris:[uri]});
    spStatus('');
}

async function spPlayContext(contextUri){
    if(!await spEnsureDevice()){spStatus('No device');return;}
    await spApi('/me/player','PUT',{device_ids:[spDeviceId],play:false});
    await spApi('/me/player/play?device_id='+spDeviceId,'PUT',{context_uri:contextUri});
    spStatus('');
}

async function spAddToQueue(uri){
    if(!await spEnsureDevice()){spStatus('No device');return;}
    var result=await spApi('/me/player/queue?uri='+encodeURIComponent(uri),'POST');
    if(result!==null)spStatus('Added to queue');
    setTimeout(function(){spStatus('');},1500);
}

// --- Queue ---
async function spLoadQueue(){
    var el=document.getElementById('sp-queue-list');
    el.innerHTML='<div style="text-align:center;padding:1rem;font-size:0.78rem;color:var(--clarity-dim);">Loading queue...</div>';

    var data=await spApi('/me/player/queue');
    if(!data){el.innerHTML='<div style="padding:1rem;text-align:center;font-size:0.78rem;color:var(--clarity-dim);">Play something to see your queue</div>';return;}

    var html='';

    // Currently playing
    if(data.currently_playing){
        var c=data.currently_playing;
        var img=c.album&&c.album.images&&c.album.images.length?c.album.images[c.album.images.length-1].url:'';
        var artists=c.artists?c.artists.map(function(a){return a.name;}).join(', '):'';
        html+='<div style="font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--fire);padding:0.3rem 0;">Now Playing</div>';
        html+='<div style="display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0.2rem;background:var(--ember);border-radius:4px;margin-bottom:0.5rem;">';
        if(img)html+='<img src="'+img+'" style="width:32px;height:32px;border-radius:4px;object-fit:cover;">';
        html+='<div style="flex:1;min-width:0;">';
        html+='<div style="font-size:0.78rem;font-weight:600;color:var(--clarity);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(c.name)+'</div>';
        html+='<div style="font-size:0.62rem;color:var(--clarity-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(artists)+'</div>';
        html+='</div></div>';
    }

    // Queue
    if(data.queue&&data.queue.length){
        html+='<div style="font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--clarity-dim);padding:0.3rem 0;">Up Next</div>';
        data.queue.slice(0,20).forEach(function(t,i){
            var img=t.album&&t.album.images&&t.album.images.length?t.album.images[t.album.images.length-1].url:'';
            var artists=t.artists?t.artists.map(function(a){return a.name;}).join(', '):'';
            html+='<div style="display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0.2rem;border-radius:4px;">';
            html+='<span style="font-size:0.62rem;color:var(--clarity-dim);width:16px;text-align:right;">'+(i+1)+'</span>';
            if(img)html+='<img src="'+img+'" style="width:28px;height:28px;border-radius:3px;object-fit:cover;">';
            html+='<div style="flex:1;min-width:0;">';
            html+='<div style="font-size:0.75rem;font-weight:500;color:var(--clarity);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(t.name)+'</div>';
            html+='<div style="font-size:0.6rem;color:var(--clarity-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escapeHtml(artists)+'</div>';
            html+='</div></div>';
        });
    } else if(!data.currently_playing){
        html='<div style="padding:1rem;text-align:center;font-size:0.78rem;color:var(--clarity-dim);">Queue is empty — play something!</div>';
    }

    el.innerHTML=html;
}

// Handle OAuth callback
(function(){
    var params=new URLSearchParams(window.location.search);
    var code=params.get('code');
    if(code){
        window.history.replaceState({},'',SP_REDIRECT);
        spExchangeCode(code);
    } else if(spToken&&Date.now()<spTokenExpiry){
        spInit();
    } else if(spToken){
        // Token expired, try refresh
        spRefreshToken().then(function(){
            if(spToken)spInit();
        });
    }
})();

// SDK ready callback
window.onSpotifyWebPlaybackSDKReady=window.onSpotifyWebPlaybackSDKReady||function(){
    if(spToken&&spDeviceId===null)spInitPlayer();
};

// =============================================
// GOOGLE DRIVE — Supabase-backed file browser
// =============================================
var driveCurrentFolder='/';
var driveFiles=[];

async function driveLoad(){
    var {data}=await sb.from('cockpit_drive_files').select('*').order('is_dir',{ascending:false}).order('name');
    driveFiles=data||[];
    driveRender();
    if(driveFiles.length>0){
        var synced=new Date(driveFiles[0].synced_at);
        document.getElementById('drive-synced').textContent='Last synced: '+synced.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+synced.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    }
}

function driveGetIcon(file){
    if(file.is_dir) return '📁';
    var ext=file.name.split('.').pop().toLowerCase();
    var icons={json:'📄',txt:'📃',pdf:'📕',doc:'📘',docx:'📘',xls:'📊',xlsx:'📊',csv:'📊',png:'🖼',jpg:'🖼',jpeg:'🖼',gif:'🖼',mp4:'🎬',mov:'🎬',mp3:'🎵',zip:'📦',encrypted:'🔒'};
    return icons[ext]||'📄';
}

function driveFormatSize(bytes){
    if(!bytes||bytes===0) return '—';
    if(bytes<1024) return bytes+' B';
    if(bytes<1048576) return (bytes/1024).toFixed(1)+' KB';
    return (bytes/1048576).toFixed(1)+' MB';
}

function driveRender(){
    var filtered=driveFiles.filter(function(f){return f.folder===driveCurrentFolder;});
    var list=document.getElementById('drive-list');
    if(!filtered.length){
        list.innerHTML='<div class="drive-empty">This folder is empty</div>';
        return;
    }
    var html='';
    filtered.forEach(function(f){
        var icon=driveGetIcon(f);
        var driveLink='https://drive.google.com/'+(f.is_dir?'drive/folders/':'file/d/')+f.drive_id;
        html+='<div class="drive-row" onclick="'+(f.is_dir?'driveNav(\''+escapeHtml(f.path)+'\')':'window.open(\''+driveLink+'\',\'_blank\')')+'">';
        html+='<span class="drive-row-icon">'+icon+'</span>';
        html+='<span class="drive-row-name">'+escapeHtml(f.name)+'</span>';
        html+='<span class="drive-row-size">'+driveFormatSize(f.size)+'</span>';
        html+='<a href="'+driveLink+'" target="_blank" class="drive-row-open" onclick="event.stopPropagation()">Open</a>';
        html+='</div>';
    });
    list.innerHTML=html;
}

function driveNav(folder){
    driveCurrentFolder=folder;
    driveBuildBreadcrumb();
    driveRender();
}

function driveBuildBreadcrumb(){
    var bc=document.getElementById('drive-breadcrumb');
    var html='<button class="drive-crumb" onclick="driveNav(\'/\')">My Drive</button>';
    if(driveCurrentFolder!=='/'){
        var parts=driveCurrentFolder.split('/').filter(Boolean);
        var path='';
        parts.forEach(function(p){
            path+=p;
            html+='<span class="drive-crumb-sep">/</span>';
            html+='<button class="drive-crumb" onclick="driveNav(\''+escapeHtml(path)+'\')">'+escapeHtml(p)+'</button>';
            path+='/';
        });
    }
    bc.innerHTML=html;
}

driveLoad();

// =============================================
// COMMUNICATIONS HUB — Supabase-backed
// =============================================
var commsActive=null;

async function commsRenderChannels(){
    var {data:channels}=await sb.from('cockpit_comms_channels').select('*').order('created_at');
    channels=channels||[];
    var teamList=document.getElementById('comms-channel-list');
    var custList=document.getElementById('comms-customer-list');
    var teamHtml='',custHtml='';
    for(var i=0;i<channels.length;i++){
        var ch=channels[i];
        var {count}=await sb.from('cockpit_comms_messages').select('*',{count:'exact',head:true}).eq('channel_id',ch.id);
        var isCustomer=(ch.type==='customer');
        var badge=count?'<span class="comms-ch-badge">'+count+'</span>':'';
        var cls='comms-ch-item'+(isCustomer?' customer':'')+(commsActive===ch.id?' active':'');
        var row='<div class="'+cls+'" onclick="commsSelectChannel(\''+ch.id+'\')">' +
            '<span class="comms-ch-icon">'+ch.icon+'</span>' +
            '<span class="comms-ch-name">'+escapeHtml(ch.name)+'</span>'+badge+'</div>';
        if(isCustomer){custHtml+=row;}else{teamHtml+=row;}
    }
    teamList.innerHTML=teamHtml;
    custList.innerHTML=custHtml||'<div style="padding:0.4rem 0.75rem;font-size:0.72rem;color:var(--clarity-dim);font-style:italic;">No customer threads yet</div>';
}

function commsSelectChannel(id){
    commsActive=id;
    commsRenderChannels();
    commsRenderMessages();
    document.getElementById('comms-compose').style.display='flex';
    document.getElementById('comms-pin-btn').style.display='inline-block';
    document.getElementById('comms-del-ch-btn').style.display='inline-block';
    document.getElementById('comms-msg-input').focus();
}

async function commsRenderMessages(){
    if(!commsActive)return;
    var {data:chArr}=await sb.from('cockpit_comms_channels').select('*').eq('id',commsActive).limit(1);
    var ch=(chArr&&chArr[0]);
    if(!ch)return;
    document.getElementById('comms-main-title').textContent=ch.icon+' '+ch.name;
    var {data:msgs}=await sb.from('cockpit_comms_messages').select('*').eq('channel_id',commsActive).order('created_at');
    msgs=msgs||[];
    document.getElementById('comms-main-count').textContent=msgs.length+' message'+(msgs.length!==1?'s':'');
    var {data:pinArr}=await sb.from('cockpit_comms_pins').select('*').eq('channel_id',commsActive).limit(1);
    var pin=pinArr&&pinArr[0];
    var pinnedEl=document.getElementById('comms-pinned');
    if(pin){
        pinnedEl.innerHTML='<div class="comms-pinned-msg"><span class="comms-pinned-label">Pinned</span><span class="comms-pinned-text">'+escapeHtml(pin.text)+'</span></div>';
    }else{pinnedEl.innerHTML='';}
    var container=document.getElementById('comms-messages');
    if(msgs.length===0){
        container.innerHTML='<div class="comms-empty">No messages yet — start the conversation</div>';
    }else{
        container.innerHTML=msgs.map(function(m){
            return '<div class="comms-msg">' +
                '<div class="comms-msg-head">' +
                    '<span class="comms-msg-sender">'+escapeHtml(m.sender||'You')+'</span>' +
                    '<span class="comms-msg-time">'+m.time+'</span>' +
                    '<div class="comms-msg-actions">' +
                        '<button class="comms-msg-act" onclick="commsPinMsg('+m.id+')" title="Pin">Pin</button>' +
                        '<button class="comms-msg-act del" onclick="commsDeleteMsg('+m.id+')" title="Delete">Del</button>' +
                    '</div>' +
                '</div>' +
                '<div class="comms-msg-text">'+escapeHtml(m.text)+'</div>' +
            '</div>';
        }).join('');
        container.scrollTop=container.scrollHeight;
    }
}

async function commsSend(){
    if(!commsActive)return;
    var input=document.getElementById('comms-msg-input'),text=input.value.trim();
    if(!text)return;
    var ts=new Date().toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',hour12:true});
    await sb.from('cockpit_comms_messages').insert({channel_id:commsActive,text:text,sender:'You',time:ts});
    input.value='';
    commsRenderChannels();
    commsRenderMessages();
}

async function commsDeleteMsg(id){
    await sb.from('cockpit_comms_messages').delete().eq('id',id);
    commsRenderChannels();
    commsRenderMessages();
}

async function commsPinMsg(id){
    var {data:msgs}=await sb.from('cockpit_comms_messages').select('*').eq('id',id).limit(1);
    var m=msgs&&msgs[0];
    if(m){await sb.from('cockpit_comms_pins').upsert({channel_id:commsActive,text:m.text,time:m.time});}
    commsRenderMessages();
}

async function commsTogglePin(){
    await sb.from('cockpit_comms_pins').delete().eq('channel_id',commsActive);
    commsRenderMessages();
}

async function commsDeleteChannel(){
    if(!commsActive)return;
    await sb.from('cockpit_comms_channels').delete().eq('id',commsActive);
    commsActive=null;
    commsRenderChannels();
    document.getElementById('comms-messages').innerHTML='<div class="comms-empty">Pick a channel to start</div>';
    document.getElementById('comms-main-title').textContent='Select a channel';
    document.getElementById('comms-main-count').textContent='';
    document.getElementById('comms-compose').style.display='none';
    document.getElementById('comms-pin-btn').style.display='none';
    document.getElementById('comms-del-ch-btn').style.display='none';
    document.getElementById('comms-pinned').innerHTML='';
}

document.getElementById('comms-new-channel').addEventListener('keydown',async function(e){
    if(e.key==='Enter'){
        var name=this.value.trim();if(!name)return;
        var id=name.toLowerCase().replace(/[^a-z0-9]/g,'-').replace(/-+/g,'-');
        await sb.from('cockpit_comms_channels').upsert({id:id,name:name,icon:'💬',type:'team'});
        this.value='';
        commsRenderChannels();
        commsSelectChannel(id);
    }
});
document.getElementById('comms-new-customer').addEventListener('keydown',async function(e){
    if(e.key==='Enter'){
        var name=this.value.trim();if(!name)return;
        var id='cust-'+name.toLowerCase().replace(/[^a-z0-9]/g,'-').replace(/-+/g,'-');
        await sb.from('cockpit_comms_channels').upsert({id:id,name:name,icon:'👤',type:'customer'});
        this.value='';
        commsRenderChannels();
        commsSelectChannel(id);
    }
});
document.getElementById('comms-msg-input').addEventListener('keydown',function(e){if(e.key==='Enter')commsSend();});
commsRenderChannels();

// =============================================
// REALTIME — Live message updates via Supabase
// =============================================
sb.channel('cockpit-comms-realtime')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'cockpit_comms_messages'},function(payload){
        if(commsActive && payload.new.channel_id===commsActive){
            commsRenderMessages();
        }
        commsRenderChannels();
    })
    .on('postgres_changes',{event:'DELETE',schema:'public',table:'cockpit_comms_messages'},function(){
        commsRenderMessages();
        commsRenderChannels();
    })
    .on('postgres_changes',{event:'*',schema:'public',table:'cockpit_comms_channels'},function(){
        commsRenderChannels();
    })
    .on('postgres_changes',{event:'*',schema:'public',table:'cockpit_comms_pins'},function(){
        if(commsActive) commsRenderMessages();
    })
    .subscribe();

// =============================================
// VOICE CHANNEL — WebRTC via PeerJS
// =============================================
var voicePeer=null, voiceConns=[], voiceStream=null, voiceRoomId=null, voiceMuted=false;
var voiceAudioCtx=null, voiceAnalyser=null, voiceAnimFrame=null;
var voiceVideoOn=false, voiceVideoStream=null;
var voiceScreenOn=false, voiceScreenStream=null;

var voiceLastGenCode=null;

function voiceGenId(){
    var chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    var code='';
    for(var i=0;i<3;i++){code+=chars[Math.floor(Math.random()*chars.length)];}
    code+='-';
    for(var j=0;j<3;j++){code+=chars[Math.floor(Math.random()*chars.length)];}
    return 'VC-'+code;
}

function voiceGenerateCode(){
    voiceLastGenCode=voiceGenId();
    document.getElementById('voice-code-display').textContent=voiceLastGenCode;
    document.getElementById('voice-room-input').value=voiceLastGenCode;
    document.getElementById('voice-copy-idle-btn').style.display='block';
}

function voiceCopyIdleCode(){
    if(!voiceLastGenCode)return;
    navigator.clipboard.writeText(voiceLastGenCode).then(function(){
        var btn=document.getElementById('voice-copy-idle-btn');
        btn.textContent='Copied!';setTimeout(function(){btn.textContent='Copy';},1500);
    });
}

function voiceHostGenerated(){
    if(!voiceLastGenCode)voiceLastGenCode=voiceGenId();
    voiceRoomId=voiceLastGenCode;
    document.getElementById('voice-room-code').textContent=voiceRoomId;
    voiceStart(voiceRoomId,true);
}

function voiceCreate(){
    voiceRoomId=voiceGenId();
    document.getElementById('voice-room-code').textContent=voiceRoomId;
    voiceStart(voiceRoomId,true);
}

function voiceJoin(){
    var code=document.getElementById('voice-room-input').value.trim();
    if(!code)return;
    voiceRoomId=code;
    document.getElementById('voice-room-code').textContent=voiceRoomId;
    voiceStart(voiceRoomId,false);
}

function voiceStart(roomId,isHost){
    document.getElementById('voice-panel-idle').style.display='none';
    document.getElementById('voice-panel-active').style.display='block';
    document.getElementById('voice-status').textContent='Requesting mic...';
    document.getElementById('voice-status').className='voice-status';

    navigator.mediaDevices.getUserMedia({audio:true,video:false}).then(function(stream){
        voiceStream=stream;
        var peerId=isHost?roomId:roomId+'-'+Date.now();
        voicePeer=new Peer(peerId,{debug:0});

        voicePeer.on('open',function(id){
            document.getElementById('voice-status').textContent='Connected';
            document.getElementById('voice-status').className='voice-status connected';
            voiceUpdateUsers();
            voiceStartVisualizer(stream);

            if(!isHost){
                var conn=voicePeer.call(roomId,stream);
                voiceHandleCall(conn);
            }
        });

        voicePeer.on('call',function(call){
            call.answer(stream);
            voiceHandleCall(call);
        });

        voicePeer.on('error',function(err){
            console.error('Voice error:',err);
            if(err.type==='unavailable-id'){
                document.getElementById('voice-status').textContent='Room exists — try joining instead';
            } else if(err.type==='peer-unavailable'){
                document.getElementById('voice-status').textContent='Room not found — check the code';
            } else {
                document.getElementById('voice-status').textContent='Error: '+err.type;
            }
        });

        voicePeer.on('disconnected',function(){
            document.getElementById('voice-status').textContent='Disconnected';
            document.getElementById('voice-status').className='voice-status';
        });

    }).catch(function(err){
        document.getElementById('voice-status').textContent='Mic access denied';
        console.error('Mic error:',err);
    });
}

function voiceHandleCall(call){
    voiceConns.push(call);
    call.on('stream',function(remoteStream){
        var hasVideo=remoteStream.getVideoTracks().length>0;
        if(hasVideo){
            var existingVid=document.getElementById('voice-remote-vid-'+call.peer);
            if(existingVid){existingVid.srcObject=remoteStream;return;}
            var vid=document.createElement('video');
            vid.srcObject=remoteStream;
            vid.autoplay=true;
            vid.playsInline=true;
            vid.id='voice-remote-vid-'+call.peer;
            vid.className=call.metadata==='screen'?'voice-screen-video':'voice-remote-video';
            document.getElementById('voice-videos').appendChild(vid);
        }
        var audio=document.getElementById('voice-audio-'+call.peer);
        if(!audio){
            audio=document.createElement('audio');
            audio.srcObject=remoteStream;
            audio.autoplay=true;
            audio.id='voice-audio-'+call.peer;
            document.body.appendChild(audio);
        }
        voiceUpdateUsers();
    });
    call.on('close',function(){
        voiceConns=voiceConns.filter(function(c){return c!==call;});
        var el=document.getElementById('voice-audio-'+call.peer);
        if(el)el.remove();
        var vid=document.getElementById('voice-remote-vid-'+call.peer);
        if(vid)vid.remove();
        voiceUpdateUsers();
    });
    voiceUpdateUsers();
}

function voiceUpdateUsers(){
    var el=document.getElementById('voice-users');
    var html='<div class="voice-user"><span class="voice-user-dot'+(voiceMuted?' muted':'')+'"></span><span class="voice-user-name">You</span><span class="voice-user-tag">'+(voiceMuted?'MUTED':'LIVE')+'</span></div>';
    voiceConns.forEach(function(c,i){
        html+='<div class="voice-user"><span class="voice-user-dot speaking"></span><span class="voice-user-name">Peer '+(i+1)+'</span><span class="voice-user-tag">CONNECTED</span></div>';
    });
    el.innerHTML=html;
}

function voiceToggleMute(){
    voiceMuted=!voiceMuted;
    if(voiceStream){
        voiceStream.getAudioTracks().forEach(function(t){t.enabled=!voiceMuted;});
    }
    var btn=document.getElementById('voice-mute-btn');
    btn.textContent=voiceMuted?'Unmute':'Mute';
    btn.className='voice-ctrl'+(voiceMuted?' active':'');
    voiceUpdateUsers();
}

function voiceToggleVideo(){
    if(voiceVideoOn){
        // Turn off camera
        if(voiceVideoStream){voiceVideoStream.getTracks().forEach(function(t){t.stop();});voiceVideoStream=null;}
        document.getElementById('voice-local-video').style.display='none';
        document.getElementById('voice-local-video').srcObject=null;
        var btn=document.getElementById('voice-video-btn');
        btn.textContent='Cam';btn.className='voice-ctrl';
        voiceVideoOn=false;
    } else {
        // Turn on camera
        navigator.mediaDevices.getUserMedia({video:{width:320,height:240},audio:false}).then(function(camStream){
            voiceVideoStream=camStream;
            voiceVideoOn=true;
            var localVid=document.getElementById('voice-local-video');
            localVid.srcObject=camStream;
            localVid.style.display='block';
            var btn=document.getElementById('voice-video-btn');
            btn.textContent='Cam Off';btn.className='voice-ctrl active';
            // Send video to all connected peers
            voiceConns.forEach(function(conn){
                if(conn.peer && voicePeer){
                    var call=voicePeer.call(conn.peer,camStream,{metadata:'camera'});
                    voiceHandleCall(call);
                }
            });
        }).catch(function(err){console.error('Camera error:',err);});
    }
}

function voiceToggleScreen(){
    if(voiceScreenOn){
        // Stop screen share
        if(voiceScreenStream){voiceScreenStream.getTracks().forEach(function(t){t.stop();});voiceScreenStream=null;}
        var screenVid=document.getElementById('voice-local-screen');
        if(screenVid)screenVid.remove();
        var btn=document.getElementById('voice-screen-btn');
        btn.textContent='Screen';btn.className='voice-ctrl';
        voiceScreenOn=false;
    } else {
        // Start screen share
        navigator.mediaDevices.getDisplayMedia({video:true,audio:false}).then(function(screenStream){
            voiceScreenStream=screenStream;
            voiceScreenOn=true;
            var screenVid=document.createElement('video');
            screenVid.id='voice-local-screen';
            screenVid.className='voice-screen-video';
            screenVid.srcObject=screenStream;
            screenVid.autoplay=true;
            screenVid.muted=true;
            screenVid.playsInline=true;
            document.getElementById('voice-videos').appendChild(screenVid);
            var btn=document.getElementById('voice-screen-btn');
            btn.textContent='Stop Share';btn.className='voice-ctrl active';
            // Handle browser's native "Stop sharing" button
            screenStream.getVideoTracks()[0].onended=function(){
                voiceToggleScreen();
            };
            // Send screen to all connected peers
            voiceConns.forEach(function(conn){
                if(conn.peer && voicePeer){
                    var call=voicePeer.call(conn.peer,screenStream,{metadata:'screen'});
                    voiceHandleCall(call);
                }
            });
        }).catch(function(err){console.error('Screen share error:',err);});
    }
}

function voiceLeave(){
    voiceConns.forEach(function(c){c.close();});
    voiceConns=[];
    if(voiceStream){voiceStream.getTracks().forEach(function(t){t.stop();});voiceStream=null;}
    if(voiceVideoStream){voiceVideoStream.getTracks().forEach(function(t){t.stop();});voiceVideoStream=null;}
    if(voiceScreenStream){voiceScreenStream.getTracks().forEach(function(t){t.stop();});voiceScreenStream=null;}
    if(voicePeer){voicePeer.destroy();voicePeer=null;}
    if(voiceAnimFrame){cancelAnimationFrame(voiceAnimFrame);voiceAnimFrame=null;}
    if(voiceAudioCtx){voiceAudioCtx.close();voiceAudioCtx=null;}
    document.querySelectorAll('audio[id^="voice-audio-"]').forEach(function(a){a.remove();});
    document.querySelectorAll('.voice-remote-video,.voice-screen-video').forEach(function(v){v.remove();});
    var localScreen=document.getElementById('voice-local-screen');
    if(localScreen)localScreen.remove();
    voiceRoomId=null;voiceMuted=false;voiceVideoOn=false;voiceScreenOn=false;
    document.getElementById('voice-local-video').style.display='none';
    document.getElementById('voice-local-video').srcObject=null;
    document.getElementById('voice-panel-idle').style.display='block';
    document.getElementById('voice-panel-active').style.display='none';
    document.getElementById('voice-mute-btn').textContent='Mute';
    document.getElementById('voice-mute-btn').className='voice-ctrl';
    document.getElementById('voice-video-btn').textContent='Cam';
    document.getElementById('voice-video-btn').className='voice-ctrl';
    document.getElementById('voice-screen-btn').textContent='Screen';
    document.getElementById('voice-screen-btn').className='voice-ctrl';
    document.getElementById('voice-room-input').value='';
}

function voiceCopyCode(){
    var code=document.getElementById('voice-room-code').textContent;
    navigator.clipboard.writeText(code).then(function(){
        var btn=document.querySelector('.voice-copy-btn');
        btn.textContent='Copied!';setTimeout(function(){btn.textContent='Copy';},1500);
    });
}

function voiceStartVisualizer(stream){
    voiceAudioCtx=new(window.AudioContext||window.webkitAudioContext)();
    voiceAnalyser=voiceAudioCtx.createAnalyser();
    voiceAnalyser.fftSize=64;
    var source=voiceAudioCtx.createMediaStreamSource(stream);
    source.connect(voiceAnalyser);
    var canvas=document.getElementById('voice-canvas');
    var ctx=canvas.getContext('2d');
    var bufLen=voiceAnalyser.frequencyBinCount;
    var data=new Uint8Array(bufLen);
    function draw(){
        voiceAnimFrame=requestAnimationFrame(draw);
        voiceAnalyser.getByteFrequencyData(data);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        var barW=canvas.width/bufLen*2;
        for(var i=0;i<bufLen;i++){
            var v=data[i]/255;
            var h=v*canvas.height;
            var g=ctx.createLinearGradient(0,canvas.height-h,0,canvas.height);
            g.addColorStop(0,'rgba(50,205,50,0.8)');
            g.addColorStop(1,'rgba(50,205,50,0.2)');
            ctx.fillStyle=g;
            ctx.fillRect(i*barW,canvas.height-h,barW-1,h);
        }
    }
    draw();
}

// =============================================
// DENVER AREA MAP — Offline-capable with Supabase
// =============================================
var DENVER_LOCATIONS=[
// Cities & Towns
{name:'Denver',lat:39.7392,lng:-104.9903,cat:'City',zip:'80202'},
{name:'Aurora',lat:39.7294,lng:-104.8319,cat:'City',zip:'80012'},
{name:'Lakewood',lat:39.7047,lng:-105.0814,cat:'City',zip:'80226'},
{name:'Thornton',lat:39.8680,lng:-104.9719,cat:'City',zip:'80229'},
{name:'Arvada',lat:39.8028,lng:-105.0875,cat:'City',zip:'80002'},
{name:'Westminster',lat:39.8367,lng:-105.0372,cat:'City',zip:'80031'},
{name:'Centennial',lat:39.5791,lng:-104.8769,cat:'City',zip:'80112'},
{name:'Boulder',lat:40.0150,lng:-105.2705,cat:'City',zip:'80302'},
{name:'Highlands Ranch',lat:39.5519,lng:-104.9708,cat:'City',zip:'80129'},
{name:'Broomfield',lat:39.9205,lng:-105.0867,cat:'City',zip:'80020'},
{name:'Castle Rock',lat:39.3722,lng:-104.8561,cat:'City',zip:'80104'},
{name:'Commerce City',lat:39.8083,lng:-104.9339,cat:'City',zip:'80022'},
{name:'Parker',lat:39.5186,lng:-104.7613,cat:'City',zip:'80134'},
{name:'Littleton',lat:39.6133,lng:-105.0166,cat:'City',zip:'80120'},
{name:'Englewood',lat:39.6480,lng:-104.9878,cat:'City',zip:'80110'},
{name:'Wheat Ridge',lat:39.7661,lng:-105.0772,cat:'City',zip:'80033'},
{name:'Golden',lat:39.7555,lng:-105.2211,cat:'City',zip:'80401'},
{name:'Northglenn',lat:39.8853,lng:-104.9872,cat:'City',zip:'80233'},
{name:'Brighton',lat:39.9853,lng:-104.8206,cat:'City',zip:'80601'},
{name:'Louisville',lat:39.9778,lng:-105.1319,cat:'City',zip:'80027'},
{name:'Superior',lat:39.9528,lng:-105.1686,cat:'City',zip:'80027'},
{name:'Erie',lat:40.0503,lng:-105.0500,cat:'City',zip:'80516'},
{name:'Federal Heights',lat:39.8614,lng:-105.0156,cat:'City',zip:'80260'},
{name:'Sheridan',lat:39.6467,lng:-105.0253,cat:'City',zip:'80110'},
{name:'Lone Tree',lat:39.5372,lng:-104.8953,cat:'City',zip:'80124'},
{name:'Greenwood Village',lat:39.6172,lng:-104.9508,cat:'City',zip:'80111'},
{name:'Cherry Hills Village',lat:39.6414,lng:-104.9586,cat:'City',zip:'80113'},
{name:'Morrison',lat:39.6536,lng:-105.1908,cat:'City',zip:'80465'},
{name:'Bennett',lat:39.7589,lng:-104.4247,cat:'City',zip:'80102'},
{name:'Elizabeth',lat:39.3608,lng:-104.5953,cat:'City',zip:'80107'},
// Denver Neighborhoods
{name:'LoDo (Lower Downtown)',lat:39.7533,lng:-105.0000,cat:'Neighborhood',zip:'80202'},
{name:'RiNo (River North)',lat:39.7700,lng:-104.9800,cat:'Neighborhood',zip:'80216'},
{name:'Capitol Hill',lat:39.7314,lng:-104.9836,cat:'Neighborhood',zip:'80203'},
{name:'Cherry Creek',lat:39.7175,lng:-104.9550,cat:'Neighborhood',zip:'80206'},
{name:'Five Points',lat:39.7553,lng:-104.9750,cat:'Neighborhood',zip:'80205'},
{name:'Wash Park',lat:39.6975,lng:-104.9775,cat:'Neighborhood',zip:'80209'},
{name:'Highlands',lat:39.7592,lng:-105.0103,cat:'Neighborhood',zip:'80211'},
{name:'Sunnyside',lat:39.7800,lng:-105.0050,cat:'Neighborhood',zip:'80211'},
{name:'Baker',lat:39.7139,lng:-104.9917,cat:'Neighborhood',zip:'80223'},
{name:'Uptown',lat:39.7450,lng:-104.9750,cat:'Neighborhood',zip:'80218'},
{name:'City Park',lat:39.7475,lng:-104.9550,cat:'Neighborhood',zip:'80205'},
{name:'Park Hill',lat:39.7550,lng:-104.9325,cat:'Neighborhood',zip:'80207'},
{name:'Green Valley Ranch',lat:39.7833,lng:-104.8100,cat:'Neighborhood',zip:'80249'},
{name:'Stapleton / Central Park',lat:39.7625,lng:-104.8875,cat:'Neighborhood',zip:'80238'},
{name:'Montbello',lat:39.7875,lng:-104.8425,cat:'Neighborhood',zip:'80239'},
{name:'Globeville',lat:39.7850,lng:-104.9900,cat:'Neighborhood',zip:'80216'},
{name:'Sloan Lake',lat:39.7517,lng:-105.0275,cat:'Neighborhood',zip:'80212'},
{name:'Berkeley',lat:39.7700,lng:-105.0350,cat:'Neighborhood',zip:'80212'},
{name:'Congress Park',lat:39.7325,lng:-104.9600,cat:'Neighborhood',zip:'80206'},
{name:'Platt Park',lat:39.6850,lng:-104.9825,cat:'Neighborhood',zip:'80210'},
{name:'Hampden South',lat:39.6417,lng:-104.9583,cat:'Neighborhood',zip:'80237'},
{name:'Athmar Park',lat:39.6950,lng:-105.0100,cat:'Neighborhood',zip:'80219'},
{name:'Barnum',lat:39.7125,lng:-105.0225,cat:'Neighborhood',zip:'80219'},
{name:'Cole',lat:39.7650,lng:-104.9675,cat:'Neighborhood',zip:'80205'},
{name:'Elyria-Swansea',lat:39.7825,lng:-104.9650,cat:'Neighborhood',zip:'80216'},
// Landmarks
{name:'Denver International Airport (DIA)',lat:39.8561,lng:-104.6737,cat:'Landmark',zip:'80249'},
{name:'Red Rocks Amphitheatre',lat:39.6654,lng:-105.2057,cat:'Landmark',zip:'80465'},
{name:'Coors Field',lat:39.7559,lng:-104.9942,cat:'Landmark',zip:'80205'},
{name:'Empower Field at Mile High',lat:39.7439,lng:-105.0201,cat:'Landmark',zip:'80204'},
{name:'Denver Union Station',lat:39.7530,lng:-105.0003,cat:'Landmark',zip:'80202'},
{name:'Colorado State Capitol',lat:39.7393,lng:-104.9849,cat:'Landmark',zip:'80203'},
{name:'Denver Museum of Nature & Science',lat:39.7475,lng:-104.9425,cat:'Landmark',zip:'80205'},
{name:'Denver Art Museum',lat:39.7372,lng:-104.9894,cat:'Landmark',zip:'80204'},
{name:'Denver Zoo',lat:39.7500,lng:-104.9500,cat:'Landmark',zip:'80205'},
{name:'16th Street Mall',lat:39.7475,lng:-104.9975,cat:'Landmark',zip:'80202'},
{name:'Cherry Creek Shopping Center',lat:39.7167,lng:-104.9531,cat:'Landmark',zip:'80206'},
{name:'Denver Botanic Gardens',lat:39.7325,lng:-104.9600,cat:'Landmark',zip:'80206'},
{name:'Chatfield State Park',lat:39.5328,lng:-105.0708,cat:'Landmark',zip:'80128'},
{name:'Cherry Creek State Park',lat:39.6375,lng:-104.8569,cat:'Landmark',zip:'80014'},
{name:'Sloan Lake Park',lat:39.7539,lng:-105.0283,cat:'Landmark',zip:'80212'},
{name:'Washington Park',lat:39.6975,lng:-104.9750,cat:'Landmark',zip:'80209'},
{name:'City Park',lat:39.7475,lng:-104.9556,cat:'Landmark',zip:'80205'},
{name:'Lookout Mountain',lat:39.7322,lng:-105.2389,cat:'Landmark',zip:'80401'},
{name:'Flat Irons Vista (Boulder)',lat:39.9950,lng:-105.2850,cat:'Landmark',zip:'80305'},
{name:'Rocky Mountain Arsenal NWR',lat:39.8333,lng:-104.8667,cat:'Landmark',zip:'80022'},
// Moving-relevant businesses / highway interchanges
{name:'I-25 & I-70 (Mousetrap)',lat:39.7750,lng:-104.9875,cat:'Highway',zip:'80216'},
{name:'I-25 & I-225',lat:39.6825,lng:-104.8725,cat:'Highway',zip:'80012'},
{name:'I-25 & C-470',lat:39.5575,lng:-104.9950,cat:'Highway',zip:'80120'},
{name:'I-70 & I-225',lat:39.7375,lng:-104.8375,cat:'Highway',zip:'80011'},
{name:'I-25 & US-36 (Denver-Boulder Turnpike)',lat:39.8350,lng:-105.0025,cat:'Highway',zip:'80221'},
{name:'I-70 & C-470 (West)',lat:39.7200,lng:-105.1975,cat:'Highway',zip:'80401'},
{name:'I-25 & E-470 (South)',lat:39.5025,lng:-104.8775,cat:'Highway',zip:'80124'},
{name:'I-76 & I-25',lat:39.7825,lng:-104.9925,cat:'Highway',zip:'80216'},
{name:'I-70 & Peña Blvd (DIA)',lat:39.7950,lng:-104.7500,cat:'Highway',zip:'80239'},
{name:'I-25 & Arapahoe Rd',lat:39.5975,lng:-104.8750,cat:'Highway',zip:'80112'},
{name:'Home Depot — Denver Central',lat:39.7375,lng:-105.0125,cat:'Business',zip:'80204'},
{name:'Home Depot — Aurora',lat:39.7100,lng:-104.8200,cat:'Business',zip:'80012'},
{name:'U-Haul — Denver',lat:39.7350,lng:-104.9700,cat:'Business',zip:'80205'},
{name:'U-Haul — Lakewood',lat:39.7075,lng:-105.0900,cat:'Business',zip:'80226'},
{name:'PODS Denver',lat:39.7500,lng:-104.9100,cat:'Business',zip:'80207'},
{name:'Public Storage — Englewood',lat:39.6500,lng:-104.9975,cat:'Business',zip:'80110'},
{name:'Public Storage — Aurora',lat:39.7000,lng:-104.8300,cat:'Business',zip:'80014'},
{name:'Budget Truck Rental — Denver',lat:39.7425,lng:-105.0000,cat:'Business',zip:'80204'},
{name:'Denver Donation Center',lat:39.7250,lng:-105.0050,cat:'Business',zip:'80223'},
{name:'Goodwill — Denver',lat:39.7175,lng:-104.9800,cat:'Business',zip:'80209'},
{name:'Salvation Army — Denver',lat:39.7475,lng:-104.9875,cat:'Business',zip:'80204'},
{name:'ReStore Habitat for Humanity',lat:39.7100,lng:-104.9975,cat:'Business',zip:'80219'},
{name:'Two Men and a Truck — Denver',lat:39.7200,lng:-104.8900,cat:'Business',zip:'80247'},
{name:'Penske Truck Rental — Denver',lat:39.7575,lng:-104.9625,cat:'Business',zip:'80207'},
{name:'Enterprise Truck Rental — Denver',lat:39.7350,lng:-105.0050,cat:'Business',zip:'80204'},
{name:'CubeSmart Self Storage — Thornton',lat:39.8750,lng:-104.9700,cat:'Business',zip:'80229'},
{name:'Extra Space Storage — Westminster',lat:39.8375,lng:-105.0400,cat:'Business',zip:'80031'},
{name:'Life Storage — Highlands Ranch',lat:39.5500,lng:-104.9675,cat:'Business',zip:'80129'},
{name:'ABF U-Pack — Denver',lat:39.7750,lng:-104.9500,cat:'Business',zip:'80216'},
{name:'Denver Furniture Bank',lat:39.7325,lng:-105.0000,cat:'Business',zip:'80204'}
];

var mapObj=null;
var mapMarkers=[];
var mapSavedLocations=[];
var mapCurrentFilter='All';
var mapClickLatLng=null;

function mapInit(){
    if(mapObj)return;
    mapObj=L.map('map-container').setView([39.74,-104.99],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OpenStreetMap',
        maxZoom:18
    }).addTo(mapObj);
    mapObj.on('click',function(e){
        mapClickLatLng=e.latlng;
        document.getElementById('map-save-lat').value=e.latlng.lat.toFixed(6);
        document.getElementById('map-save-lng').value=e.latlng.lng.toFixed(6);
        document.getElementById('map-save-name').value='';
        document.getElementById('map-save-address').value='';
        document.getElementById('map-save-notes').value='';
        document.getElementById('map-save-cat').value='General';
        document.getElementById('map-modal').classList.add('show');
    });
    mapLoadSaved();
    // Online/offline badge
    function updateBadge(){
        var badge=document.getElementById('map-badge');
        var text=document.getElementById('map-badge-text');
        if(navigator.onLine){badge.className='map-badge online';text.textContent='Online';}
        else{badge.className='map-badge offline';text.textContent='Offline';}
    }
    updateBadge();
    window.addEventListener('online',updateBadge);
    window.addEventListener('offline',updateBadge);
    // Realtime subscription
    sb.channel('map_locations_changes').on('postgres_changes',{event:'*',schema:'public',table:'cockpit_map_locations'},function(){mapLoadSaved();}).subscribe();
}

var mapSearchTimer=null;
function mapSearch(query){
    var dd=document.getElementById('map-dropdown');
    if(!query||query.length<1){dd.classList.remove('show');return;}
    var q=query.toLowerCase();
    // Local results (hardcoded + saved)
    var results=DENVER_LOCATIONS.filter(function(loc){
        return loc.name.toLowerCase().indexOf(q)!==-1||(loc.zip&&loc.zip.indexOf(q)!==-1);
    });
    var savedResults=mapSavedLocations.filter(function(loc){
        return loc.name.toLowerCase().indexOf(q)!==-1||(loc.address&&loc.address.toLowerCase().indexOf(q)!==-1);
    }).map(function(loc){return{name:loc.name+(loc.address?' — '+loc.address:''),lat:loc.lat,lng:loc.lng,cat:'Saved: '+loc.category};});
    results=savedResults.concat(results).slice(0,6);
    // Show local results immediately
    mapShowDropdown(results,dd,query);
    // Geocode after a short delay for address search
    clearTimeout(mapSearchTimer);
    if(query.length>=3){
        mapSearchTimer=setTimeout(function(){mapGeocode(query,results,dd);},400);
    }
}

async function mapGeocode(query,localResults,dd){
    try{
        var resp=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(query)+'&countrycodes=us&limit=5&addressdetails=1',{
            headers:{'Accept':'application/json'}
        });
        var data=await resp.json();
        var geoResults=data.map(function(r){
            return{name:r.display_name,lat:parseFloat(r.lat),lng:parseFloat(r.lon),cat:'Address'};
        });
        var combined=localResults.concat(geoResults).slice(0,10);
        mapShowDropdown(combined,dd,query);
    }catch(e){console.warn('Geocode error:',e);}
}

function mapShowDropdown(results,dd,query){
    if(results.length===0){dd.classList.remove('show');return;}
    dd.innerHTML=results.map(function(r){
        var shortName=r.name.length>80?r.name.substring(0,80)+'...':r.name;
        return '<div class="map-dd-item" onclick="mapGoTo('+r.lat+','+r.lng+',\''+escapeHtml(shortName).replace(/'/g,"\\'")+'\')"><span>'+escapeHtml(shortName)+'</span><span class="map-dd-cat">'+escapeHtml(r.cat)+'</span></div>';
    }).join('');
    dd.classList.add('show');
}

async function mapSearchGo(){
    var query=document.getElementById('map-search').value.trim();
    if(!query)return;
    document.getElementById('map-dropdown').classList.remove('show');
    try{
        var resp=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(query)+'&countrycodes=us&limit=1',{
            headers:{'Accept':'application/json'}
        });
        var data=await resp.json();
        if(data.length){
            mapGoTo(parseFloat(data[0].lat),parseFloat(data[0].lon),data[0].display_name);
        }else{
            alert('Address not found. Try a more specific address.');
        }
    }catch(e){alert('Search failed. Check your connection.');}
}

function mapGoTo(lat,lng,name){
    document.getElementById('map-dropdown').classList.remove('show');
    document.getElementById('map-search').value=name.length>60?name.substring(0,60)+'...':name;
    if(mapObj){
        mapObj.setView([lat,lng],15);
        L.popup().setLatLng([lat,lng]).setContent('<b>'+escapeHtml(name)+'</b>').openOn(mapObj);
    }
}

async function mapLoadSaved(){
    try{
        var{data}=await sb.from('cockpit_map_locations').select('*').order('pinned',{ascending:false}).order('created_at',{ascending:false});
        if(data)mapSavedLocations=data;
    }catch(e){
        // Offline fallback
        var cached=localStorage.getItem('cockpit_map_cache');
        if(cached)mapSavedLocations=JSON.parse(cached);
    }
    // Cache for offline
    localStorage.setItem('cockpit_map_cache',JSON.stringify(mapSavedLocations));
    mapRenderMarkers();
    mapRenderList();
}

var MAP_ICONS={};
function mapGetIcon(category){
    if(MAP_ICONS[category])return MAP_ICONS[category];
    var iconMap={
        'Job Sites':{emoji:'🏠',color:'#FF6A00'},
        'Customers':{emoji:'👤',color:'#5599ff'},
        'Warehouses':{emoji:'📦',color:'#888'},
        'Storage':{emoji:'🏪',color:'#a050dc'},
        'Landmarks':{emoji:'📍',color:'#32CD32'},
        'General':{emoji:'📌',color:'#FF6A00'}
    };
    var cfg=iconMap[category]||iconMap['General'];
    MAP_ICONS[category]=L.divIcon({
        className:'',
        html:'<div style="font-size:1.5rem;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.4));text-align:center;line-height:1;">'+cfg.emoji+'</div>',
        iconSize:[28,28],
        iconAnchor:[14,28],
        popupAnchor:[0,-28]
    });
    return MAP_ICONS[category];
}

function mapRenderMarkers(){
    mapMarkers.forEach(function(m){mapObj.removeLayer(m);});
    mapMarkers=[];
    var filtered=mapCurrentFilter==='All'?mapSavedLocations:mapSavedLocations.filter(function(l){return l.category===mapCurrentFilter;});
    filtered.forEach(function(loc){
        var m=L.marker([loc.lat,loc.lng],{icon:mapGetIcon(loc.category)}).addTo(mapObj);
        m.bindPopup('<b>'+escapeHtml(loc.name)+'</b>'+(loc.address?'<br>'+escapeHtml(loc.address):'')+(loc.notes?'<br><em>'+escapeHtml(loc.notes)+'</em>':'')+'<br><span style="font-size:0.7rem;color:#888;">'+escapeHtml(loc.category)+'</span>');
        mapMarkers.push(m);
    });
}

function mapRenderList(){
    var list=document.getElementById('map-saved-list');
    var filtered=mapCurrentFilter==='All'?mapSavedLocations:mapSavedLocations.filter(function(l){return l.category===mapCurrentFilter;});
    document.getElementById('map-count').textContent=filtered.length+' location'+(filtered.length!==1?'s':'');
    if(filtered.length===0){list.innerHTML='<div style="text-align:center;padding:1rem;font-size:0.78rem;color:var(--clarity-dim);">No saved locations. Click the map to save one.</div>';return;}
    list.innerHTML=filtered.map(function(loc){
        return '<div class="map-saved-item"><span class="map-saved-name" onclick="mapGoTo('+loc.lat+','+loc.lng+',\''+escapeHtml(loc.name).replace(/'/g,"\\'")+'\')">'+(loc.pinned?'📌 ':'')+escapeHtml(loc.name)+'</span><span class="map-saved-cat">'+escapeHtml(loc.category)+'</span><button class="map-saved-del" onclick="mapDelete('+loc.id+')" title="Delete">✕</button></div>';
    }).join('');
}

function mapFilter(cat){
    mapCurrentFilter=cat;
    document.querySelectorAll('.map-filter-btn').forEach(function(b){b.classList.toggle('active',b.textContent===cat);});
    mapRenderMarkers();
    mapRenderList();
}

function mapCloseModal(){document.getElementById('map-modal').classList.remove('show');}

async function mapSaveLocation(){
    var name=document.getElementById('map-save-name').value.trim();
    if(!name){alert('Please enter a name.');return;}
    var loc={
        name:name,
        address:document.getElementById('map-save-address').value.trim(),
        lat:parseFloat(document.getElementById('map-save-lat').value),
        lng:parseFloat(document.getElementById('map-save-lng').value),
        category:document.getElementById('map-save-cat').value,
        notes:document.getElementById('map-save-notes').value.trim()
    };
    await sb.from('cockpit_map_locations').insert([loc]);
    mapCloseModal();
    mapLoadSaved();
}

async function mapDelete(id){
    if(!confirm('Delete this location?'))return;
    await sb.from('cockpit_map_locations').delete().eq('id',id);
    mapLoadSaved();
}

// Close map dropdown on outside click
document.addEventListener('click',function(e){
    if(!e.target.closest('#map-widget')){
        document.getElementById('map-dropdown').classList.remove('show');
    }
});

// Init map after DOM load
setTimeout(function(){if(document.getElementById('map-container'))mapInit();},500);

// =============================================
// STICKY BOTTOM BAR — Mini Player + Search
// =============================================
var barSettingsOpen=false;

function barSpotifyUpdate(){
    // SDK state
    if(spCurrentState){
        var track=spCurrentState.track_window.current_track;
        document.getElementById('bar-track').textContent=track.name+' — '+track.artists.map(function(a){return a.name;}).join(', ');
        document.getElementById('bar-play-btn').textContent=spCurrentState.paused?'▶':'⏸';
        var artEl=document.getElementById('bar-art');
        if(track.album.images&&track.album.images.length){
            artEl.src=track.album.images[track.album.images.length>1?1:0].url;
            artEl.style.display='block';
        }
        return;
    }
    // Remote state (from polling)
    var trackEl=document.getElementById('sp-track');
    var artistEl=document.getElementById('sp-artist');
    if(trackEl&&trackEl.textContent&&trackEl.textContent!=='—'){
        var artSrc=document.getElementById('sp-art');
        document.getElementById('bar-track').textContent=trackEl.textContent+(artistEl?' — '+artistEl.textContent:'');
        document.getElementById('bar-play-btn').textContent=document.getElementById('sp-play-btn').textContent==='⏸'?'⏸':'▶';
        if(artSrc&&artSrc.src&&artSrc.style.display!=='none'){
            document.getElementById('bar-art').src=artSrc.src;
            document.getElementById('bar-art').style.display='block';
        }
    }
}
// Poll bar sync
setInterval(barSpotifyUpdate,2000);

function barSearch(query){
    var panel=document.getElementById('bar-search-results');
    if(!query||query.length<2){panel.classList.remove('show');return;}
    var q=query.toLowerCase();
    var results=[];
    // Search tasks
    document.querySelectorAll('.todo-text').forEach(function(el){
        if(el.textContent.toLowerCase().indexOf(q)!==-1)results.push({name:el.textContent,type:'Task',target:'tasks-widget'});
    });
    // Search contacts
    document.querySelectorAll('#contacts-list .contact-name, #contacts-list .contact-info').forEach(function(el){
        if(el.textContent.toLowerCase().indexOf(q)!==-1)results.push({name:el.textContent,type:'Contact',target:'contacts-widget'});
    });
    // Search memory vault
    document.querySelectorAll('.mem-card-title, .mem-card-body').forEach(function(el){
        if(el.textContent.toLowerCase().indexOf(q)!==-1)results.push({name:el.textContent.substring(0,60),type:'Memory',target:'memory-widget'});
    });
    // Search map locations (local dataset + saved)
    DENVER_LOCATIONS.filter(function(l){return l.name.toLowerCase().indexOf(q)!==-1;}).slice(0,3).forEach(function(l){
        results.push({name:l.name,type:'Map',target:'map-widget',lat:l.lat,lng:l.lng});
    });
    mapSavedLocations.filter(function(l){return l.name.toLowerCase().indexOf(q)!==-1;}).slice(0,3).forEach(function(l){
        results.push({name:l.name,type:'Saved Map',target:'map-widget',lat:l.lat,lng:l.lng});
    });
    // Search bookmarks
    document.querySelectorAll('.bookmark-name').forEach(function(el){
        if(el.textContent.toLowerCase().indexOf(q)!==-1){
            var link=el.closest('.bookmark');
            results.push({name:el.textContent,type:'Bookmark',target:null,href:link?link.href:null});
        }
    });
    results=results.slice(0,8);
    if(results.length===0){panel.innerHTML='<div class="bar-sr-item" style="color:var(--clarity-dim);cursor:default;">No results</div>';panel.classList.add('show');return;}
    panel.innerHTML=results.map(function(r,i){
        if(r.href)return '<div class="bar-sr-item" onclick="window.open(\''+r.href+'\',\'_blank\')"><span>'+escapeHtml(r.name)+'</span><span class="bar-sr-type">'+r.type+'</span></div>';
        if(r.lat)return '<div class="bar-sr-item" onclick="barGoToMap('+r.lat+','+r.lng+',\''+escapeHtml(r.name).replace(/'/g,"\\'")+'\')"><span>'+escapeHtml(r.name)+'</span><span class="bar-sr-type">'+r.type+'</span></div>';
        return '<div class="bar-sr-item" onclick="barScrollTo(\''+r.target+'\')"><span>'+escapeHtml(r.name)+'</span><span class="bar-sr-type">'+r.type+'</span></div>';
    }).join('');
    panel.classList.add('show');
}

function barScrollTo(widgetId){
    document.getElementById('bar-search-results').classList.remove('show');
    document.getElementById('bar-search').value='';
    var el=document.getElementById(widgetId);
    if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
}

function barGoToMap(lat,lng,name){
    document.getElementById('bar-search-results').classList.remove('show');
    document.getElementById('bar-search').value='';
    var el=document.getElementById('map-widget');
    if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
    setTimeout(function(){mapGoTo(lat,lng,name);},500);
}

function barToggleSettings(){
    barSettingsOpen=!barSettingsOpen;
    document.getElementById('bar-settings').classList.toggle('show',barSettingsOpen);
}

function barToggleBg(){
    var btn=document.getElementById('set-bg-toggle');
    btn.classList.toggle('on');
}
function barToggleCompact(){
    var btn=document.getElementById('set-compact-toggle');
    btn.classList.toggle('on');
}
function barToggleSound(){
    var btn=document.getElementById('set-sound-toggle');
    btn.classList.toggle('on');
}

// Close bar panels on outside click
document.addEventListener('click',function(e){
    if(!e.target.closest('#cockpit-bar')&&!e.target.closest('#bar-settings')){
        document.getElementById('bar-search-results').classList.remove('show');
        barSettingsOpen=false;
        document.getElementById('bar-settings').classList.remove('show');
    }
});

// =============================================
// SERVICE WORKER REGISTRATION
// =============================================
if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').then(function(reg){
        console.log('Service worker registered:',reg.scope);
    }).catch(function(err){
        console.log('Service worker registration failed:',err);
    });
}

</script>

<!-- STICKY BOTTOM BAR -->
<div id="cockpit-bar">
    <div class="bar-section bar-left">
        <button class="bar-btn" onclick="barToggleSettings()" title="Settings">⚙️</button>
    </div>
    <div class="bar-section bar-center">
        <img class="bar-art" id="bar-art" src="" alt="">
        <span class="bar-track" id="bar-track">No track</span>
        <button class="bar-btn" onclick="spPrev()" title="Previous">⏮</button>
        <button class="bar-btn" id="bar-play-btn" onclick="spPlayPause()" title="Play/Pause">▶</button>
        <button class="bar-btn" onclick="spNext()" title="Next">⏭</button>
        <input type="range" class="bar-vol" id="bar-volume" min="0" max="100" value="50" oninput="spSetVolume(this.value)" title="Volume">
    </div>
    <div class="bar-section bar-right">
        <div class="bar-search-wrap">
            <span class="bar-search-icon">🔍</span>
            <input type="text" class="bar-search" id="bar-search" placeholder="Search cockpit..." oninput="barSearch(this.value)" onfocus="barSearch(this.value)">
            <div class="bar-search-results" id="bar-search-results"></div>
        </div>
    </div>
</div>

<!-- Settings Panel -->
<div class="bar-settings-panel" id="bar-settings">
    <h4>Settings</h4>
    <div class="bar-setting-row">
        <span class="bar-setting-label">Background Rotation</span>
        <button class="bar-toggle on" id="set-bg-toggle" onclick="barToggleBg()"></button>
    </div>
    <div class="bar-setting-row">
        <span class="bar-setting-label">Compact Widgets</span>
        <button class="bar-toggle" id="set-compact-toggle" onclick="barToggleCompact()"></button>
    </div>
    <div class="bar-setting-row">
        <span class="bar-setting-label">Sound Effects</span>
        <button class="bar-toggle on" id="set-sound-toggle" onclick="barToggleSound()"></button>
    </div>
</div>

</body>
</html>
